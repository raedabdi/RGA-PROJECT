<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - RGA Fitness Pro</title>
    
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        
        :root {
            --primary-color: #00f2a7;
            --secondary-color: #0A1429;
            --light-navy: #112240;
            --glass-bg: linear-gradient(145deg, rgba(17, 34, 64, 0.7), rgba(17, 34, 64, 0.4));
            --slate: #8892b0;
            --white: #e6f1ff;
            --font-main: 'Tajawal', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; max-width: 100%; }
        body { 
            font-family: var(--font-main); 
            background-color: var(--secondary-color); 
            color: var(--slate); 
            overflow-x: hidden; 
        }

        #stardust-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .dashboard-layout { display: flex; width: 100%; }

        #sidebar { 
            width: 260px; height: 100vh; position: fixed; top: 0; right: 0; 
            background: var(--light-navy); border-left: 1px solid rgba(0, 242, 167, 0.1); 
            padding: 1.5rem; transition: 0.4s; z-index: 1000; 
        }
        #sidebar.collapsed { transform: translateX(100%); }
        
        .main-content { width: 100%; padding: 1.5rem; transition: 0.4s; margin-right: 0; }
        @media (min-width: 768px) { .main-content { margin-right: 260px; width: calc(100% - 260px); } }

        .top-bar { margin-bottom: 2rem; }
        .header-row { display: flex; align-items: center; gap: 15px; }
        .top-bar h1 { color: var(--white); font-size: 1.6rem; font-weight: 900; }
        #welcome-user { color: var(--primary-color); font-size: 1rem; margin-top: 5px; opacity: 0.9; }
        
        #menu-toggle { background: none; border: 1px solid var(--slate); color: var(--slate); border-radius: 8px; width: 40px; height: 40px; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }

        .stat-card { background: var(--glass-bg); padding: 1.2rem; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .stat-card h3 { font-size: 0.9rem; color: var(--slate); }
        .stat-card .value { font-size: 1.8rem; font-weight: 900; color: var(--white); margin: 8px 0; }
        
        .progress-bar { background: rgba(0,0,0,0.4); height: 8px; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { background: var(--primary-color); height: 100%; width: 0%; transition: 1.5s; box-shadow: 0 0 10px var(--primary-color); }

        .toast-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--light-navy); color: var(--primary-color);
            padding: 12px 25px; border-radius: 30px; border: 1px solid var(--primary-color);
            z-index: 2000; font-weight: bold; animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
    </style>
</head>
<body>
    <canvas id="stardust-canvas"></canvas>
    <div id="toast-container"></div>

    <div class="dashboard-layout">
        <aside id="sidebar" class="collapsed">
            <div style="font-weight:900; font-size:1.8rem; color:white; text-align:center; margin-bottom:2rem;">RGA<span>FIT</span></div>

<nav style="margin-top: 2rem; display: flex; flex-direction: column; gap: 10px;">
    <button id="logout-btn" style="background: rgba(255, 68, 68, 0.1); color: #ff4444; border: 1px solid #ff4444; padding: 10px; border-radius: 8px; cursor: pointer; font-family: var(--font-main); font-weight: bold; width: 100%; margin-top: 20px;">
        ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    </button>
</nav>


        </aside>

        <main class="main-content" id="main-content-area">
            <header class="top-bar">
                <div class="header-row">
                    <button id="menu-toggle">â˜°</button>
                    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                </div>
                <div id="welcome-user">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ..</div>
            </header>

            <section class="stats-grid">
                <div class="stat-card">
                    <h3>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h3>
                    <p class="value" id="user-rank">1</p>
                </div>
                <div class="stat-card">
                    <h3>Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø© (XP)</h3>
                    <p class="value"><span id="user-xp">0</span> / <span id="max-xp">1000</span></p>
                    <div class="progress-bar"><div class="progress-bar-fill" id="xp-fill"></div></div>
                </div>
                <div class="stat-card">
                    <h3>Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                    <p class="value" id="user-streak">ğŸ”¥ 1 ÙŠÙˆÙ…</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDV7SNwgv_K10tX0iJpNYqg8_iJnWprFB4",
            authDomain: "rgalab.firebaseapp.com",
            projectId: "rgalab",
            storageBucket: "rgalab.firebasestorage.app",
            messagingSenderId: "882288745140",
            appId: "1:882288745140:web:3c77b0f83ac4e11d30d5e1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        function getJordanDate() {
            return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Amman"}));
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        function loadQuickData() {
            const saved = localStorage.getItem('currentUser');
            if (saved) renderUI(JSON.parse(saved));
        }

                async function syncUserData(user) {
            try {
                // Ù†Ø£Ø®Ø° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                const oldDoc = await db.collection('users').doc(user.uid).get();
                const oldStreak = oldDoc.data()?.streak || 0;

                // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø¯Ø§Ù„Ø©
                const updateStreakFn = firebase.app().functions('us-central1').httpsCallable('updateStreakOnLogin');
                
                // 2. â­ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù†Ø§Ù‚Øµ: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙØ¹Ù„ÙŠØ§Ù‹ ÙˆØ§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© â­
                const result = await updateStreakFn(); 

                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø­Ø§Ø¨
                const doc = await db.collection('users').doc(user.uid).get();
                const data = doc.data();
                const newStreak = data.streak;

                // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„:
                if (result && result.data && result.data.updated) {
                    if (newStreak > oldStreak) {
                        showToast(`ğŸ”¥ Ø±Ø§Ø¦Ø¹! Ø²Ø§Ø¯ Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¥Ù„Ù‰ ${newStreak} Ø£ÙŠØ§Ù…!`);
                    } else if (newStreak === 1 && oldStreak > 1) {
                        showToast("âš ï¸ Ù„Ù„Ø£Ø³Ù Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø³ØªØ±ÙŠÙƒ! Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ….");
                    }
                }

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                localStorage.setItem('currentUser', JSON.stringify(data));
                renderUI(data);

            } catch (err) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ØªØ±ÙŠÙƒ:", err);
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists) renderUI(doc.data());
            }
        }


        function renderUI(data) {

    const nameToShow = data.firstName || "Ø¨Ø·Ù„"; 
    document.getElementById('welcome-user').innerText = `Ø³Ø¹ÙŠØ¯ Ø¨Ø±Ø¤ÙŠØªÙƒØŒ ÙƒØ§Ø¨ØªÙ† ${nameToShow}`;
    
    document.getElementById('user-rank').innerText = data.rank || 1;
    document.getElementById('user-xp').innerText = data.xp || 0;
    document.getElementById('max-xp').innerText = data.maxXp || 1000;
    document.getElementById('user-streak').innerText = `ğŸ”¥ ${data.streak || 1} ÙŠÙˆÙ…`;
    
    const percent = (data.xp / (data.maxXp || 1000)) * 100;
    document.getElementById('xp-fill').style.width = percent + "%";
}


        auth.onAuthStateChanged(user => {
            if (user) {
                loadQuickData();
                syncUserData(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Toggle Sidebar
        const btn = document.getElementById('menu-toggle');
        const side = document.getElementById('sidebar');
        btn.onclick = (e) => { e.stopPropagation(); side.classList.toggle('collapsed'); };
        document.onclick = () => { if (window.innerWidth <= 768) side.classList.add('collapsed'); };

        // Particles
        const canvas = document.getElementById('stardust-canvas');
        const ctx = canvas.getContext('2d');
        let dots = [];
        function init() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            dots = []; for(let i=0; i<30; i++) dots.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, vx:(Math.random()-0.5)*0.4, vy:(Math.random()-0.5)*0.4});
        }
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "#00f2a7";
            dots.forEach(d => {
                d.x+=d.vx; d.y+=d.vy;
                if(d.x<0 || d.x>canvas.width) d.vx*=-1; if(d.y<0 || d.y>canvas.height) d.vy*=-1;
                ctx.beginPath(); ctx.arc(d.x, d.y, 0.7, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(draw);
        }
        window.onresize = init; init(); draw();


document.getElementById('logout-btn').onclick = async () => {
    try {
        await auth.signOut(); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
        localStorage.removeItem('currentUser'); // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        window.location.href = 'index.html'; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    } catch (err) {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", err);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    }
};



    </script>



</body>
</html>
