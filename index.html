<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RGALAB - Health Pro</title>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<style>
/* Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… ÙˆÙ†Ø³Ø® Ø§Ù„ØµÙˆØ± */
img {
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  user-select: none;
  pointer-events: none; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ù„Ù */
}
#deadlift-char { pointer-events: auto; } /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */

  :root {
    --primary: #4CAF50;
    --bg-image: url('https://wallpaper.forfun.com/fetch/63/63eded45b876ce6d693b91ea2838b59f.jpeg?w=2000&f=webp');
    --card-bg: rgba(255, 255, 255, 0.2);
    --text: white;
    --input-bg: white;
    --input-text: #333;
    --accent: #FFD700; 
    --neon: #4CAF50;
    --menu-bg: rgba(15, 15, 15, 0.65);
    /* Ù‡Ù†Ø§ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */
    --game-bg: url('https://i.ibb.co/LDQjfGBk/IMG-4236.png');
  }

  /* Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„Ù„Ù…Ø³ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø²Ø¹Ø¬ */
  * { touch-action: manipulation; }

  .dark-theme {
    --bg-image: none;
    --bg: #0a0a0a;
    --card-bg: rgba(30, 30, 30, 0.7);
    --input-bg: #1e1e1e;
    --input-text: #eee;
    --text: #ffffff;
    --menu-bg: rgba(10, 10, 10, 0.8);
    background-color: #0a0a0a !important;
  }
  
  .skin-neon { --primary: #00ff41; --accent: #00ff41; --neon: #00ff41; text-shadow: 0 0 5px #00ff41; }
  .skin-gold { --primary: #FFD700; --accent: #FFD700; }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover;
    background-color: #f5f7fa; 
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    transition: background 0.4s ease, background-color 0.4s ease;
    overflow-x: hidden;
  }
  /* --- Ù†Ø¸Ø§Ù… Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙŠØ¯Ù„ÙŠÙØª Ø§Ù„Ù…Ø·ÙˆØ± RGALAB PRO --- */
  #game-modal {
    display: none; position: fixed; z-index: 20000; left: 0; top: 0; 
    width: 100%; height: 100%; 
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,20,0.8)), var(--game-bg) no-repeat center center; 
    background-size: cover; backdrop-filter: blur(15px); 
    align-items: center; justify-content: center; flex-direction: column;
  }

  /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
  .game-stats-bar {
    display: flex; gap: 15px; margin-bottom: 30px;
    background: rgba(255, 255, 255, 0.1); padding: 15px 25px;
    border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .stat-item { text-align: center; min-width: 80px; }
  .stat-label { font-size: 10px; text-transform: uppercase; color: #bbb; display: block; letter-spacing: 1px; }
  .stat-value { font-size: 24px; font-weight: 900; color: #fff; }

  #game-timer-val { color: #ff5252; text-shadow: 0 0 10px rgba(255,82,82,0.5); }
  #session-xp-val { color: #4CAF50; text-shadow: 0 0 10px rgba(76,175,80,0.5); }

  .game-container {
    position: relative; width: 300px; height: 350px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.03); border-radius: 50%;
    border: 2px dashed rgba(255,255,255,0.1);
  }

  .deadlift-img {
    width: 250px; height: auto; transition: transform 0.1s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    filter: drop-shadow(0 0 25px var(--primary));
    cursor: pointer; -webkit-user-drag: none; user-select: none;
  }

  /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹ */
  .shake { animation: heavyShake 0.15s infinite; }
  @keyframes heavyShake {
    0% { transform: translate(2px, 1px) rotate(0deg); }
    50% { transform: translate(-2px, -1px) rotate(-1deg); }
    100% { transform: translate(2px, -1px) rotate(1deg); }
  }

  .xp-pop {
    position: absolute;
    color: #4CAF50;
    font-weight: 900;
    font-size: 35px;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 0 15px rgba(76, 175, 80, 0.8), 0 0 5px white;
    animation: xpRiseAndFade 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
  }

  @keyframes xpRiseAndFade {
    0% { opacity: 0; transform: translateY(0) scale(0.3) rotate(-15deg); }
    30% { opacity: 1; transform: translateY(-50px) scale(1.2) rotate(0deg); }
    100% { opacity: 0; transform: translateY(-120px) scale(1) rotate(15deg); }
  }

  .exit-btn-game {
    margin-top: 40px; padding: 12px 35px; background: rgba(255,82,82,0.1);
    color: #ff5252; border: 1px solid #ff5252; border-radius: 50px;
    font-weight: bold; cursor: pointer; transition: 0.3s;
  }
  .exit-btn-game:hover { background: #ff5252; color: white; }



  #ai-chat-btn {
    position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px;
    background: var(--primary); border-radius: 50%; display: none;
    align-items: center; justify-content: center; font-size: 30px;
    cursor: pointer; z-index: 10001; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    border: 2px solid white; transition: 0.3s;
  }
  #ai-chat-btn:hover { transform: scale(1.1); }

  #ai-window {
    position: fixed; bottom: 90px; left: 20px; width: 320px; height: 450px;
    background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px);
    border-radius: 20px; display: none; flex-direction: column; z-index: 10001;
    border: 1px solid rgba(255,255,255,0.1); overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.5);
  }
  .ai-header { background: var(--primary); padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  #ai-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 14px; }
  .ai-msg { padding: 10px 14px; border-radius: 15px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
  .ai-msg.bot { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
  .ai-msg.user { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 2px; color: white; }
  .ai-input-area { padding: 10px; background: rgba(0,0,0,0.3); display: flex; gap: 5px; }
  .ai-input-area input { flex: 1; background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 10px; outline: none; width: auto; margin: 0; }
  .ai-input-area button { width: auto; background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 0; }

  .menu-icon {
    position: fixed; top: 20px; right: 20px; z-index: 10001;
    cursor: pointer; font-size: 26px; background: rgba(255, 255, 255, 0.2);
    width: 45px; height: 45px; display: none; align-items: center; justify-content: center;
    border-radius: 50%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
  }

  .side-menu {
    position: fixed; top: 0; right: -350px; width: 280px; height: 100vh;
    background: rgba(10, 10, 10, 0.6); 
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    z-index: 10002; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    padding: 20px; display: flex; flex-direction: column; gap: 10px;
    box-shadow: -20px 0 40px rgba(0,0,0,0.7);
    overflow-y: auto; color: white;
    border-left: 1px solid rgba(255,255,255,0.08);
  }

  .side-menu.active { right: 0; }

  /* --- ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¯Ø±Ù† Ù‚Ø²Ø§Ø²ÙŠ Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ --- */
  .menu-profile-section {
    text-align: center; 
    padding: 25px 15px;
    margin-bottom: 20px;
    border-radius: 25px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  }

  .menu-avatar {
    width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    border: 3px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.3s;
    box-shadow: 0 0 25px var(--primary);
    background: #fff;
  }
  .menu-avatar:hover { transform: scale(1.08); filter: brightness(1.15); border-color: var(--primary); }
  
  .menu-username { 
    font-weight: 800; margin-top: 15px; font-size: 20px; display: block; 
    background: linear-gradient(90deg, #fff, #ddd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  
  .user-id-badge {
    background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px;
    font-size: 11px; color: #aaa; margin-top: 5px; display: inline-block;
    cursor: pointer; border: 1px solid rgba(255,255,255,0.05); letter-spacing: 1px;
  }

  .menu-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); z-index: 10000; display: none;
    backdrop-filter: blur(4px);
  }
  .menu-overlay.active { display: block; }

  .menu-item-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px;
    cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05);
  }
  .menu-item-row:hover { background: rgba(255,255,255,0.1); transform: translateX(-5px); border-color: rgba(255,255,255,0.2); }

  #rank-display {
    font-weight: 800; 
    color: #FFD700; 
    text-transform: uppercase;
    text-shadow: 0px 2px 10px rgba(0, 0, 0, 0.8), 0px 0px 5px rgba(255, 215, 0, 0.5);
    letter-spacing: 1px; font-size: 17px; margin-bottom: 5px;
  }

  #auth-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover; z-index: 20000; display: flex; align-items: center; justify-content: center;
  }
  .auth-card {
    background: var(--card-bg); backdrop-filter: blur(25px); padding: 40px 30px;
    border-radius: 40px; width: 90%; max-width: 400px; border: 1px solid rgba(255,255,255,0.2);
    text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
  }
  .auth-card input {
    width: 100%; padding: 15px; border-radius: 15px; border: none; margin-bottom: 12px;
    font-size: 16px; background: white; color: #333; outline: none; box-sizing: border-box;
  }
  .auth-btn-main {
    width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--primary);
    color: white; font-weight: bold; font-size: 18px; cursor: pointer;
  }
  .auth-link { margin-top: 15px; font-size: 13px; cursor: pointer; text-decoration: underline; display: block; color: white; }
  .auth-lang-switch { position: absolute; top: 20px; right: 20px; }

  .rank-section { text-align: center; margin-bottom: 20px; width: 100%; max-width: 500px; }
  .xp-bar-container { width: 100%; background: rgba(0,0,0,0.3); height: 12px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
  #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #81c784); transition: width 0.5s ease; }
  .streak-badge { background: rgba(255, 87, 34, 0.25); padding: 5px 15px; border-radius: 50px; border: 1px solid #ff5722; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  
  .modal { display: none; position: fixed; z-index: 11000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); align-items: center; justify-content: center; }
  .modal-content { background: rgba(25, 25, 25, 0.95); padding: 30px; border-radius: 35px; width: 85%; max-width: 380px; color: white; border: 1px solid rgba(255,255,255,0.2); text-align: center; }
  .agree-btn { background: #ffffff; color: #121212; padding: 15px 40px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; margin-top: 25px; width: 100%; font-size: 16px; }
  
  .logo-container { margin-top: 80px; margin-bottom: 10px; text-align: center; }
  .logo-container img { max-width: 120px; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4)); }
  
  .container { width: 100%; max-width: 500px; background: var(--card-bg); backdrop-filter: blur(20px); padding: 30px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
  input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none; font-size: 16px; box-sizing: border-box; }
  input, select { background: var(--input-bg); color: var(--input-text); }
  button.calc-btn { background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
  
  #days-list { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; }
  .day-chip { padding: 6px 12px; border-radius: 10px; font-size: 11px; white-space: nowrap; background: rgba(0,0,0,0.25); color: white; border: 1px solid rgba(255,255,255,0.05); }
  .day-chip.active { background: var(--primary); font-weight: bold; box-shadow: 0 0 10px var(--primary); }

  .mission-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.15); padding: 12px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); }
  .mission-item.done { background: var(--primary); opacity: 0.95; transform: scale(0.98); }
  
  .section-title { margin-top: 25px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }
  .grid-results { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
  .res-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
  .res-box b { font-size: 20px; display: block; margin: 5px 0; }
  
  .footer-info { margin-top: 35px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center; width: 100%; direction: ltr !important; }
  .privacy-link { font-size: 12px; opacity: 0.8; cursor: pointer; display: block; margin-bottom: 15px; color: white; text-decoration: underline; }
  .footer-info a { color: var(--primary); text-decoration: none; font-weight: 600; }
  .ar-mode { direction: rtl; }
  .en-mode { direction: ltr; }
  .hidden { display: none !important; }
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #888; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background: var(--primary); }
  input:checked + .slider:before { transform: translateX(16px); }

  #lb-modal { display: none; position: fixed; z-index: 15000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items:center; justify-content:center; }
  .lb-card { background: #1a1a1a; width: 90%; max-width: 400px; border-radius: 30px; padding: 25px; max-height: 80vh; overflow-y: auto; color: white; border: 1px solid rgba(255,255,255,0.1); }
  .lb-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
  
  .lb-pic { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid var(--primary); background: #fff; }
  .lb-user { display: flex; align-items: center; }

  .shop-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
  .shop-item button { width: auto; padding: 8px 15px; font-size: 12px; margin: 0; background: var(--primary); color: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
  .shop-item button:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }
  .shop-item button.active { background: #ff5722; }

.combo-pop {
  position: absolute;
  color: #FFD700;
  font-weight: 900;
  font-size: 45px;
  pointer-events: none;
  z-index: 200;
  text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 5px #000;
  animation: comboBounce 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.49) forwards;
}

@keyframes comboBounce {
  0% { opacity: 0; transform: scale(0.3) translateY(0); }
  50% { opacity: 1; transform: scale(1.3) translateY(-20px); }
  100% { opacity: 0; transform: scale(1) translateY(-60px); }
}

/* --- Ø¬Ø¯ÙŠØ¯: Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ --- */
#notif-icon {
    position: fixed; top: 20px; left: 20px; z-index: 10001;
    cursor: pointer; font-size: 24px; background: rgba(255,255,255,0.2);
    width: 45px; height: 45px; display: none; align-items: center; justify-content: center;
    border-radius: 50%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
}
#notif-badge {
    position: absolute; top: 0; right: 0; background: #ff5252; color: white;
    font-size: 10px; font-weight: bold; border-radius: 50%; padding: 3px 6px;
    display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}
#notif-dropdown {
    position: fixed; top: 75px; left: 20px; width: 300px; max-height: 400px;
    background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px);
    border-radius: 15px; display: none; flex-direction: column; z-index: 10002;
    border: 1px solid rgba(255,255,255,0.1); overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.notif-item {
    padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 13px; display: flex; flex-direction: column; gap: 5px;
}
.notif-actions { display: flex; gap: 5px; margin-top: 5px; }
.btn-accept { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
.btn-reject { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }

/* Friend List in Menu - Modern Glassy */
.friend-section {
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: 20px; padding-top: 20px;
}
.friend-add-box { 
    display: flex; gap: 8px; margin-bottom: 15px;
    background: rgba(255,255,255,0.05); padding: 8px;
    border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);
}
.friend-add-box input { 
    padding: 10px; font-size: 13px; border-radius: 10px; background: transparent; 
    border: none; color: white; flex: 1; margin: 0; 
}
.friend-add-box button { 
    width: auto; padding: 0 15px; font-size: 14px; margin: 0; background: var(--primary);
    border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.friend-list-item {
    display: flex; align-items: center; gap: 12px; padding: 12px;
    background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px;
    cursor: pointer; transition: 0.2s; border: 1px solid transparent;
}
.friend-list-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); transform: scale(1.02); }
.f-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }

/* Friend Profile Modal - Ultra Glass */
#friend-modal {
    display: none; position: fixed; z-index: 12000; left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); align-items: center; justify-content: center;
}
.friend-card {
    background: rgba(30, 30, 30, 0.6); 
    backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
    padding: 30px; border-radius: 35px; width: 85%; max-width: 350px;
    text-align: center; position: relative; 
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 25px 60px rgba(0,0,0,0.5);
}

/* --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª Ù„ÙŠÙƒÙˆÙ† Ù…ÙˆØ¯Ø±Ù† ÙˆØ¨Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ --- */
.chat-box {
    height: 220px; background: rgba(0,0,0,0.3); margin: 15px 0; border-radius: 20px;
    overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px;
    border: 1px solid rgba(255,255,255,0.1);
}
.chat-msg { 
    padding: 10px 14px; border-radius: 18px; max-width: 75%; 
    font-size: 13px; line-height: 1.4; word-wrap: break-word;
    position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
/* Ø±Ø³Ø§Ø¦Ù„ÙŠ: ÙŠÙ…ÙŠÙ† Ø£Ø®Ø¶Ø± */
.chat-msg.me { 
    background: var(--primary); color: white; align-self: flex-end; 
    border-bottom-right-radius: 4px; text-align: right;
}
/* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±: ÙŠØ³Ø§Ø± Ø±Ù…Ø§Ø¯ÙŠ */
.chat-msg.them { 
    background: rgba(255,255,255,0.15); color: #fff; align-self: flex-start; 
    border-bottom-left-radius: 4px; text-align: left;
}

/* XP Send Input Box */
.xp-sender-box {
    display: flex; gap: 8px; margin-top: 15px; background: rgba(0,0,0,0.2);
    padding: 5px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1);
}
.xp-sender-box input {
    background: transparent; border: none; padding: 10px 15px; color: white;
    text-align: center; width: 80px; font-weight: bold; margin: 0;
}
.xp-sender-box button {
    margin: 0; border-radius: 50px; background: linear-gradient(90deg, #FF9800, #F57C00);
    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
}

.btn-remove-friend {
    background: rgba(255, 82, 82, 0.1);
    color: #ff5252;
    border: 1px solid #ff5252;
    padding: 8px 20px;
    border-radius: 50px;
    font-size: 12px;
    margin-top: 15px;
    cursor: pointer;
    transition: 0.3s;
}
.btn-remove-friend:hover { background: #ff5252; color: white; }

</style>
</head>
<body class="ar-mode">

<div id="notif-icon" onclick="toggleNotifs()">ğŸ””<span id="notif-badge">0</span></div>
<div id="notif-dropdown">
    <div style="padding:10px; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1);" id="notif-header-text">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Notifications</div>
    <div id="notif-list"></div>
</div>

<div id="ai-chat-btn" onclick="toggleAIChat()">ğŸ¤–</div>

<div id="game-modal">
  <div class="game-stats-bar">
    <div class="stat-item">
        <span class="stat-label">TIME</span>
        <span id="game-timer-val" class="stat-value">60s</span>
    </div>
    <div class="stat-item" style="border-left: 1px solid rgba(255,255,255,0.1); padding-left:15px;">
        <span class="stat-label">EARNED XP</span>
        <span id="session-xp-val" class="stat-value">0</span>
    </div>
    <div class="stat-item" style="border-left: 1px solid rgba(255,255,255,0.1); padding-left:15px;">
        <span class="stat-label">BEST COMBO</span>
        <span id="best-combo-val" class="stat-value">0</span>
    </div>
</div>


    <div class="game-container" id="shake-target">
        <img id="deadlift-char" class="deadlift-img" 
             src="" 
             onmousedown="handleInteraction(event, 'start')" 
             onmouseup="handleInteraction(event, 'end')" 
             ontouchstart="handleInteraction(event, 'start')" 
             ontouchend="handleInteraction(event, 'end')">
    </div>

    <button class="exit-btn-game" onclick="closeGame()">EXIT SESSION</button>
</div>


<div id="ai-window">
    <div class="ai-header">
        <span id="ai-title">Ù…Ø¯Ø±Ø¨ RGALAB Ø§Ù„Ø°ÙƒÙŠ</span>
        <span style="cursor:pointer; font-size: 20px;" onclick="toggleAIChat()">Ã—</span>
    </div>
    <div id="ai-messages"></div>
    <div class="ai-input-area">
        <input type="text" id="ai-userInput" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡..." onkeypress="if(event.key==='Enter') askGroq()">
        <button onclick="askGroq()" id="ai-send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<div class="menu-icon" id="menuBtn" onclick="toggleMenu()">â˜°</div>
<div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

<div class="side-menu" id="sideMenu">
    <div class="menu-profile-section">
        <img id="menu-user-avatar" class="menu-avatar" src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" onclick="triggerPhotoUpload()">
        <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="uploadPhoto(this)">
        <span id="menu-user-name" class="menu-username">User Name</span>
        <div id="menu-user-id" class="user-id-badge" onclick="copyMyId()">ID: ...</div>
        <br>
        <button id="btn-edit-name" onclick="changeName()" style="background:none; color:#FFD700; font-size:12px; padding:0; margin-top:8px; text-decoration:none; width:auto; border:1px solid rgba(255,215,0,0.3); border-radius:15px; cursor:pointer; padding: 4px 10px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>

    <div class="menu-item-row" onclick="closeMenuAndOpen(openGame)" style="background: rgba(76, 175, 80, 0.2); border: 1px solid var(--primary);">
        <span id="mi-game">Deadlift Game ğŸ‹ï¸â€â™‚ï¸</span>
        <span style="font-size: 10px; background: red; padding: 2px 5px; border-radius: 50px;">XP+</span>
    </div>

    <div class="menu-item-row" onclick="closeMenuAndOpen(openLeaderboard)">
        <span id="mi-lb">Leaderboard ğŸ†</span>
    </div>
    <div class="menu-item-row" onclick="closeMenuAndOpen(openShop)">
        <span id="mi-shop">Lab Store ğŸ›’</span>
    </div>
    <div class="menu-item-row">
        <span id="mi-dark">Dark Mode ğŸŒ™</span>
        <label class="switch"><input type="checkbox" id="themeToggle" onchange="toggleTheme()"><span class="slider"></span></label>
    </div>
    <div class="menu-item-row">
        <span id="mi-lang">Language ğŸŒ</span>
        <label class="switch"><input type="checkbox" id="langToggle" checked onchange="toggleLanguage()"><span class="slider"></span></label>
    </div>

    <div class="friend-section">
        <div id="mi-friends" style="font-size:14px; font-weight:800; margin-bottom:12px; opacity:0.8;">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Friends ğŸ‘¥</div>
        <div class="friend-add-box">
            <input type="text" id="friend-id-input" placeholder="ID Ø§Ù„ØµØ¯ÙŠÙ‚">
            <button onclick="sendFriendRequest()">+</button>
        </div>
        <div id="friend-list-container">
            <small style="opacity:0.5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</small>
        </div>
    </div>

    <div class="menu-item-row" onclick="logout()" style="margin-top: 10px; border: 1px solid rgba(255, 87, 34, 0.3);">
        <span id="mi-logout" style="color: #ff5722; font-weight: bold;">Logout ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
        <span>ğŸšª</span>
    </div>
</div>

<div id="friend-modal">
    <div class="friend-card">
        <span style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:24px; opacity:0.7;" onclick="document.getElementById('friend-modal').style.display='none'">Ã—</span>
        <img id="f-modal-img" src="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); box-shadow: 0 0 15px var(--primary);">
        <h3 id="f-modal-name" style="margin:12px 0; font-size: 22px;">Name</h3>
        <div style="color:#FFD700; font-weight:bold; font-size:14px; text-shadow: 0 0 10px rgba(255,215,0,0.5);">ğŸ”¥ Streak: <span id="f-modal-streak">0</span></div>
        
        <div class="xp-sender-box">
            <input type="number" id="xp-amount-input" placeholder="0" min="1">
            <button id="btn-send-xp" onclick="sendXPToFriend()">Send XP ğŸ</button>
        </div>

        <div class="chat-box" id="f-chat-box"></div>
        <div style="display:flex; gap:5px; background: rgba(0,0,0,0.2); padding:5px; border-radius:50px; border:1px solid rgba(255,255,255,0.1);">
            <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="font-size:13px; padding:10px; background:transparent; border:none; margin:0; flex:1;">
            <button onclick="sendChatMessage()" style="width:auto; padding:0 18px; border-radius:50px; margin:0;">â¤</button>
        </div>

        <button id="btn-remove-f" class="btn-remove-friend" onclick="removeFriend()">Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚ Delete</button>
    </div>
</div>

<div id="shop-modal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-top: 0;" id="shop-title">ğŸ›’ Lab Store</h3>
    <div style="background:var(--primary); padding:10px; border-radius:10px; margin-bottom:15px; font-weight:bold;">XP: <span id="shop-xp-val">0</span></div>
    
    <div class="shop-item">
        <span id="shop-i1">Neon Skin âœ¨<br><small>1000 XP</small></span>
        <button onclick="buyItem('neon', 1000)" id="btn-neon">Unlock</button>
    </div>
    <div class="shop-item">
        <span id="shop-i2">Gold Skin ğŸ‘‘<br><small>2000 XP</small></span>
        <button onclick="buyItem('gold', 2000)" id="btn-gold">Unlock</button>
    </div>
    <div class="shop-item" style="background: rgba(76, 175, 80, 0.1);">
        <span id="shop-i3">Your Custom Diet Plan ğŸ¥—<br><small>3000 XP</small></span>
        <button onclick="buyItem('diet', 3000)" id="btn-diet">Get</button>
    </div>
    <div class="shop-item">
        <span id="shop-i4">Pro PDF Guide ğŸ“š<br><small>500 XP</small></span>
        <button onclick="buyItem('pdf', 500)" id="btn-pdf">Get</button>
    </div>

    <button onclick="closeShop()" id="shop-close" style="background:rgba(255,255,255,0.1); color:white; margin-top:10px; border: 1px solid white;">Close</button>
  </div>
</div>

<div id="lb-modal" onclick="closeLeaderboard()">
  <div class="lb-card" onclick="event.stopPropagation()">
    <h2 style="text-align:center; margin-bottom:20px;" id="lb-title-text">ğŸ† Leaderboard</h2>
    <div id="lb-list">Loading...</div>
    <button onclick="closeLeaderboard()" id="lb-close-btn" style="background:var(--primary); color:white; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚ Close</button>
  </div>
</div>

<div id="auth-overlay">
  <div class="switch-container auth-lang-switch" style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:50px;">
    <span style="font-size: 10px; color:white;">EN</span>
    <label class="switch"><input type="checkbox" id="authLangToggle" checked onchange="syncLanguage(this)"><span class="slider"></span></label>
    <span style="font-size: 10px; color:white;">AR</span>
  </div>
  <div class="auth-card">
    <img src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" style="width:80px; margin-bottom:15px;">
    <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div id="signup-fields" class="hidden">
      <input type="text" id="auth-fname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
      <input type="text" id="auth-lname" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
    </div>
    <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="auth-btn-main" onclick="handleAuth()" id="auth-btn">Ø¯Ø®ÙˆÙ„</button>
    <span class="auth-link" onclick="toggleAuthMode()" id="auth-toggle-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</span>
    <span class="auth-link" style="color:#FFD700;" onclick="forgotPassword()" id="auth-forgot">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</span>
  </div>
</div>

<div id="privacyModal" class="modal">
  <div class="modal-content">
    <div style="font-size:50px; margin-bottom:20px;">ğŸ§ª</div>
    <h2 id="modal-title">RGALAB PRO</h2>
    <p id="modal-text"></p>
    <button class="agree-btn" id="modal-btn" onclick="acceptPrivacy()"></button>
  </div>
</div>

<div class="logo-container">
  <img src="https://i.ibb.co/SXkYZMWn/cropped-circle-image-3.png" alt="RGALAB Logo">
  <div class="rank-section">
    <div id="rank-display">RANK: RECRUIT</div>
    <div class="xp-bar-container"><div id="xp-fill"></div></div>
    <div class="streak-badge">ğŸ”¥ <span id="streak-num">0</span> <span id="lbl-streak-txt">DAYS STREAK</span></div>
  </div>
</div>

<div class="container">
  <div id="missionArea">
    <h3 id="lbl-missions" style="margin-top:0;">ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="days-list"></div>
    <div class="mission-item" onclick="doMission(this, 50)">
        <span id="m1">ğŸ‹ï¸ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</span> <b>+50 XP</b>
    </div>
    <div class="mission-item" onclick="doMission(this, 30)">
        <span id="m2">ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©</span> <b>+30 XP</b>
    </div>
  </div>

  <div style="display: flex; gap: 10px;">
    <input type="number" id="weight" placeholder="Ø§Ù„ÙˆØ²Ù†">
    <input type="number" id="height" placeholder="Ø§Ù„Ø·ÙˆÙ„">
  </div>
  <input type="number" id="age" placeholder="Ø§Ù„Ø¹Ù…Ø±">

  <select id="gender">
    <option value="male" id="opt-male"></option>
    <option value="female" id="opt-female"></option>
  </select>

  <select id="activity">
    <option value="1.2" id="act1"></option>
    <option value="1.375" id="act2"></option>
    <option value="1.55" id="act3"></option>
    <option value="1.725" id="act4"></option>
  </select>

  <button class="calc-btn" onclick="processAll()" id="calcBtn"></button>

  <div id="resultsArea" class="hidden">
    <div class="extra-card" style="background: rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-top:10px; text-align:center;">
        <div style="margin-bottom:5px; font-size:14px;"><span id="lbl-water-track"></span></div>
        <div id="water-tracker" style="cursor:pointer; font-size:22px; letter-spacing: 3px;">â¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œ</div>
    </div>
    <div class="grid-results">
      <div class="res-box"><small id="lbl-bmi"></small><b id="val-bmi">0</b><div id="status-bmi" style="font-size: 12px; font-weight: bold; color: #ffeb3b;"></div></div>
      <div class="res-box"><small id="lbl-ideal"></small><b id="val-ideal">0</b> <small class="unit-kg"></small></div>
    </div>
    <div class="grid-results"><div class="res-box" style="grid-column: span 2;"><small id="lbl-water"></small><b id="val-water">0</b> <small id="unit-l"></small></div></div>
    <h3 class="section-title" id="lbl-sec-cal"></h3>
    <div class="grid-results">
      <div class="res-box" style="grid-column: span 2; background: rgba(76, 175, 80, 0.2);"><small id="lbl-maintain"></small><b id="res-maintain">0</b></div>
      <div class="res-box"><small id="lbl-lose"></small><b id="res-lose">0</b></div>
      <div class="res-box"><small id="lbl-gain"></small><b id="res-gain">0</b></div>
    </div>
    <button onclick="shareStreak()" style="background: #FF5722; color: white; margin-top:20px;" id="btn-streak-share"></button>
    <button onclick="shareResults()" style="background: rgba(255,255,255,0.1); border: 1px solid white; cursor: pointer;" id="btn-share"></button>
    <p style="font-size: 10px; opacity: 0.5;">ID: <span id="myIdDisplay">---</span></p>
  </div>

  <div class="footer-info">
    <span class="privacy-link" onclick="showPrivacy()">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© | Privacy Policy</span>
    <div class="contact-item"><span>âœ‰ï¸</span> <a href="mailto:RGA@RGA.BEST">RGA@RGA.BEST</a></div>
    <div class="contact-item">ğŸ“¸ Dev: <a href="https://instagram.com/therealraed" target="_blank">therealraed</a></div>
  </div>
</div>

<script>
  // --- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¨Ø© (Ø¹Ø¯Ù„ Ù‡Ù†Ø§ ÙÙ‚Ø·) ---
  const LIFT_IMG_DOWN = "https://i.ibb.co/zW74jkmK/IMG-4239.png"; 
  const LIFT_IMG_UP = "https://i.ibb.co/zVkNkjfZ/IMG-4238.png";     
  // ----------------------------------------

  const firebaseConfig = { apiKey: "FIREBASE_API_KEY_PLACEHOLDE", authDomain: "rgalab.firebaseapp.com", projectId: "rgalab", storageBucket: "rgalab.firebasestorage.app", messagingSenderId: "882288745140", appId: "1:882288745140:web:3c77b0f83ac4e11d30d5e1" };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const GROQ_KEY = "GQ_AB";
  let chatHistory = [];
  let lang = 'ar';
  let authMode = 'login';
  const DEFAULT_AVATAR = "https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png";
  let xp = parseInt(localStorage.getItem('rga_xp')) || 0;
  let streak = parseInt(localStorage.getItem('rga_streak')) || 0;
  let ownedItems = JSON.parse(localStorage.getItem('rga_owned')) || [];
  let userAvatarUrl = localStorage.getItem('rga_avatar') || DEFAULT_AVATAR;

  let myShortId = "";
  let currentFriendId = null;
  let chatUnsubscribe = null; // Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ø´Ø§Øª

  const trans = {
    ar: {
      authLogin: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", authSignup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", authBtnL: "Ø¯Ø®ÙˆÙ„", authBtnS: "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨",
      authLinkS: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†", authLinkL: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„", forgot: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ", emailPl: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", passPl: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
      fnamePl: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", lnamePl: "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", verifyMsg: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø¨Ø±ÙŠØ¯Ùƒ!", weight: "Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", height: "Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", age: "Ø§Ù„Ø¹Ù…Ø±", male: "Ø°ÙƒØ±", female: "Ø£Ù†Ø«Ù‰", calc: "ØªØ­Ù„ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      bmi: "Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…", water: "Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙƒÙ„ÙŠ", waterTrack: "ğŸ’§ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ:", l: "Ù„ØªØ±", kg: "ÙƒØº", ideal: "Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",
      maintain: "Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ²Ù†", lose: "ØªÙ†Ø´ÙŠÙ (0.5ÙƒØº)", gain: "ØªØ¶Ø®ÙŠÙ… (0.5ÙƒØº)", 
      act1: "Ø®Ø§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠÙ†)", act2: "Ø®ÙÙŠÙ (1-3 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act3: "Ù…ØªÙˆØ³Ø· (3-5 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act4: "Ø¹Ø§Ù„ÙŠ (6-7 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)",
      status: ["Ù†Ø­Ø§ÙØ©", "ÙˆØ²Ù† Ù…Ø«Ø§Ù„ÙŠ", "ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯", "Ø³Ù…Ù†Ø©"], calText: "Ø³Ø¹Ø±Ø©", secCal: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©", share: "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸš€",
      modalText: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¶Ù…Ø§Ù† Ø®ØµÙˆØµÙŠØªÙƒØŒ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹.", modalBtn: "Ø£ÙˆØ§ÙÙ‚ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø¨Ø¯Ø£", missions: "ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…", m1: "ğŸ‹ï¸ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…", m2: "ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©", ranks: ["Ù…Ø¬Ù†Ø¯", "Ø¹Ø±ÙŠÙ", "Ù…Ù‚Ø§ØªÙ„", "ÙˆØ­Ø´", "Ø£Ø³Ø·ÙˆØ±Ø©"], streakShare: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ”¥", streakTxt: "Ø£ÙŠØ§Ù… Ø§Ù„ØªØ²Ø§Ù…",
      days: ["Ø£Ø­Ø¯", "Ø¥Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"],
      forgotPrompt: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:", forgotSuccess: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.",
      userNotFound: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§.",
      shopTitle: "ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø±", shopClose: "Ø¥ØºÙ„Ø§Ù‚", shopI1: "Ù…Ø¸Ù‡Ø± Ø§Ù„Ù†ÙŠÙˆÙ† âœ¨", shopI2: "Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ‘‘", shopI3: "Ø¬Ø¯ÙˆÙ„ ØºØ°Ø§Ø¦ÙŠ Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ ğŸ¥—", shopI4: "Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Pro ğŸ“š",
      unlock: "ÙØªØ­", get: "Ø§Ø­ØµÙ„", on: "ØªÙØ¹ÙŠÙ„", off: "Ø¥ÙŠÙ‚Ø§Ù", bought: "ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!",
      editName: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", miLb: "Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†", miShop: "Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’", miDark: "Ø§Ù„ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ ğŸŒ™", miLang: "Ø§Ù„Ù„ØºØ© ğŸŒ", logout: "Logout ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", lbTitle: "ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", lbClose: "Ø¥ØºÙ„Ø§Ù‚", nameWait: "ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ ÙƒÙ„ 3 Ø£ÙŠØ§Ù… ÙÙ‚Ø·",
      aiWelcome: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ù…Ø­ØªØ±Ù. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŒ Ø§Ù„ØªØºØ°ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª!", aiInputPl: "Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡...", aiSend: "Ø¥Ø±Ø³Ø§Ù„",
      miFriends: "Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ‘¥", miFriendIdPl: "ID Ø§Ù„ØµØ¯ÙŠÙ‚", miNoFriends: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯", fChatPl: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...", fChatWait: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ", fRemove: "Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚ âŒ", fRemoveConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ",
      notifHeader: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Notifications ğŸ””", notifEmpty: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹", notifFriendReq: "Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ù…Ù†", notifAccept: "Ù‚Ø¨ÙˆÙ„", notifReject: "Ø±ÙØ¶", notifGift: "Ø§Ø³ØªÙ„Ù…Øª Ù‡Ø¯ÙŠØ© XP Ù…Ù†", notifMsg: "Ø±Ø³Ø§Ù„Ø© Ù…Ù†"
    },
    en: {
      authLogin: "Sign In", authSignup: "Sign Up", authBtnL: "Login", authBtnS: "Register",
      authLinkS: "Register Now", authLinkL: "Login", forgot: "Forgot?", emailPl: "Email", passPl: "Password",
      fnamePl: "First Name", lnamePl: "Last Name", verifyMsg: "Verify your email!", weight: "Weight (kg)", height: "Height (cm)", age: "Age", male: "Male", female: "Female", calc: "Process Data",
      bmi: "BMI Index", water: "Water Need", waterTrack: "ğŸ’§ Water Tracker:", l: "L", kg: "kg", ideal: "Ideal Weight",
      maintain: "Maintain", lose: "Lose", gain: "Gain", 
      act1: "Sedentary (No workout)", act2: "Light (1-3 days workout)", act3: "Moderate (3-5 days workout)", act4: "Active (6-7 days workout)",
      status: ["Thin", "Normal", "Overweight", "Obese"], calText: "kcal", secCal: "Calories", share: "Share ğŸš€",
      modalText: "Welcome! Data is processed locally.", modalBtn: "I Agree", missions: "ğŸ¯ Missions", m1: "Workout", m2: "Meal", ranks: ["RECRUIT", "CORPORAL", "WARRIOR", "BEAST", "LEGEND"], streakShare: "Challenge ğŸ”¥", streakTxt: "DAYS STREAK",
      days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
      forgotPrompt: "Enter your email for password reset link:", forgotSuccess: "Reset link sent successfully.",
      userNotFound: "Sorry, this email is not registered.",
      shopTitle: "ğŸ›’ Lab Store", shopClose: "Close", shopI1: "Neon Skin âœ¨", shopI2: "Gold Skin ğŸ‘‘", shopI3: "Your Custom Diet Plan ğŸ¥—", shopI4: "Pro Training PDF ğŸ“š",
      unlock: "Unlock", get: "Get", on: "ON", off: "OFF", bought: "Unlocked Successfully!",
      editName: "Edit Name", miLb: "Leaderboard ğŸ†", miShop: "Lab Store ğŸ›’", miDark: "Dark Mode ğŸŒ™", miLang: "Language ğŸŒ", logout: "Logout", lbTitle: "ğŸ† Leaderboard", lbClose: "Close", nameWait: "You can change name every 3 days",
      aiWelcome: "Hello! I am your pro coach. Ask me about training, nutrition, or supplements!", aiInputPl: "Ask me anything...", aiSend: "Send",
      miFriends: "Friends ğŸ‘¥", miFriendIdPl: "Friend's ID", miNoFriends: "No friends yet", fChatPl: "Type a message...", fChatWait: "Start chatting with your friend", fRemove: "Remove Friend âŒ", fRemoveConfirm: "Are you sure you want to remove this friend?",
      notifHeader: "Notifications ğŸ””", notifEmpty: "No notifications yet", notifFriendReq: "Friend request from", notifAccept: "Accept", notifReject: "Reject", notifGift: "Received XP gift from", notifMsg: "Message from"
    }
  };

  let gameInterval;
  let timeLeft = 60;
  let isGameActive = false;
  let sessionXP = 0; 
  let comboCount = 0;
  let comboTimer;
  let globalBestCombo = 0; 
  let lastInteractionTime = 0; 

  function handleInteraction(e, type) {
      e.preventDefault();
      const now = Date.now();
      if (type === 'start') {
          if (now - lastInteractionTime < 50) return;
          lastInteractionTime = now;
          liftStart();
      } else {
          liftEnd();
      }
  }

  function openGame() {
    const lastPlayed = localStorage.getItem('rga_game_last_time') || 0;
    const now = Date.now();
    const cooldown = 1; 

    if (now - lastPlayed < cooldown) {
        const remaining = Math.ceil((cooldown - (now - lastPlayed)) / 60000);
        alert(lang === 'ar' ? `Ø¹Ø¶Ù„Ø§ØªÙƒ ØªØ­ØªØ§Ø¬ Ø±Ø§Ø­Ø©! Ø§Ù†ØªØ¸Ø± ${remaining} Ø¯Ù‚ÙŠÙ‚Ø©.` : `Need rest! Wait ${remaining} mins.`);
        return;
    }

    comboCount = 0;
    document.getElementById('best-combo-val').innerText = globalBestCombo;
    sessionXP = 0;
    document.getElementById('session-xp-val').innerText = "0";
    document.getElementById('deadlift-char').src = LIFT_IMG_DOWN;
    document.getElementById('game-modal').style.display = 'flex';
    startTimer();
  }

  function startTimer() {
    timeLeft = 60;
    isGameActive = true;
    document.getElementById('game-timer-val').innerText = `${timeLeft}s`;
    
    gameInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('game-timer-val').innerText = `${timeLeft}s`;
        if (timeLeft <= 0) {
            finishGame(true); 
        }
    }, 1000);
  }

  function closeGame() {
    const confirmMsg = lang === 'ar' ? "Ø¥Ø°Ø§ Ø®Ø±Ø¬Øª Ø§Ù„Ø¢Ù†ØŒ Ø³ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆÙ„Ù† ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ù„Ø¹Ø¨ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ" : "If you exit now, the session ends and you wait 1 hour. Confirm?";
    if (confirm(confirmMsg)) { finishGame(false); }
  }

  function finishGame(isTimeUp) {
    clearInterval(gameInterval);
    isGameActive = false;
    localStorage.setItem('rga_game_last_time', Date.now());
    const msg = lang === 'ar' ? `Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„! Ù„Ù‚Ø¯ Ø¬Ù…Ø¹Øª ${sessionXP} XP ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©.` : `Great job! You earned ${sessionXP} XP this session.`;
    alert(msg);
    document.getElementById('game-modal').style.display = 'none';
    syncWithDB();
  }

  function liftStart() {
    if (!isGameActive) return;
    const char = document.getElementById('deadlift-char');
    const container = document.getElementById('shake-target');
    char.src = LIFT_IMG_UP;
    char.style.transform = "translateY(-20px) scale(1.05)";
    container.classList.add('shake');
    comboCount++;
    clearTimeout(comboTimer);
    if (comboCount > globalBestCombo) {
        globalBestCombo = comboCount;
        document.getElementById('best-combo-val').innerText = globalBestCombo;
        const user = auth.currentUser;
        if (user) { db.collection("ranks").doc(user.uid).update({ bestCombo: globalBestCombo }); }
    }
    if (comboCount > 1) {
        const comboEl = document.createElement('div');
        comboEl.className = 'combo-pop';
        comboEl.innerText = comboCount + "x";
        comboEl.style.left = (Math.random() * 40 + 30) + '%'; 
        comboEl.style.top = '10%';
        document.querySelector('.game-container').appendChild(comboEl);
        setTimeout(() => comboEl.remove(), 500);
    }
    comboTimer = setTimeout(() => { comboCount = 0; }, 800);
    sessionXP++;
    addXP(1); 
    document.getElementById('session-xp-val').innerText = sessionXP;
    const pop = document.createElement('div');
    pop.className = 'xp-pop'; pop.innerText = '+1';
    pop.style.left = (Math.random() * 60 + 20) + '%';
    document.querySelector('.game-container').appendChild(pop);
    setTimeout(() => pop.remove(), 500);
  }

  function liftEnd() {
    if (!isGameActive) return;
    const char = document.getElementById('deadlift-char');
    const container = document.getElementById('shake-target');
    if(char) { char.src = LIFT_IMG_DOWN; char.style.transform = "translateY(0) scale(1)"; }
    if(container) container.classList.remove('shake');
  }

  function toggleMenu() { 
      document.getElementById('notif-dropdown').style.display = 'none';
      document.getElementById('sideMenu').classList.toggle('active'); 
      document.getElementById('menuOverlay').classList.toggle('active'); 
  }
  function closeMenuAndOpen(func) { toggleMenu(); setTimeout(func, 300); }
  function toggleAuthMode() { authMode = (authMode === 'login' ? 'signup' : 'login'); document.getElementById('signup-fields').classList.toggle('hidden', authMode === 'login'); updateTexts(); }
  function syncLanguage(el) { document.getElementById('langToggle').checked = el.checked; toggleLanguage(); }
  
  function toggleLanguage() { 
    lang = document.getElementById('langToggle').checked ? 'ar' : 'en'; 
    document.body.className = (lang === 'ar' ? 'ar-mode' : 'en-mode') + (document.body.classList.contains('dark-theme') ? ' dark-theme' : ''); 
    document.getElementById('authLangToggle').checked = (lang === 'ar'); 
    chatHistory = []; 
    const msgArea = document.getElementById('ai-messages');
    if(msgArea) msgArea.innerHTML = `<div class="ai-msg bot">${trans[lang].aiWelcome}</div>`;
    updateTexts(); renderDays(); 
    if(!document.getElementById('resultsArea').classList.contains('hidden')) processAll(); 
  }
  
  function updateTexts() {
    const t = trans[lang];
    if(!t) return;
    document.getElementById('auth-title').innerText = (authMode === 'login' ? t.authLogin : t.authSignup);
    document.getElementById('auth-btn').innerText = (authMode === 'login' ? t.authBtnL : t.authBtnS);
    document.getElementById('auth-toggle-text').innerText = (authMode === 'login' ? t.authLinkS : t.authLinkL);
    document.getElementById('auth-forgot').innerText = t.forgot;
    document.getElementById('auth-email').placeholder = t.emailPl; document.getElementById('auth-pass').placeholder = t.passPl;
    document.getElementById('auth-fname').placeholder = t.fnamePl; document.getElementById('auth-lname').placeholder = t.lnamePl;
    document.getElementById('weight').placeholder = t.weight; document.getElementById('height').placeholder = t.height; document.getElementById('age').placeholder = t.age;
    document.getElementById('opt-male').innerText = t.male; document.getElementById('opt-female').innerText = t.female;
    document.getElementById('act1').innerText = t.act1; document.getElementById('act2').innerText = t.act2;
    document.getElementById('act3').innerText = t.act3; document.getElementById('act4').innerText = t.act4;
    document.getElementById('calcBtn').innerText = t.calc; document.getElementById('lbl-bmi').innerText = t.bmi;
    document.getElementById('lbl-ideal').innerText = t.ideal; document.getElementById('lbl-water').innerText = t.water;
    document.getElementById('lbl-water-track').innerText = t.waterTrack; document.getElementById('unit-l').innerText = t.l;
    document.querySelectorAll('.unit-kg').forEach(el => el.innerText = t.kg);
    document.getElementById('lbl-maintain').innerText = t.maintain; document.getElementById('lbl-lose').innerText = t.lose;
    document.getElementById('lbl-gain').innerText = t.gain; document.getElementById('lbl-sec-cal').innerText = t.secCal;
    document.getElementById('btn-share').innerText = t.share; document.getElementById('lbl-missions').innerText = t.missions;
    document.getElementById('m1').innerText = t.m1; document.getElementById('m2').innerText = t.m2;
    document.getElementById('btn-streak-share').innerText = t.streakShare; document.getElementById('modal-text').innerText = t.modalText;
    document.getElementById('modal-btn').innerText = t.modalBtn; document.getElementById('lbl-streak-txt').innerText = t.streakTxt;
    document.getElementById('btn-edit-name').innerText = t.editName;
    document.getElementById('mi-lb').innerText = t.miLb; document.getElementById('mi-shop').innerText = t.miShop;
    document.getElementById('mi-dark').innerText = t.miDark; document.getElementById('mi-lang').innerText = t.miLang;
    document.getElementById('lb-title-text').innerText = t.lbTitle; document.getElementById('lb-close-btn').innerText = t.lbClose;
    document.getElementById('shop-title').innerText = t.shopTitle; document.getElementById('shop-close').innerText = t.shopClose;
    document.getElementById('shop-i1').innerHTML = t.shopI1; document.getElementById('shop-i2').innerHTML = t.shopI2;
    document.getElementById('shop-i3').innerHTML = t.shopI3; document.getElementById('shop-i4').innerHTML = t.shopI4;
    document.getElementById('ai-title').innerText = (lang === 'ar' ? 'Ù…Ø¯Ø±Ø¨ RGALAB Ø§Ù„Ø°ÙƒÙŠ' : 'RGALAB AI Coach');
    document.getElementById('ai-userInput').placeholder = t.aiInputPl;
    document.getElementById('ai-send-btn').innerText = t.aiSend;
    
    document.getElementById('mi-friends').innerText = t.miFriends;
    document.getElementById('friend-id-input').placeholder = t.miFriendIdPl;
    document.getElementById('notif-header-text').innerText = t.notifHeader;
    document.getElementById('chat-input').placeholder = t.fChatPl;
    document.getElementById('btn-remove-f').innerText = t.fRemove;
    
    updateRank(); updateShopButtons();
  }

  function toggleAIChat() {
    const win = document.getElementById('ai-window');
    win.style.display = (win.style.display === 'flex' ? 'none' : 'flex');
    if(document.getElementById('ai-messages').innerHTML === "") { document.getElementById('ai-messages').innerHTML = `<div class="ai-msg bot">${trans[lang].aiWelcome}</div>`; }
  }

  async function askGroq() {
    const input = document.getElementById('ai-userInput');
    const msgArea = document.getElementById('ai-messages');
    const text = input.value.trim();
    if(!text) return;
    msgArea.innerHTML += `<div class="ai-msg user">${text}</div>`;
    const systemPrompt = lang === 'ar' ? "Ø£Ù†Øª Ù…Ø¯Ø±Ø¨ Ø±ÙŠØ§Ø¶ÙŠ Ø®Ø¨ÙŠØ± ÙÙŠ Ù…Ø®ØªØ¨Ø± RGALAB. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©." : "You are an expert fitness coach at RGALAB.";
    if (chatHistory.length === 0) chatHistory.push({ role: "system", content: systemPrompt });
    chatHistory.push({ role: "user", content: text });
    input.value = ""; msgArea.scrollTop = msgArea.scrollHeight;
    const loadingId = "load-" + Date.now();
    msgArea.innerHTML += `<div class="ai-msg bot" id="${loadingId}">...</div>`;
    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: chatHistory, temperature: 0.7 })
        });
        const data = await response.json();
        const reply = data.choices[0].message.content;
        document.getElementById(loadingId).innerText = reply;
        chatHistory.push({ role: "assistant", content: reply });
        if (chatHistory.length > 15) chatHistory = [chatHistory[0], ...chatHistory.slice(-10)];
    } catch (e) { document.getElementById(loadingId).innerText = "Error."; }
    msgArea.scrollTop = msgArea.scrollHeight;
  }

  function triggerPhotoUpload() { document.getElementById('photoInput').click(); }
  function uploadPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            userAvatarUrl = e.target.result;
            document.getElementById('menu-user-avatar').src = userAvatarUrl;
            localStorage.setItem('rga_avatar', userAvatarUrl);
            syncWithDB();
        }; reader.readAsDataURL(input.files[0]);
    }
  }

  function changeName() {
    const lastChange = localStorage.getItem('rga_name_date') || 0;
    if (Date.now() - lastChange < 259200000) { alert(trans[lang].nameWait); return; }
    const newName = prompt("Enter new name:");
    if (newName) {
        auth.currentUser.updateProfile({ displayName: newName }).then(() => {
            document.getElementById('menu-user-name').innerText = newName;
            localStorage.setItem('rga_name_date', Date.now());
            syncWithDB();
        });
    }
  }

  function renderDays() {
    const container = document.getElementById('days-list');
    const days = trans[lang].days;
    const today = new Date().getDay();
    container.innerHTML = "";
    days.forEach((day, index) => {
        const div = document.createElement('div');
        div.className = `day-chip ${index === today ? 'active' : ''}`;
        div.innerText = day; container.appendChild(div);
    });
  }

  function handleAuth() {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    if(authMode === 'signup') {
        const fn = document.getElementById('auth-fname').value; const ln = document.getElementById('auth-lname').value;
        const fullName = fn + " " + ln;
        auth.createUserWithEmailAndPassword(email, pass).then(u => {
            u.user.updateProfile({ displayName: fullName, photoURL: DEFAULT_AVATAR });
            const generatedId = Math.random().toString(36).substr(2, 6).toUpperCase();
            db.collection("ranks").doc(u.user.uid).set({ name: fullName, xp: 0, avatar: DEFAULT_AVATAR, streak: 0, bestCombo: 0, shortId: generatedId });
            u.user.sendEmailVerification(); alert(trans[lang].verifyMsg); auth.signOut();
        }).catch(e => alert(e.message));
    } else { auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message)); }
  }

  function forgotPassword() { 
    const emailInput = document.getElementById('auth-email').value;
    const email = prompt(trans[lang].forgotPrompt, emailInput);
    if(email) auth.sendPasswordResetEmail(email).then(() => alert(trans[lang].forgotSuccess)).catch(e => alert(e.message));
  }

  function logout() { auth.signOut().then(() => { localStorage.removeItem('rga_avatar'); location.reload(); }); }

  function checkStreak() {
    const today = new Date().toDateString();
    const lastDate = localStorage.getItem('rga_last_date');
    if (lastDate !== today) {
        if (lastDate === new Date(Date.now() - 86400000).toDateString()) streak++;
        else streak = 1;
        localStorage.setItem('rga_streak', streak); 
        localStorage.setItem('rga_last_date', today);
        syncWithDB(); 
    }
    document.getElementById('streak-num').innerText = streak;
  }

  function doMission(el, points) { if(!el.classList.contains('done')) { el.classList.add('done'); addXP(points); } }
  
  function addXP(amount) { 
    xp += amount; 
    localStorage.setItem('rga_xp', xp); 
    updateRank(); 
    const user = auth.currentUser;
    if(user) { db.collection("ranks").doc(user.uid).update({ xp: xp }).catch(() => syncWithDB()); }
  }

  function syncWithDB() {
    const user = auth.currentUser;
    if(user) {
        db.collection("ranks").doc(user.uid).set({ name: user.displayName || "Anonymous", xp: xp, avatar: userAvatarUrl, streak: streak, bestCombo: globalBestCombo, shortId: myShortId }, { merge: true });
        document.getElementById('myIdDisplay').innerText = myShortId || "---";
    }
  }

  function updateRank() {
    const level = Math.floor(xp / 100) + 1;
    const rankIdx = Math.min(Math.floor((level-1)/2), 4);
    const rLabel = (lang === 'ar' ? "Ø§Ù„Ø±ØªØ¨Ø©: " : "RANK: ");
    document.getElementById('rank-display').innerText = rLabel + trans[lang].ranks[rankIdx] + " (LVL " + level + ")";
    document.getElementById('xp-fill').style.width = (xp % 100) + "%";
  }

  function openLeaderboard() {
    document.getElementById('lb-modal').style.display = 'flex';
    const listDiv = document.getElementById('lb-list');
    listDiv.innerHTML = "Loading...";
    db.collection("ranks").orderBy("streak", "desc").limit(100).get().then(snap => {
        listDiv.innerHTML = "";
        let i = 1;
        snap.forEach(doc => {
            const data = doc.data();
            listDiv.innerHTML += `<div class="lb-row"><div class="lb-user"><span style="width:20px;">#${i}</span><img src="${data.avatar || DEFAULT_AVATAR}" class="lb-pic"><span>${data.name}</span></div><span style="color:#ff5722;">ğŸ”¥ ${data.streak || 0}</span></div>`;
            i++;
        });
    });
  }
  function closeLeaderboard() { document.getElementById('lb-modal').style.display = 'none'; }

  function processAll() {
    const w = parseFloat(document.getElementById('weight').value); 
    const h = parseFloat(document.getElementById('height').value);
    const a = parseFloat(document.getElementById('age').value); 
    const g = document.getElementById('gender').value;
    const act = parseFloat(document.getElementById('activity').value);
    if(!w || !h || !a) return;
    const bmi = (w / ((h/100)**2)).toFixed(1);
    document.getElementById('val-bmi').innerText = bmi;
    document.getElementById('status-bmi').innerText = trans[lang].status[bmi < 18.5 ? 0 : bmi < 25 ? 1 : bmi < 30 ? 2 : 3];
    let ideal = g === 'male' ? 50 + 2.3 * ((h/2.54) - 60) : 45.5 + 2.3 * ((h/2.54) - 60);
    document.getElementById('val-ideal').innerText = Math.round(ideal);
    document.getElementById('val-water').innerText = (w * 0.033).toFixed(1);
    let bmr = (10*w) + (6.25*h) - (5*a) + (g === 'male' ? 5 : -161);
    let maint = Math.round(bmr * act);
    document.getElementById('res-maintain').innerText = maint + " " + trans[lang].calText;
    document.getElementById('res-lose').innerText = (maint - 500) + " " + trans[lang].calText;
    document.getElementById('res-gain').innerText = (maint + 500) + " " + trans[lang].calText;
    document.getElementById('resultsArea').classList.remove('hidden');
    syncWithDB();
  }

  function renderWater() {
    let waterCups = localStorage.getItem('rga_water_count') || 0;
    let html = ""; for(let i=1; i<=8; i++) html += (i <= waterCups ? "ğŸŸ¦" : "â¬œ");
    document.getElementById('water-tracker').innerHTML = html;
  }
  document.getElementById('water-tracker').onclick = function() {
    let waterCups = parseInt(localStorage.getItem('rga_water_count') || 0);
    waterCups = waterCups >= 8 ? 0 : waterCups + 1;
    localStorage.setItem('rga_water_count', waterCups); renderWater();
  };

  function shareStreak() { navigator.clipboard.writeText(`Day ${streak} on RGALAB! ğŸ”¥`).then(() => alert("Copied!")); }
  function shareResults() { navigator.clipboard.writeText(`Calories: ${document.getElementById('res-maintain').innerText}`).then(() => alert("Copied!")); }

  function openShop() { 
    document.getElementById('shop-modal').style.display = 'flex';
    document.getElementById('shop-xp-val').innerText = xp;
    updateShopButtons();
  }
  function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }

  function updateShopButtons() {
    const t = trans[lang];
    ['neon', 'gold'].forEach(id => {
        const btn = document.getElementById('btn-'+id);
        if(ownedItems.includes(id)) {
            const isActive = document.body.classList.contains('skin-'+id);
            btn.innerText = isActive ? t.off : t.on; btn.className = isActive ? "active" : "";
        } else {
            btn.innerText = t.unlock; btn.disabled = xp < (id === 'neon' ? 1000 : 2000);
        }
    });
    document.getElementById('btn-diet').innerText = t.get; document.getElementById('btn-diet').disabled = xp < 3000;
    document.getElementById('btn-pdf').innerText = t.get; document.getElementById('btn-pdf').disabled = xp < 500;
  }

  function buyItem(item, cost) {
    if(ownedItems.includes(item)) {
        if(item === 'neon' || item === 'gold') { document.body.classList.toggle('skin-'+item); updateShopButtons(); }
        return;
    }
    if(xp >= cost) {
        xp -= cost; localStorage.setItem('rga_xp', xp);
        if(item === 'neon' || item === 'gold') { ownedItems.push(item); localStorage.setItem('rga_owned', JSON.stringify(ownedItems)); document.body.classList.add('skin-'+item); }
        alert(trans[lang].bought); document.getElementById('shop-xp-val').innerText = xp;
        updateRank(); syncWithDB(); updateShopButtons();
    }
  }

  // --- Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ØªØ¹Ø¯ÙŠÙ„ toggle ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚) ---
  function toggleNotifs() {
      const drop = document.getElementById('notif-dropdown');
      const badge = document.getElementById('notif-badge');
      if(drop.style.display === 'flex') {
          drop.style.display = 'none';
      } else {
          drop.style.display = 'flex';
          // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù†Ù‡ Ø±Ø£Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
          badge.style.display = 'none';
          badge.innerText = '0';
      }
  }

  function copyMyId() { if(myShortId) { navigator.clipboard.writeText(myShortId).then(() => alert("Copied ID: " + myShortId)); } }

  function sendFriendRequest() {
      const targetId = document.getElementById('friend-id-input').value.trim();
      if(!targetId) return;
      if(targetId === myShortId) { alert(lang === 'ar' ? "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ!" : "You can't add yourself!"); return; }

      db.collection("ranks").where("shortId", "==", targetId).limit(1).get().then(snap => {
          if(snap.empty) { alert("Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ­ÙŠØ­ User not found"); } else {
              const targetDoc = snap.docs[0]; const targetUid = targetDoc.id;
              db.collection("users").doc(targetUid).collection("notifications").add({ type: 'friend_request', fromUid: auth.currentUser.uid, fromName: auth.currentUser.displayName, time: firebase.firestore.FieldValue.serverTimestamp() }).then(() => alert(lang === 'ar' ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!" : "Request Sent!"));
          }
      });
  }

  function listenToNotifications() {
      const uid = auth.currentUser.uid;
      db.collection("users").doc(uid).collection("notifications").orderBy("time", "desc").limit(20)
      .onSnapshot(snap => {
          const list = document.getElementById('notif-list'); list.innerHTML = ""; 
          let unread = 0;
          const t = trans[lang];

          if(snap.empty) { 
              list.innerHTML = `<div style='padding:10px; opacity:0.6;'>${t.notifEmpty}</div>`; 
          }
          
          snap.forEach(doc => {
              const n = doc.data(); 
              unread++; 
              const div = document.createElement('div'); div.className = 'notif-item';
              
              if(n.type === 'friend_request') {
                  div.innerHTML = `<div>ğŸ‘¤ ${t.notifFriendReq} <b>${n.fromName}</b></div>
                  <div class="notif-actions">
                      <button class="btn-accept" onclick="acceptFriend('${doc.id}', '${n.fromUid}', '${n.fromName}')">${t.notifAccept}</button>
                      <button class="btn-reject" onclick="deleteNotif('${doc.id}')">${t.notifReject}</button>
                  </div>`;
              } else if (n.type === 'xp_gift') {
                  div.innerHTML = `<div style="color:#4CAF50;">ğŸ ${t.notifGift} <b>${n.amount} XP</b> (${n.fromName})</div>`;
              } else if (n.type === 'msg') {
                  div.innerHTML = `<div>ğŸ’¬ ${t.notifMsg} <b>${n.fromName}</b>: ${n.text}</div>`;
              }
              list.appendChild(div);
          });
          
          const badge = document.getElementById('notif-badge');
          const drop = document.getElementById('notif-dropdown');
          // Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø©
          if(unread > 0 && drop.style.display !== 'flex') { 
              badge.style.display = 'block'; 
              badge.innerText = unread; 
          } else if (unread === 0) {
              badge.style.display = 'none';
          }
      });
  }

  function acceptFriend(notifId, fromUid, fromName) {
      const myUid = auth.currentUser.uid; const myName = auth.currentUser.displayName;
      const batch = db.batch();
      const myFriendRef = db.collection("users").doc(myUid).collection("friends").doc(fromUid);
      batch.set(myFriendRef, { uid: fromUid, name: fromName });
      const otherFriendRef = db.collection("users").doc(fromUid).collection("friends").doc(myUid);
      batch.set(otherFriendRef, { uid: myUid, name: myName });
      const notifRef = db.collection("users").doc(myUid).collection("notifications").doc(notifId);
      batch.delete(notifRef);
      batch.commit().then(() => alert(lang === 'ar' ? "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚!" : "Friend Added!"));
  }

  function deleteNotif(id) { db.collection("users").doc(auth.currentUser.uid).collection("notifications").doc(id).delete(); }

  function listenToFriends() {
      db.collection("users").doc(auth.currentUser.uid).collection("friends").onSnapshot(snap => {
          const div = document.getElementById('friend-list-container'); div.innerHTML = "";
          if(snap.empty) { div.innerHTML = `<small style='opacity:0.5'>${trans[lang].miNoFriends}</small>`; return; }
          snap.forEach(doc => {
              const f = doc.data();
              db.collection("ranks").doc(f.uid).get().then(uSnap => {
                 if(uSnap.exists) {
                     const uData = uSnap.data(); const el = document.createElement('div'); el.className = 'friend-list-item';
                     el.innerHTML = `<img src="${uData.avatar || DEFAULT_AVATAR}" class="f-avatar">
                                     <div><b>${uData.name}</b><br><span style="font-size:10px; color:#FFD700;">ğŸ”¥ ${uData.streak || 0}</span></div>`;
                     el.onclick = () => openFriendModal(f.uid, uData); div.appendChild(el);
                 }
              });
          });
      });
  }

  function openFriendModal(fUid, uData) {
      currentFriendId = fUid;
      document.getElementById('friend-modal').style.display = 'flex';
      document.getElementById('f-modal-name').innerText = uData.name;
      document.getElementById('f-modal-img').src = uData.avatar || DEFAULT_AVATAR;
      document.getElementById('f-modal-streak').innerText = uData.streak || 0;
      document.getElementById('f-chat-box').innerHTML = `<div style="text-align:center; opacity:0.5; margin-top:20px;">${trans[lang].fChatWait}</div>`;
      listenChat(fUid);
  }

  function removeFriend() {
      if(!currentFriendId) return;
      if(confirm(trans[lang].fRemoveConfirm)) {
          const myUid = auth.currentUser.uid;
          const batch = db.batch();
          batch.delete(db.collection("users").doc(myUid).collection("friends").doc(currentFriendId));
          batch.delete(db.collection("users").doc(currentFriendId).collection("friends").doc(myUid));
          batch.commit().then(() => {
              alert(lang === 'ar' ? "ØªÙ… Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚" : "Friend Removed");
              document.getElementById('friend-modal').style.display = 'none';
          });
      }
  }

  function sendXPToFriend() {
      if(!currentFriendId) return;
      const inputVal = document.getElementById('xp-amount-input').value;
      const amount = parseInt(inputVal);
      if(!amount || amount <= 0) { alert(lang === 'ar' ? "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­!" : "Please enter a valid number!"); return; }
      db.collection("ranks").doc(currentFriendId).update({ xp: firebase.firestore.FieldValue.increment(amount) });
      db.collection("users").doc(currentFriendId).collection("notifications").add({ type: 'xp_gift', amount: amount, fromName: auth.currentUser.displayName, time: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { alert(lang === 'ar' ? `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${amount} XP Ø¨Ù†Ø¬Ø§Ø­!` : `Sent ${amount} XP successfully!`); document.getElementById('xp-amount-input').value = ""; });
  }

  function sendChatMessage() {
      const txt = document.getElementById('chat-input').value.trim();
      if(!txt || !currentFriendId) return;
      const myUid = auth.currentUser.uid;
      const chatId = myUid < currentFriendId ? myUid + "_" + currentFriendId : currentFriendId + "_" + myUid;

      db.collection("chats").doc(chatId).collection("messages").add({
          senderId: myUid,
          text: txt,
          time: firebase.firestore.FieldValue.serverTimestamp()
      });

      db.collection("users").doc(currentFriendId).collection("notifications").add({ 
          type: 'msg', 
          text: txt, 
          fromName: auth.currentUser.displayName, 
          time: firebase.firestore.FieldValue.serverTimestamp() 
      });

      document.getElementById('chat-input').value = "";
  }
  
  function listenChat(fUid) {
      if(chatUnsubscribe) chatUnsubscribe();
      const myUid = auth.currentUser.uid;
      const chatId = myUid < fUid ? myUid + "_" + fUid : fUid + "_" + myUid;
      const box = document.getElementById('f-chat-box');

      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
      db.collection("chats").doc(chatId).collection("messages")
          .where("time", "<", oneDayAgo).get().then(snap => {
              snap.forEach(doc => doc.ref.delete());
          });

      chatUnsubscribe = db.collection("chats").doc(chatId).collection("messages")
          .orderBy("time", "asc")
          .onSnapshot(snap => {
              box.innerHTML = "";
              if(snap.empty) { box.innerHTML = `<div style="text-align:center; opacity:0.5; margin-top:20px;">${trans[lang].fChatWait}</div>`; }
              snap.forEach(doc => {
                  const m = doc.data();
                  const cls = m.senderId === myUid ? "me" : "them";
                  box.innerHTML += `<div class="chat-msg ${cls}">${m.text}</div>`;
              });
              box.scrollTop = box.scrollHeight;
          });
  }

  window.onload = function() {
    updateTexts(); renderWater(); renderDays();
    if (localStorage.getItem('rga_privacy_accepted') === 'true') document.getElementById("privacyModal").style.display = "none";
    auth.onAuthStateChanged(user => {
      if(user) { 
          document.getElementById('auth-overlay').classList.add('hidden'); document.getElementById('menuBtn').style.display = "flex";
          document.getElementById('ai-chat-btn').style.display = "flex"; document.getElementById('notif-icon').style.display = "flex"; 
          db.collection("ranks").doc(user.uid).get().then(doc => {
              if(doc.exists) {
                  const data = doc.data(); userAvatarUrl = data.avatar || DEFAULT_AVATAR; xp = data.xp || 0; streak = data.streak || 0;
                  globalBestCombo = data.bestCombo || 0; myShortId = data.shortId;
                  if(!myShortId) { myShortId = Math.random().toString(36).substr(2, 6).toUpperCase(); db.collection("ranks").doc(user.uid).update({ shortId: myShortId }); }
                  document.getElementById('menu-user-id').innerText = "ID: " + myShortId;
                  localStorage.setItem('rga_avatar', userAvatarUrl); localStorage.setItem('rga_xp', xp); localStorage.setItem('rga_streak', streak);
                  document.getElementById('menu-user-avatar').src = userAvatarUrl; document.getElementById('menu-user-name').innerText = user.displayName || "User";
                  document.getElementById('streak-num').innerText = streak; document.getElementById('best-combo-val').innerText = globalBestCombo;
                  document.getElementById('myIdDisplay').innerText = myShortId;
                  updateRank(); checkStreak(); listenToNotifications(); listenToFriends();
              }
          });
      }
      else { document.getElementById('auth-overlay').classList.remove('hidden'); }
    });
  };

  function acceptPrivacy() { localStorage.setItem('rga_privacy_accepted', 'true'); document.getElementById("privacyModal").style.display = "none"; }
  function showPrivacy() { document.getElementById("privacyModal").style.display = "flex"; }
  function toggleTheme() { document.body.classList.toggle('dark-theme'); }
</script>
</body>
</html>
