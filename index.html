<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RGALAB - Health Pro</title>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

<style>
  :root {
    --primary: #4CAF50;
    --bg-image: url('https://wallpaper.forfun.com/fetch/63/63eded45b876ce6d693b91ea2838b59f.jpeg?w=2000&f=webp');
    --card-bg: rgba(255, 255, 255, 0.2);
    --text: white;
    --input-bg: white;
    --input-text: #333;
    --accent: #FFD700; 
    --neon: #4CAF50;
    --menu-bg: rgba(15, 15, 15, 0.65);
  }

  .dark-theme {
    --bg-image: none;
    --bg: #0a0a0a;
    --card-bg: rgba(30, 30, 30, 0.7);
    --input-bg: #1e1e1e;
    --input-text: #eee;
    --text: #ffffff;
    --menu-bg: rgba(10, 10, 10, 0.8);
    background-color: #0a0a0a !important;
  }
  
  .skin-neon { --primary: #00ff41; --accent: #00ff41; --neon: #00ff41; text-shadow: 0 0 5px #00ff41; }
  .skin-gold { --primary: #FFD700; --accent: #FFD700; }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover;
    background-color: #f5f7fa; 
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    transition: background 0.4s ease, background-color 0.4s ease;
    overflow-x: hidden;
  }

  .menu-icon {
    position: fixed; top: 20px; right: 20px; z-index: 10001;
    cursor: pointer; font-size: 26px; background: rgba(255, 255, 255, 0.2);
    width: 45px; height: 45px; display: none; align-items: center; justify-content: center;
    border-radius: 50%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
  }

  .side-menu {
    position: fixed; top: 0; right: -350px; width: 280px; height: 100vh;
    background: var(--menu-bg); 
    backdrop-filter: blur(45px); -webkit-backdrop-filter: blur(45px);
    z-index: 10002; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    padding: 20px; display: flex; flex-direction: column; gap: 10px;
    box-shadow: -20px 0 40px rgba(0,0,0,0.7);
    overflow-y: auto; color: white;
    border-left: 1px solid rgba(255,255,255,0.1);
  }

  .side-menu.active { right: 0; }

  .menu-profile-section {
    text-align: center; padding: 30px 10px 20px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
  }
  .menu-avatar {
    width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--primary); cursor: pointer; transition: 0.3s;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
    background: #fff;
  }
  .menu-avatar:hover { transform: scale(1.08); filter: brightness(1.15); }
  .menu-username { font-weight: bold; margin-top: 10px; font-size: 18px; display: block; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

  .menu-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); z-index: 10000; display: none;
    backdrop-filter: blur(4px);
  }
  .menu-overlay.active { display: block; }

  .menu-item-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px; background: rgba(255,255,255,0.07); border-radius: 15px;
    cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05);
  }
  .menu-item-row:hover { background: rgba(255,255,255,0.15); transform: translateX(-8px); }

  #rank-display {
    font-weight: 800; 
    color: #FFD700; 
    text-transform: uppercase;
    text-shadow: 0px 2px 10px rgba(0, 0, 0, 0.8), 0px 0px 5px rgba(255, 215, 0, 0.5);
    letter-spacing: 1px; font-size: 17px; margin-bottom: 5px;
  }

  #auth-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover; z-index: 20000; display: flex; align-items: center; justify-content: center;
  }
  .auth-card {
    background: var(--card-bg); backdrop-filter: blur(25px); padding: 40px 30px;
    border-radius: 40px; width: 90%; max-width: 400px; border: 1px solid rgba(255,255,255,0.2);
    text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
  }
  .auth-card input {
    width: 100%; padding: 15px; border-radius: 15px; border: none; margin-bottom: 12px;
    font-size: 16px; background: white; color: #333; outline: none; box-sizing: border-box;
  }
  .auth-btn-main {
    width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--primary);
    color: white; font-weight: bold; font-size: 18px; cursor: pointer;
  }
  .auth-link { margin-top: 15px; font-size: 13px; cursor: pointer; text-decoration: underline; display: block; color: white; }
  .auth-lang-switch { position: absolute; top: 20px; right: 20px; }

  .rank-section { text-align: center; margin-bottom: 20px; width: 100%; max-width: 500px; }
  .xp-bar-container { width: 100%; background: rgba(0,0,0,0.3); height: 12px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
  #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #81c784); transition: width 0.5s ease; }
  .streak-badge { background: rgba(255, 87, 34, 0.25); padding: 5px 15px; border-radius: 50px; border: 1px solid #ff5722; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  
  .modal { display: none; position: fixed; z-index: 11000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); align-items: center; justify-content: center; }
  .modal-content { background: rgba(25, 25, 25, 0.95); padding: 30px; border-radius: 35px; width: 85%; max-width: 380px; color: white; border: 1px solid rgba(255,255,255,0.2); text-align: center; }
  .agree-btn { background: #ffffff; color: #121212; padding: 15px 40px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; margin-top: 25px; width: 100%; font-size: 16px; }
  
  .logo-container { margin-top: 80px; margin-bottom: 10px; text-align: center; }
  .logo-container img { max-width: 120px; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4)); }
  
  .container { width: 100%; max-width: 500px; background: var(--card-bg); backdrop-filter: blur(20px); padding: 30px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
  input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none; font-size: 16px; box-sizing: border-box; }
  input, select { background: var(--input-bg); color: var(--input-text); }
  button.calc-btn { background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
  
  #days-list { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; }
  .day-chip { padding: 6px 12px; border-radius: 10px; font-size: 11px; white-space: nowrap; background: rgba(0,0,0,0.25); color: white; border: 1px solid rgba(255,255,255,0.05); }
  .day-chip.active { background: var(--primary); font-weight: bold; box-shadow: 0 0 10px var(--primary); }

  .mission-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.15); padding: 12px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); }
  .mission-item.done { background: var(--primary); opacity: 0.95; transform: scale(0.98); }
  
  .section-title { margin-top: 25px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }
  .grid-results { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
  .res-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
  .res-box b { font-size: 20px; display: block; margin: 5px 0; }
  
  .footer-info { margin-top: 35px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center; width: 100%; direction: ltr !important; }
  .privacy-link { font-size: 12px; opacity: 0.8; cursor: pointer; display: block; margin-bottom: 15px; color: white; text-decoration: underline; }
  .footer-info a { color: var(--primary); text-decoration: none; font-weight: 600; }
  .ar-mode { direction: rtl; }
  .en-mode { direction: ltr; }
  .hidden { display: none !important; }
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #888; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background: var(--primary); }
  input:checked + .slider:before { transform: translateX(16px); }

  #lb-modal { display: none; position: fixed; z-index: 15000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items:center; justify-content:center; }
  .lb-card { background: #1a1a1a; width: 90%; max-width: 400px; border-radius: 30px; padding: 25px; max-height: 80vh; overflow-y: auto; color: white; border: 1px solid rgba(255,255,255,0.1); }
  .lb-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
  
  .lb-pic { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid var(--primary); background: #fff; }
  .lb-user { display: flex; align-items: center; }

  .shop-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
  .shop-item button { width: auto; padding: 8px 15px; font-size: 12px; margin: 0; background: var(--primary); color: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
  .shop-item button:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }
  .shop-item button.active { background: #ff5722; }
</style>
</head>
<body class="ar-mode">

<div class="menu-icon" id="menuBtn" onclick="toggleMenu()">â˜°</div>
<div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

<div class="side-menu" id="sideMenu">
    <div class="menu-profile-section">
        <img id="menu-user-avatar" class="menu-avatar" src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" onclick="triggerPhotoUpload()">
        <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="uploadPhoto(this)">
        <span id="menu-user-name" class="menu-username">User Name</span>
        <button id="btn-edit-name" onclick="changeName()" style="background:none; color:#FFD700; font-size:12px; padding:0; margin-top:5px; text-decoration:underline; width:auto; border:none; cursor:pointer;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>

    <div class="menu-item-row" onclick="closeMenuAndOpen(openLeaderboard)">
        <span id="mi-lb">Leaderboard ğŸ†</span>
    </div>
    <div class="menu-item-row" onclick="closeMenuAndOpen(openShop)">
        <span id="mi-shop">Lab Store ğŸ›’</span>
    </div>
    <div class="menu-item-row">
        <span id="mi-dark">Dark Mode ğŸŒ™</span>
        <label class="switch"><input type="checkbox" id="themeToggle" onchange="toggleTheme()"><span class="slider"></span></label>
    </div>
    <div class="menu-item-row">
        <span id="mi-lang">Language ğŸŒ</span>
        <label class="switch"><input type="checkbox" id="langToggle" checked onchange="toggleLanguage()"><span class="slider"></span></label>
    </div>
    
    <div class="menu-item-row" onclick="logout()" style="margin-top: 10px; border: 1px solid rgba(255, 87, 34, 0.3);">
        <span style="color: #ff5722; font-weight: bold;">Logout ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
        <span>ğŸšª</span>
    </div>
</div>

<div id="shop-modal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-top: 0;" id="shop-title">ğŸ›’ Lab Store</h3>
    <div style="background:var(--primary); padding:10px; border-radius:10px; margin-bottom:15px; font-weight:bold;">XP: <span id="shop-xp-val">0</span></div>
    
    <div class="shop-item">
        <span id="shop-i1">Neon Skin âœ¨<br><small>1000 XP</small></span>
        <button onclick="buyItem('neon', 1000)" id="btn-neon">Unlock</button>
    </div>
    <div class="shop-item">
        <span id="shop-i2">Gold Skin ğŸ‘‘<br><small>2000 XP</small></span>
        <button onclick="buyItem('gold', 2000)" id="btn-gold">Unlock</button>
    </div>
    <div class="shop-item" style="background: rgba(76, 175, 80, 0.1);">
        <span id="shop-i3">Your Custom Diet Plan ğŸ¥—<br><small>3000 XP</small></span>
        <button onclick="buyItem('diet', 3000)" id="btn-diet">Get</button>
    </div>
    <div class="shop-item">
        <span id="shop-i4">Pro PDF Guide ğŸ“š<br><small>500 XP</small></span>
        <button onclick="buyItem('pdf', 500)" id="btn-pdf">Get</button>
    </div>

    <button onclick="closeShop()" id="shop-close" style="background:rgba(255,255,255,0.1); color:white; margin-top:10px; border: 1px solid white;">Close</button>
  </div>
</div>

<div id="lb-modal" onclick="closeLeaderboard()">
  <div class="lb-card" onclick="event.stopPropagation()">
    <h2 style="text-align:center; margin-bottom:20px;" id="lb-title-text">ğŸ† Leaderboard</h2>
    <div id="lb-list">Loading...</div>
    <button onclick="closeLeaderboard()" id="lb-close-btn" style="background:var(--primary); color:white; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚ Close</button>
  </div>
</div>

<div id="auth-overlay">
  <div class="switch-container auth-lang-switch" style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:50px;">
    <span style="font-size: 10px; color:white;">EN</span>
    <label class="switch"><input type="checkbox" id="authLangToggle" checked onchange="syncLanguage(this)"><span class="slider"></span></label>
    <span style="font-size: 10px; color:white;">AR</span>
  </div>
  <div class="auth-card">
    <img src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" style="width:80px; margin-bottom:15px;">
    <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div id="signup-fields" class="hidden">
      <input type="text" id="auth-fname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
      <input type="text" id="auth-lname" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
    </div>
    <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="auth-btn-main" onclick="handleAuth()" id="auth-btn">Ø¯Ø®ÙˆÙ„</button>
    <span class="auth-link" onclick="toggleAuthMode()" id="auth-toggle-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</span>
    <span class="auth-link" style="color:#FFD700;" onclick="forgotPassword()" id="auth-forgot">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</span>
  </div>
</div>

<div id="privacyModal" class="modal">
  <div class="modal-content">
    <div style="font-size:50px; margin-bottom:20px;">ğŸ§ª</div>
    <h2 id="modal-title">RGALAB PRO</h2>
    <p id="modal-text"></p>
    <button class="agree-btn" id="modal-btn" onclick="acceptPrivacy()"></button>
  </div>
</div>

<div class="logo-container">
  <img src="https://i.ibb.co/SXkYZMWn/cropped-circle-image-3.png" alt="RGALAB Logo">
  <div class="rank-section">
    <div id="rank-display">RANK: RECRUIT</div>
    <div class="xp-bar-container"><div id="xp-fill"></div></div>
    <div class="streak-badge">ğŸ”¥ <span id="streak-num">0</span> <span id="lbl-streak-txt">DAYS STREAK</span></div>
  </div>
</div>

<div class="container">
  <div id="missionArea">
    <h3 id="lbl-missions" style="margin-top:0;">ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="days-list"></div>
    <div class="mission-item" onclick="doMission(this, 50)">
        <span id="m1">ğŸ‹ï¸ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</span> <b>+50 XP</b>
    </div>
    <div class="mission-item" onclick="doMission(this, 30)">
        <span id="m2">ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©</span> <b>+30 XP</b>
    </div>
  </div>

  <div style="display: flex; gap: 10px;">
    <input type="number" id="weight" placeholder="Ø§Ù„ÙˆØ²Ù†">
    <input type="number" id="height" placeholder="Ø§Ù„Ø·ÙˆÙ„">
  </div>
  <input type="number" id="age" placeholder="Ø§Ù„Ø¹Ù…Ø±">

  <select id="gender">
    <option value="male" id="opt-male"></option>
    <option value="female" id="opt-female"></option>
  </select>

  <select id="activity">
    <option value="1.2" id="act1"></option>
    <option value="1.375" id="act2"></option>
    <option value="1.55" id="act3"></option>
    <option value="1.725" id="act4"></option>
  </select>

  <button class="calc-btn" onclick="processAll()" id="calcBtn"></button>

  <div id="resultsArea" class="hidden">
    <div class="extra-card" style="background: rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-top:10px; text-align:center;">
        <div style="margin-bottom:5px; font-size:14px;"><span id="lbl-water-track"></span></div>
        <div id="water-tracker" style="cursor:pointer; font-size:22px; letter-spacing: 3px;">â¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œ</div>
    </div>
    <div class="grid-results">
      <div class="res-box"><small id="lbl-bmi"></small><b id="val-bmi">0</b><div id="status-bmi" style="font-size: 12px; font-weight: bold; color: #ffeb3b;"></div></div>
      <div class="res-box"><small id="lbl-ideal"></small><b id="val-ideal">0</b> <small class="unit-kg"></small></div>
    </div>
    <div class="grid-results"><div class="res-box" style="grid-column: span 2;"><small id="lbl-water"></small><b id="val-water">0</b> <small id="unit-l"></small></div></div>
    <h3 class="section-title" id="lbl-sec-cal"></h3>
    <div class="grid-results">
      <div class="res-box" style="grid-column: span 2; background: rgba(76, 175, 80, 0.2);"><small id="lbl-maintain"></small><b id="res-maintain">0</b></div>
      <div class="res-box"><small id="lbl-lose"></small><b id="res-lose">0</b></div>
      <div class="res-box"><small id="lbl-gain"></small><b id="res-gain">0</b></div>
    </div>
    <button onclick="shareStreak()" style="background: #FF5722; color: white; margin-top:20px;" id="btn-streak-share"></button>
    <button onclick="shareResults()" style="background: rgba(255,255,255,0.1); border: 1px solid white; cursor: pointer;" id="btn-share"></button>
    <p style="font-size: 10px; opacity: 0.5;">ID: <span id="myIdDisplay">---</span></p>
  </div>

  <div class="footer-info">
    <span class="privacy-link" onclick="showPrivacy()">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© | Privacy Policy</span>
    <div class="contact-item"><span>âœ‰ï¸</span> <a href="mailto:RGA@RGA.BEST">RGA@RGA.BEST</a></div>
    <div class="contact-item">ğŸ“¸ Dev: <a href="https://instagram.com/therealraed" target="_blank">therealraed</a></div>
  </div>
</div>

<script>
  const firebaseConfig = { apiKey: "AIzaSyDV7SNwgv_K10tX0iJpNYqg8_iJnWprFB4", authDomain: "rgalab.firebaseapp.com", projectId: "rgalab", storageBucket: "rgalab.firebasestorage.app", messagingSenderId: "882288745140", appId: "1:882288745140:web:3c77b0f83ac4e11d30d5e1" };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let lang = 'ar';
  let authMode = 'login';
  const DEFAULT_AVATAR = "https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png";
  let xp = parseInt(localStorage.getItem('rga_xp')) || 0;
  let streak = parseInt(localStorage.getItem('rga_streak')) || 0;
  let ownedItems = JSON.parse(localStorage.getItem('rga_owned')) || [];
  let userAvatarUrl = localStorage.getItem('rga_avatar') || DEFAULT_AVATAR;

  const trans = {
    ar: {
      authLogin: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", authSignup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", authBtnL: "Ø¯Ø®ÙˆÙ„", authBtnS: "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨",
      authLinkS: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†", authLinkL: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„", forgot: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ", emailPl: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", passPl: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
      fnamePl: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", lnamePl: "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", verifyMsg: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø¨Ø±ÙŠØ¯Ùƒ!", weight: "Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", height: "Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", age: "Ø§Ù„Ø¹Ù…Ø±", male: "Ø°ÙƒØ±", female: "Ø£Ù†Ø«Ù‰", calc: "ØªØ­Ù„ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      bmi: "Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…", water: "Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙƒÙ„ÙŠ", waterTrack: "ğŸ’§ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ:", l: "Ù„ØªØ±", kg: "ÙƒØº", ideal: "Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",
      maintain: "Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ²Ù†", lose: "ØªÙ†Ø´ÙŠÙ (0.5ÙƒØº)", gain: "ØªØ¶Ø®ÙŠÙ… (0.5ÙƒØº)", 
      act1: "Ø®Ø§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠÙ†)", act2: "Ø®ÙÙŠÙ (1-3 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act3: "Ù…ØªÙˆØ³Ø· (3-5 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act4: "Ø¹Ø§Ù„ÙŠ (6-7 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)",
      status: ["Ù†Ø­Ø§ÙØ©", "ÙˆØ²Ù† Ù…Ø«Ø§Ù„ÙŠ", "ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯", "Ø³Ù…Ù†Ø©"], calText: "Ø³Ø¹Ø±Ø©", secCal: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©", share: "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸš€",
      modalText: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¶Ù…Ø§Ù† Ø®ØµÙˆØµÙŠØªÙƒØŒ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹.", modalBtn: "Ø£ÙˆØ§ÙÙ‚ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø¨Ø¯Ø£", missions: "ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…", m1: "ğŸ‹ï¸ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…", m2: "ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©", ranks: ["Ù…Ø¬Ù†Ø¯", "Ø¹Ø±ÙŠÙ", "Ù…Ù‚Ø§ØªÙ„", "ÙˆØ­Ø´", "Ø£Ø³Ø·ÙˆØ±Ø©"], streakShare: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ”¥", streakTxt: "Ø£ÙŠØ§Ù… Ø§Ù„ØªØ²Ø§Ù…",
      days: ["Ø£Ø­Ø¯", "Ø¥Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"],
      forgotPrompt: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:", forgotSuccess: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.",
      userNotFound: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§.",
      shopTitle: "ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø±", shopClose: "Ø¥ØºÙ„Ø§Ù‚", shopI1: "Ù…Ø¸Ù‡Ø± Ø§Ù„Ù†ÙŠÙˆÙ† âœ¨", shopI2: "Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ‘‘", shopI3: "Ø¬Ø¯ÙˆÙ„ ØºØ°Ø§Ø¦ÙŠ Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ ğŸ¥—", shopI4: "Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Pro ğŸ“š",
      unlock: "ÙØªØ­", get: "Ø§Ø­ØµÙ„", on: "ØªÙØ¹ÙŠÙ„", off: "Ø¥ÙŠÙ‚Ø§Ù", bought: "ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!",
      editName: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", miLb: "Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†", miShop: "Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’", miDark: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ğŸŒ™", miLang: "Ø§Ù„ØºØ© ğŸŒ", logout: "Ø®Ø±ÙˆØ¬ Logout", lbTitle: "ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", lbClose: "Ø¥ØºÙ„Ø§Ù‚", nameWait: "ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ ÙƒÙ„ 3 Ø£ÙŠØ§Ù… ÙÙ‚Ø·"
    },
    en: {
      authLogin: "Sign In", authSignup: "Sign Up", authBtnL: "Login", authBtnS: "Register",
      authLinkS: "Register Now", authLinkL: "Login", forgot: "Forgot?", emailPl: "Email", passPl: "Password",
      fnamePl: "First Name", lnamePl: "Last Name", verifyMsg: "Verify your email!", weight: "Weight (kg)", height: "Height (cm)", age: "Age", male: "Male", female: "Female", calc: "Process Data",
      bmi: "BMI Index", water: "Water Need", waterTrack: "ğŸ’§ Water Tracker:", l: "L", kg: "kg", ideal: "Ideal Weight",
      maintain: "Maintain", lose: "Lose", gain: "Gain", 
      act1: "Sedentary (No workout)", act2: "Light (1-3 days workout)", act3: "Moderate (3-5 days workout)", act4: "Active (6-7 days workout)",
      status: ["Thin", "Normal", "Overweight", "Obese"], calText: "kcal", secCal: "Calories", share: "Share ğŸš€",
      modalText: "Welcome! Data is processed locally.", modalBtn: "I Agree", missions: "ğŸ¯ Missions", m1: "ğŸ‹ï¸ Workout", m2: "ğŸ¥— Meal", ranks: ["RECRUIT", "CORPORAL", "WARRIOR", "BEAST", "LEGEND"], streakShare: "Challenge ğŸ”¥", streakTxt: "DAYS STREAK",
      days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
      forgotPrompt: "Enter your email for password reset link:", forgotSuccess: "Reset link sent successfully.",
      userNotFound: "Sorry, this email is not registered.",
      shopTitle: "ğŸ›’ Lab Store", shopClose: "Close", shopI1: "Neon Skin âœ¨", shopI2: "Gold Skin ğŸ‘‘", shopI3: "Your Custom Diet Plan ğŸ¥—", shopI4: "Pro Training PDF ğŸ“š",
      unlock: "Unlock", get: "Get", on: "ON", off: "OFF", bought: "Unlocked Successfully!",
      editName: "Edit Name", miLb: "Leaderboard ğŸ†", miShop: "Lab Store ğŸ›’", miDark: "Dark Mode ğŸŒ™", miLang: "Language ğŸŒ", logout: "Logout", lbTitle: "ğŸ† Leaderboard", lbClose: "Close", nameWait: "You can change name every 3 days"
    }
  };

  function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); document.getElementById('menuOverlay').classList.toggle('active'); }
  function closeMenuAndOpen(func) { toggleMenu(); setTimeout(func, 300); }
  function toggleAuthMode() { authMode = (authMode === 'login' ? 'signup' : 'login'); document.getElementById('signup-fields').classList.toggle('hidden', authMode === 'login'); updateTexts(); }
  function syncLanguage(el) { document.getElementById('langToggle').checked = el.checked; toggleLanguage(); }
  
  function toggleLanguage() { 
    lang = document.getElementById('langToggle').checked ? 'ar' : 'en'; 
    document.body.className = (lang === 'ar' ? 'ar-mode' : 'en-mode') + (document.body.classList.contains('dark-theme') ? ' dark-theme' : ''); 
    document.getElementById('authLangToggle').checked = (lang === 'ar'); 
    updateTexts(); renderDays(); 
    if(!document.getElementById('resultsArea').classList.contains('hidden')) processAll(); 
  }
  
  function triggerPhotoUpload() { document.getElementById('photoInput').click(); }
  function uploadPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            userAvatarUrl = e.target.result;
            document.getElementById('menu-user-avatar').src = userAvatarUrl;
            localStorage.setItem('rga_avatar', userAvatarUrl);
            syncWithDB();
        };
        reader.readAsDataURL(input.files[0]);
    }
  }

  function changeName() {
    const lastChange = localStorage.getItem('rga_name_date') || 0;
    if (Date.now() - lastChange < 259200000) { alert(trans[lang].nameWait); return; }
    const newName = prompt("Enter new name:");
    if (newName) {
        auth.currentUser.updateProfile({ displayName: newName }).then(() => {
            document.getElementById('menu-user-name').innerText = newName;
            localStorage.setItem('rga_name_date', Date.now());
            syncWithDB();
        });
    }
  }

  function renderDays() {
    const container = document.getElementById('days-list');
    const days = trans[lang].days;
    const today = new Date().getDay();
    container.innerHTML = "";
    days.forEach((day, index) => {
        const div = document.createElement('div');
        div.className = `day-chip ${index === today ? 'active' : ''}`;
        div.innerText = day;
        container.appendChild(div);
    });
  }

  function updateTexts() {
    const t = trans[lang];
    document.getElementById('auth-title').innerText = (authMode === 'login' ? t.authLogin : t.authSignup);
    document.getElementById('auth-btn').innerText = (authMode === 'login' ? t.authBtnL : t.authBtnS);
    document.getElementById('auth-toggle-text').innerText = (authMode === 'login' ? t.authLinkS : t.authLinkL);
    document.getElementById('auth-forgot').innerText = t.forgot;
    document.getElementById('auth-email').placeholder = t.emailPl; document.getElementById('auth-pass').placeholder = t.passPl;
    document.getElementById('auth-fname').placeholder = t.fnamePl; document.getElementById('auth-lname').placeholder = t.lnamePl;
    document.getElementById('weight').placeholder = t.weight; document.getElementById('height').placeholder = t.height; document.getElementById('age').placeholder = t.age;
    document.getElementById('opt-male').innerText = t.male; document.getElementById('opt-female').innerText = t.female;
    document.getElementById('act1').innerText = t.act1; document.getElementById('act2').innerText = t.act2;
    document.getElementById('act3').innerText = t.act3; document.getElementById('act4').innerText = t.act4;
    document.getElementById('calcBtn').innerText = t.calc; document.getElementById('lbl-bmi').innerText = t.bmi;
    document.getElementById('lbl-ideal').innerText = t.ideal; document.getElementById('lbl-water').innerText = t.water;
    document.getElementById('lbl-water-track').innerText = t.waterTrack; document.getElementById('unit-l').innerText = t.l;
    document.querySelectorAll('.unit-kg').forEach(el => el.innerText = t.kg);
    document.getElementById('lbl-maintain').innerText = t.maintain; document.getElementById('lbl-lose').innerText = t.lose;
    document.getElementById('lbl-gain').innerText = t.gain; document.getElementById('lbl-sec-cal').innerText = t.secCal;
    document.getElementById('btn-share').innerText = t.share; document.getElementById('lbl-missions').innerText = t.missions;
    document.getElementById('m1').innerText = t.m1; document.getElementById('m2').innerText = t.m2;
    document.getElementById('btn-streak-share').innerText = t.streakShare; document.getElementById('modal-text').innerText = t.modalText;
    document.getElementById('modal-btn').innerText = t.modalBtn; document.getElementById('lbl-streak-txt').innerText = t.streakTxt;
    document.getElementById('btn-edit-name').innerText = t.editName;
    document.getElementById('mi-lb').innerText = t.miLb; document.getElementById('mi-shop').innerText = t.miShop;
    document.getElementById('mi-dark').innerText = t.miDark; document.getElementById('mi-lang').innerText = t.miLang;
    // ØªÙ… Ø­Ø°Ù Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ù‡Ù†Ø§ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('lb-title-text').innerText = t.lbTitle; document.getElementById('lb-close-btn').innerText = t.lbClose;
    document.getElementById('shop-title').innerText = t.shopTitle; document.getElementById('shop-close').innerText = t.shopClose;
    document.getElementById('shop-i1').innerHTML = t.shopI1 + "<br><small>1000 XP</small>";
    document.getElementById('shop-i2').innerHTML = t.shopI2 + "<br><small>2000 XP</small>";
    document.getElementById('shop-i3').innerHTML = t.shopI3 + "<br><small>3000 XP</small>";
    document.getElementById('shop-i4').innerHTML = t.shopI4 + "<br><small>500 XP</small>";
    updateRank(); updateShopButtons();
  }

  function handleAuth() {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    if(authMode === 'signup') {
        const fn = document.getElementById('auth-fname').value; const ln = document.getElementById('auth-lname').value;
        const fullName = fn + " " + ln;
        auth.createUserWithEmailAndPassword(email, pass).then(u => {
            u.user.updateProfile({ displayName: fullName, photoURL: DEFAULT_AVATAR });
            db.collection("ranks").doc(u.user.uid).set({ name: fullName, xp: 0, avatar: DEFAULT_AVATAR });
            u.user.sendEmailVerification(); alert(trans[lang].verifyMsg); auth.signOut();
        }).catch(e => alert(e.message));
    } else { auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message)); }
  }

  function forgotPassword() { 
    const emailInput = document.getElementById('auth-email').value;
    const email = prompt(trans[lang].forgotPrompt, emailInput);
    if(email) {
        auth.sendPasswordResetEmail(email).then(() => { alert(trans[lang].forgotSuccess); }).catch(e => { alert(e.message); });
    }
  }

  function logout() { auth.signOut().then(() => { localStorage.removeItem('rga_avatar'); location.reload(); }); }

  function checkStreak() {
    const today = new Date().toDateString();
    const lastDate = localStorage.getItem('rga_last_date');
    if (lastDate !== today) {
        if (lastDate === new Date(Date.now() - 86400000).toDateString()) streak++;
        else streak = 1;
        localStorage.setItem('rga_streak', streak); localStorage.setItem('rga_last_date', today);
    }
    document.getElementById('streak-num').innerText = streak;
  }

  function doMission(el, points) { if(!el.classList.contains('done')) { el.classList.add('done'); addXP(points); } }
  function addXP(amount) { xp += amount; localStorage.setItem('rga_xp', xp); updateRank(); syncWithDB(); }

  function syncWithDB() {
    const user = auth.currentUser;
    if(user) {
        db.collection("ranks").doc(user.uid).set({
            name: user.displayName || "Anonymous",
            xp: xp,
            avatar: userAvatarUrl 
        }, { merge: true });
        document.getElementById('myIdDisplay').innerText = user.uid.substring(0,8);
        document.getElementById('menu-user-name').innerText = user.displayName || "User";
        document.getElementById('menu-user-avatar').src = userAvatarUrl;
    }
  }

  function updateRank() {
    const level = Math.floor(xp / 100) + 1;
    const rankIdx = Math.min(Math.floor((level-1)/2), 4);
    const rLabel = (lang === 'ar' ? "Ø§Ù„Ø±ØªØ¨Ø©: " : "RANK: ");
    document.getElementById('rank-display').innerText = rLabel + trans[lang].ranks[rankIdx] + " (LVL " + level + ")";
    document.getElementById('xp-fill').style.width = (xp % 100) + "%";
  }

  function openLeaderboard() {
    document.getElementById('lb-modal').style.display = 'flex';
    const listDiv = document.getElementById('lb-list');
    listDiv.innerHTML = "Loading...";
    db.collection("ranks").orderBy("xp", "desc").limit(100).get().then(snap => {
        listDiv.innerHTML = "";
        let i = 1;
        snap.forEach(doc => {
            const data = doc.data();
            const currentPic = data.avatar || DEFAULT_AVATAR;
            listDiv.innerHTML += `
                <div class="lb-row">
                    <div class="lb-user">
                        <span style="width:20px; font-weight:bold;">#${i}</span>
                        <img src="${currentPic}" class="lb-pic">
                        <span>${data.name}</span>
                    </div>
                    <span>${data.xp} XP</span>
                </div>`;
            i++;
        });
    });
  }

  function closeLeaderboard() { document.getElementById('lb-modal').style.display = 'none'; }

  function processAll() {
    const w = parseFloat(document.getElementById('weight').value); 
    const h = parseFloat(document.getElementById('height').value);
    const a = parseFloat(document.getElementById('age').value); 
    const g = document.getElementById('gender').value;
    const act = parseFloat(document.getElementById('activity').value);
    if(!w || !h || !a) return;
    const bmi = (w / ((h/100)**2)).toFixed(1);
    document.getElementById('val-bmi').innerText = bmi;
    document.getElementById('status-bmi').innerText = trans[lang].status[bmi < 18.5 ? 0 : bmi < 25 ? 1 : bmi < 30 ? 2 : 3];
    let ideal = g === 'male' ? 50 + 2.3 * ((h/2.54) - 60) : 45.5 + 2.3 * ((h/2.54) - 60);
    document.getElementById('val-ideal').innerText = Math.round(ideal);
    document.getElementById('val-water').innerText = (w * 0.033).toFixed(1);
    let bmr = (10*w) + (6.25*h) - (5*a) + (g === 'male' ? 5 : -161);
    let maint = Math.round(bmr * act);
    document.getElementById('res-maintain').innerText = maint + " " + trans[lang].calText;
    document.getElementById('res-lose').innerText = (maint - 500) + " " + trans[lang].calText;
    document.getElementById('res-gain').innerText = (maint + 500) + " " + trans[lang].calText;
    document.getElementById('resultsArea').classList.remove('hidden');
    syncWithDB();
  }

  function renderWater() {
    let waterCups = localStorage.getItem('rga_water_count') || 0;
    let html = ""; for(let i=1; i<=8; i++) html += (i <= waterCups ? "ğŸŸ¦" : "â¬œ");
    document.getElementById('water-tracker').innerHTML = html;
  }

  document.getElementById('water-tracker').onclick = function() {
    let waterCups = parseInt(localStorage.getItem('rga_water_count') || 0);
    waterCups = waterCups >= 8 ? 0 : waterCups + 1;
    localStorage.setItem('rga_water_count', waterCups); renderWater();
  };

  function shareStreak() { navigator.clipboard.writeText(`Day ${streak} on RGALAB! ğŸ”¥`).then(() => alert("Copied!")); }
  function shareResults() { navigator.clipboard.writeText(`Calories: ${document.getElementById('res-maintain').innerText}`).then(() => alert("Copied!")); }

  function openShop() { 
    document.getElementById('shop-modal').style.display = 'flex';
    document.getElementById('shop-xp-val').innerText = xp;
    updateShopButtons();
  }

  function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }

  function updateShopButtons() {
    const t = trans[lang];
    ['neon', 'gold'].forEach(id => {
        const btn = document.getElementById('btn-'+id);
        if(ownedItems.includes(id)) {
            const isActive = document.body.classList.contains('skin-'+id);
            btn.innerText = isActive ? t.off : t.on;
            btn.className = isActive ? "active" : "";
        } else {
            btn.innerText = t.unlock;
            btn.disabled = xp < (id === 'neon' ? 1000 : 2000);
        }
    });
    document.getElementById('btn-diet').innerText = t.get; document.getElementById('btn-diet').disabled = xp < 3000;
    document.getElementById('btn-pdf').innerText = t.get; document.getElementById('btn-pdf').disabled = xp < 500;
  }

  function buyItem(item, cost) {
    if(ownedItems.includes(item)) {
        if(item === 'neon' || item === 'gold') {
            document.body.classList.toggle('skin-'+item); updateShopButtons();
        }
        return;
    }
    if(xp >= cost) {
        xp -= cost; localStorage.setItem('rga_xp', xp);
        if(item === 'neon' || item === 'gold') {
            ownedItems.push(item); localStorage.setItem('rga_owned', JSON.stringify(ownedItems));
            document.body.classList.add('skin-'+item);
        }
        alert(trans[lang].bought); document.getElementById('shop-xp-val').innerText = xp;
        updateRank(); syncWithDB(); updateShopButtons();
    }
  }

  window.onload = function() {
    updateTexts(); checkStreak(); renderWater(); renderDays();
    if (localStorage.getItem('rga_privacy_accepted') === 'true') document.getElementById("privacyModal").style.display = "none";
    auth.onAuthStateChanged(user => {
      if(user) { 
          document.getElementById('auth-overlay').classList.add('hidden'); 
          document.getElementById('menuBtn').style.display = "flex";
          db.collection("ranks").doc(user.uid).get().then(doc => {
              if(doc.exists && doc.data().avatar) {
                  userAvatarUrl = doc.data().avatar;
                  localStorage.setItem('rga_avatar', userAvatarUrl);
              } else {
                  userAvatarUrl = DEFAULT_AVATAR;
              }
              document.getElementById('menu-user-avatar').src = userAvatarUrl;
              document.getElementById('menu-user-name').innerText = user.displayName || "User";
          });
      }
      else { document.getElementById('auth-overlay').classList.remove('hidden'); document.getElementById('menuBtn').style.display = "none"; }
    });
  };

  function acceptPrivacy() { localStorage.setItem('rga_privacy_accepted', 'true'); document.getElementById("privacyModal").style.display = "none"; }
  function showPrivacy() { document.getElementById("privacyModal").style.display = "flex"; }
  function toggleTheme() { document.body.classList.toggle('dark-theme'); }
</script>
</body>
</html>
