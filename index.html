<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RGALAB - Health Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
<!-- âœ… NEW: Chart.js library for performance tracking -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- âœ¨âœ¨ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø°ÙƒÙŠØ© âœ¨âœ¨ --- */
.muscle-group-header {
    background: rgba(255, 255, 255, 0.08);
    padding: 15px 20px;
    margin-bottom: 5px;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.muscle-group-header:hover {
    background: rgba(255, 255, 255, 0.15);
}
/* Ø£ÙŠÙ‚ÙˆÙ†Ø© "+" Ùˆ "-" */
.muscle-group-header::after {
    content: '+';
    font-size: 24px;
    font-weight: 300;
    color: var(--primary);
    transition: transform 0.3s ease;
}
.muscle-group-header.active::after {
    content: 'âˆ’'; /* Ø±Ù…Ø² Ø§Ù„Ù†Ø§Ù‚Øµ */
    transform: rotate(180deg);
}
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ */
.exercise-list-collapsible {
    padding-left: 15px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
}
.exercise-list-collapsible .exercise-item-hub {
    background: rgba(0, 0, 0, 0.2);
    margin-top: 5px;
}

/* --- âœ¨ ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ù„ÙØ§Ø®Ø±Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) --- */
.pr-card {
    background: rgba(255, 255, 255, 0.1); /* Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø´ÙØ§ÙØ© */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 25px;
    margin-bottom: 25px;
    text-align: center;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… Ù„Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
}
.pr-trophy {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8); /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø´ÙØ§Ù ÙˆØ£Ù†ÙŠÙ‚ */
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 15px;
}
.pr-main-value {
    display: flex;
    justify-content: center;
    align-items: baseline;
    gap: 10px;
    color: white;
    margin-bottom: 20px;
}
.pr-main-value span:first-child {
    font-size: 56px; /* Ø®Ø· Ø£ÙƒØ¨Ø± Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙˆØ²Ù† */
    font-weight: 900;
    line-height: 1;
    color: var(--primary); /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
    text-shadow: 0 0 20px rgba(76, 175, 80, 0.7); /* Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‡Ø¬ ÙØ®Ù… Ø­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù… */
}
.pr-main-value .pr-unit {
    font-size: 22px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.7);
}
.pr-details {
    display: flex;
    justify-content: space-around;
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(0, 0, 0, 0.2); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø®ÙÙŠÙØ© Ù„Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù„ØªØ¨Ø§ÙŠÙ† */
    padding: 10px;
    border-radius: 12px;
}
#pt-history-list .history-item.modern {
    background: rgba(0,0,0,0.2);
    padding: 12px 15px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: none;
    font-size: 14px;
    transition: background 0.2s;
}
#pt-history-list .history-item.modern:hover {
    background: rgba(0,0,0,0.4); /* ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§ÙˆØ³ */
}

/* Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… ÙˆÙ†Ø³Ø® Ø§Ù„ØµÙˆØ± */
img {
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  user-select: none;
  pointer-events: none; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ù„Ù */
}
#deadlift-char { pointer-events: auto; } /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */

  :root {
    --primary: #4CAF50;
    --bg-image: url('https://wallpaper.forfun.com/fetch/63/63eded45b876ce6d693b91ea2838b59f.jpeg?w=2000&f=webp');
    --card-bg: rgba(255, 255, 255, 0.2);
    --text: white;
    --input-bg: white;
    --input-text: #333;
    --accent: #FFD700;
    --neon: #4CAF50;
    --menu-bg: rgba(15, 15, 15, 0.65);
    /* Ù‡Ù†Ø§ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */
    --game-bg: url('https://i.ibb.co/LDQjfGBk/IMG-4236.png');
  }
  /* Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„Ù„Ù…Ø³ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø²Ø¹Ø¬ */
  * { touch-action: manipulation; }
  .dark-theme {
    --bg-image: none;
    --bg: #0a0a0a;
    --card-bg: rgba(30, 30, 30, 0.7);
    --input-bg: #1e1e1e;
    --input-text: #eee;
    --text: #ffffff;
    --menu-bg: rgba(10, 10, 10, 0.8);
    background-color: #0a0a0a !important;
  }
  .skin-neon { --primary: #00ff41; --accent: #00ff41; --neon: #00ff41; text-shadow: 0 0 5px #00ff41; }
  .skin-gold { --primary: #FFD700; --accent: #FFD700; }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover;
    background-color: #f5f7fa;
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    transition: background 0.4s ease, background-color 0.4s ease;
    overflow-x: hidden;
  }
  /* --- Ù†Ø¸Ø§Ù… Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙŠØ¯Ù„ÙŠÙØª Ø§Ù„Ù…Ø·ÙˆØ± RGALAB PRO --- */
  #game-modal {
    display: none; position: fixed; z-index: 20000; left: 0; top: 0;
    width: 100%; height: 100%;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,20,0.8)), var(--game-bg) no-repeat center center;
    background-size: cover; backdrop-filter: blur(15px);
    align-items: center; justify-content: center; flex-direction: column;
  }
  /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
  .game-stats-bar {
    display: flex; gap: 15px; margin-bottom: 30px;
    background: rgba(255, 255, 255, 0.1); padding: 15px 25px;
    border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  .stat-item { text-align: center; min-width: 80px; }
  .stat-label { font-size: 10px; text-transform: uppercase; color: #bbb; display: block; letter-spacing: 1px; }
  .stat-value { font-size: 24px; font-weight: 900; color: #fff; }
  #game-timer-val { color: #ff5252; text-shadow: 0 0 10px rgba(255,82,82,0.5); }
  #session-xp-val { color: #4CAF50; text-shadow: 0 0 10px rgba(76,175,80,0.5); }
  .game-container {
    position: relative; width: 300px; height: 350px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.03); border-radius: 50%;
    border: 2px dashed rgba(255,255,255,0.1);
  }
  .deadlift-img {
    width: 250px; height: auto; transition: transform 0.1s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    filter: drop-shadow(0 0 25px var(--primary));
    cursor: pointer; -webkit-user-drag: none; user-select: none;
  }
  /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹ */
  .shake { animation: heavyShake 0.15s infinite; }
  @keyframes heavyShake {
    0% { transform: translate(2px, 1px) rotate(0deg); }
    50% { transform: translate(-2px, -1px) rotate(-1deg); }
    100% { transform: translate(2px, -1px) rotate(1deg); }
  }
  .xp-pop {
    position: absolute;
    color: #4CAF50;
    font-weight: 900;
    font-size: 35px;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 0 15px rgba(76, 175, 80, 0.8), 0 0 5px white;
    animation: xpRiseAndFade 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
  }
  @keyframes xpRiseAndFade {
    0% { opacity: 0; transform: translateY(0) scale(0.3) rotate(-15deg); }
    30% { opacity: 1; transform: translateY(-50px) scale(1.2) rotate(0deg); }
    100% { opacity: 0; transform: translateY(-120px) scale(1) rotate(15deg); }
  }
  .exit-btn-game {
    margin-top: 40px; padding: 12px 35px; background: rgba(255,82,82,0.1);
    color: #ff5252; border: 1px solid #ff5252; border-radius: 50px;
    font-weight: bold; cursor: pointer; transition: 0.3s;
  }
  .exit-btn-game:hover { background: #ff5252; color: white; }
  #ai-chat-btn {
    position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px;
    background: var(--primary); border-radius: 50%; display: none;
    align-items: center; justify-content: center; font-size: 30px;
    cursor: pointer; z-index: 10001; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    border: 2px solid white; transition: 0.3s;
  }
  #ai-chat-btn:hover { transform: scale(1.1); }
  #ai-window {
    position: fixed; bottom: 90px; left: 20px; width: 320px; height: 450px;
    background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px);
    border-radius: 20px; display: none; flex-direction: column; z-index: 10001;
    border: 1px solid rgba(255,255,255,0.1); overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.5);
  }
  .ai-header { background: var(--primary); padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  #ai-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 14px; }
  .ai-msg { padding: 10px 14px; border-radius: 15px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
  .ai-msg.bot { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
  .ai-msg.user { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 2px; color: white; }
  .ai-input-area { padding: 10px; background: rgba(0,0,0,0.3); display: flex; gap: 5px; }
  .ai-input-area input { flex: 1; background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 10px; outline: none; width: auto; margin: 0; }
  .ai-input-area button { width: auto; background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 0; }
  .menu-icon {
    position: fixed; top: 20px; right: 20px; z-index: 10001;
    cursor: pointer; font-size: 26px; background: rgba(255, 255, 255, 0.2);
    width: 45px; height: 45px; display: none; align-items: center; justify-content: center;
    border-radius: 50%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
  }
  .side-menu {
    position: fixed; top: 0; right: -350px; width: 280px; height: 100vh;
    background: rgba(10, 10, 10, 0.6);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    z-index: 10002; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    padding: 20px; display: flex; flex-direction: column; gap: 10px;
    box-shadow: -20px 0 40px rgba(0,0,0,0.7);
    overflow-y: auto; color: white;
    border-left: 1px solid rgba(255,255,255,0.08);
    box-sizing: border-box; /* âœ… FIX: Ensure padding is included in height calculation */
    padding-bottom: 80px; /* âœ… FIX: Add padding to the bottom */
  }
  .side-menu.active { right: 0; }
  /* --- ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¯Ø±Ù† Ù‚Ø²Ø§Ø²ÙŠ Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ --- */
  .menu-profile-section {
    text-align: center;
    padding: 25px 15px;
    margin-bottom: 20px;
    border-radius: 25px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  }
  .menu-avatar {
    width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    border: 3px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.3s;
    box-shadow: 0 0 25px var(--primary);
    background: #fff;
  }
  .menu-avatar:hover { transform: scale(1.08); filter: brightness(1.15); border-color: var(--primary); }
  .menu-username {
    font-weight: 800; margin-top: 15px; font-size: 20px; display: block;
    background: linear-gradient(90deg, #fff, #ddd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .user-id-badge {
    background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px;
    font-size: 11px; color: #aaa; margin-top: 5px; display: inline-block;
    cursor: pointer; border: 1px solid rgba(255,255,255,0.05); letter-spacing: 1px;
  }
  .menu-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); z-index: 10000; display: none;
    backdrop-filter: blur(4px);
  }
  .menu-overlay.active { display: block; }
  .menu-item-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px;
    cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05);
  }
  .menu-item-row:hover { background: rgba(255,255,255,0.1); transform: translateX(-5px); border-color: rgba(255,255,255,0.2); }
  #rank-display {
    font-weight: 800;
    color: #FFD700;
    text-transform: uppercase;
    text-shadow: 0px 2px 10px rgba(0, 0, 0, 0.8), 0px 0px 5px rgba(255, 215, 0, 0.5);
    letter-spacing: 1px; font-size: 17px; margin-bottom: 5px;
  }
  #auth-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-image) no-repeat center center fixed;
    background-size: cover; z-index: 20000; display: flex; align-items: center; justify-content: center;
  }
  .auth-card {
    background: var(--card-bg); backdrop-filter: blur(25px); padding: 40px 30px;
    border-radius: 40px; width: 90%; max-width: 400px; border: 1px solid rgba(255,255,255,0.2);
    text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
  }
  .auth-card input {
    width: 100%; padding: 15px; border-radius: 15px; border: none; margin-bottom: 12px;
    font-size: 16px; background: white; color: #333; outline: none; box-sizing: border-box;
  }
  .auth-btn-main {
    width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--primary);
    color: white; font-weight: bold; font-size: 18px; cursor: pointer;
  }
  .auth-link { margin-top: 15px; font-size: 13px; cursor: pointer; text-decoration: underline; display: block; color: white; }
  .auth-lang-switch { position: absolute; top: 20px; right: 20px; }
  .rank-section { text-align: center; margin-bottom: 20px; width: 100%; max-width: 500px; }
  .xp-bar-container { width: 100%; background: rgba(0,0,0,0.3); height: 12px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
  #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #81c784); transition: width 0.5s ease; }
  .streak-badge { background: rgba(255, 87, 34, 0.25); padding: 5px 15px; border-radius: 50px; border: 1px solid #ff5722; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  /* âœ… MODIFIED: Modal animation */
  .modal { display: none; position: fixed; z-index: 11000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
  .modal-content { background: rgba(25, 25, 25, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 30px; border-radius: 35px; width: 90%; max-width: 420px; color: white; border: 1px solid rgba(255,255,255,0.2); text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.4); animation: fadeInScaleUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  .agree-btn { background: #ffffff; color: #121212; padding: 15px 40px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; margin-top: 25px; width: 100%; font-size: 16px; transition: transform 0.1s ease; }
  .agree-btn:active { transform: scale(0.95); } /* âœ… NEW: Button press animation */
  .logo-container { margin-top: 80px; margin-bottom: 10px; text-align: center; }
  .logo-container img { max-width: 120px; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4)); }
  .container { width: 100%; max-width: 500px; background: var(--card-bg); backdrop-filter: blur(20px); padding: 30px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
  input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none; font-size: 16px; box-sizing: border-box; }
  input, select { background: var(--input-bg); color: var(--input-text); }
  button.calc-btn { background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
  button.calc-btn:active { transform: scale(0.97); } /* âœ… NEW: Button press animation */
  #days-list { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; }
  .day-chip { padding: 6px 12px; border-radius: 10px; font-size: 11px; white-space: nowrap; background: rgba(0,0,0,0.25); color: white; border: 1px solid rgba(255,255,255,0.05); }
  .day-chip.active { background: var(--primary); font-weight: bold; box-shadow: 0 0 10px var(--primary); }
  .mission-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.15); padding: 12px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); }
  .mission-item.done { background: var(--primary); opacity: 0.95; transform: scale(0.98); cursor: not-allowed; }
  .section-title { margin-top: 25px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }
  .grid-results { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
  .res-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
  .res-box b { font-size: 20px; display: block; margin: 5px 0; }
  .footer-info { margin-top: 35px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center; width: 100%; direction: ltr !important; }
  .privacy-link { font-size: 12px; opacity: 0.8; cursor: pointer; display: block; margin-bottom: 15px; color: white; text-decoration: underline; }
  .footer-info a { color: var(--primary); text-decoration: none; font-weight: 600; }
  .ar-mode { direction: rtl; }
  .en-mode { direction: ltr; }
  .hidden { display: none !important; }
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #888; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background: var(--primary); }
  input:checked + .slider:before { transform: translateX(16px); }
  #lb-modal { display: none; position: fixed; z-index: 15000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items:center; justify-content:center; }
  .lb-card { background: #1a1a1a; width: 90%; max-width: 400px; border-radius: 30px; padding: 25px; max-height: 80vh; overflow-y: auto; color: white; border: 1px solid rgba(255,255,255,0.1); }
  .lb-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
  .lb-pic { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid var(--primary); background: #fff; }
  .lb-user { display: flex; align-items: center; }
  .shop-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
  .shop-item button { width: auto; padding: 8px 15px; font-size: 12px; margin: 0; background: var(--primary); color: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
  .shop-item button:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }
  .shop-item button.active { background: #ff5722; }
.combo-pop {
  position: absolute;
  color: #FFD700;
  font-weight: 900;
  font-size: 45px;
  pointer-events: none;
  z-index: 200;
  text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 5px #000;
  animation: comboBounce 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.49) forwards;
}
@keyframes comboBounce {
  0% { opacity: 0; transform: scale(0.3) translateY(0); }
  50% { opacity: 1; transform: scale(1.3) translateY(-20px); }
  100% { opacity: 0; transform: scale(1) translateY(-60px); }
}
/* --- Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ --- */
#notif-icon {
    position: fixed; top: 20px; left: 20px; z-index: 10001;
    cursor: pointer; font-size: 24px; background: rgba(255,255,255,0.2);
    width: 45px; height: 45px; display: none; align-items: center; justify-content: center;
    border-radius: 50%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
}
#notif-badge {
    position: absolute; top: 0; right: 0; background: #ff5252; color: white;
    font-size: 10px; font-weight: bold; border-radius: 50%; padding: 3px 6px;
    display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}
#notif-dropdown {
    position: fixed; top: 75px; left: 20px; width: 300px; max-height: 400px;
    background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px);
    border-radius: 15px; display: none; flex-direction: column; z-index: 10002;
    border: 1px solid rgba(255,255,255,0.1); overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.notif-item {
    padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 13px; display: flex; flex-direction: column; gap: 5px;
}
.notif-actions { display: flex; gap: 5px; margin-top: 5px; }
.btn-accept { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
.btn-reject { background: #ff5252; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
/* Friend List in Menu */
.friend-section {
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: 20px; padding-top: 20px;
}
.friend-add-box {
    display: flex; gap: 8px; margin-bottom: 15px;
    background: rgba(255,255,255,0.05); padding: 8px;
    border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);
}
.friend-add-box input {
    padding: 10px; font-size: 13px; border-radius: 10px; background: transparent;
    border: none; color: white; flex: 1; margin: 0;
}
.friend-add-box button {
    width: auto; padding: 0 15px; font-size: 14px; margin: 0; background: var(--primary);
    border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.friend-add-box button:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
.friend-list-item {
    display: flex; align-items: center; gap: 12px; padding: 12px;
    background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px;
    cursor: pointer; transition: 0.2s; border: 1px solid transparent;
}
.friend-list-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); transform: scale(1.02); }
.f-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }
/* --- âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØ­Ø¯ÙŠØ« Ù‚Ø²Ø§Ø²ÙŠ) âœ¨ --- */
#friend-modal {
    display: none; position: fixed; z-index: 12000; left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.friend-card {
    background: radial-gradient(circle, rgba(40, 42, 48, 0.5) 0%, rgba(25, 26, 30, 0.4) 100%);
    backdrop-filter: blur(50px) saturate(220%);
    -webkit-backdrop-filter: blur(50px) saturate(220%);
    width: 90%; max-width: 380px; height: 75vh; max-height: 600px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    display: flex; flex-direction: column;
    overflow: hidden;
}
.friend-header {
    padding: 15px;
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.05);
    position: relative;
    direction: ltr;
}
#f-modal-img {
    width: 50px; height: 50px; border-radius: 50%;
    border: 2px solid var(--primary);
    box-shadow: 0 0 15px var(--primary);
}
.friend-info {
    flex: 1;
    text-align: left;
}
.friend-info h3 { margin: 0; font-size: 18px; }
.friend-info span { color: #FFD700; font-weight: bold; font-size: 12px; text-shadow: 0 0 8px rgba(255,215,0,0.5); }
.friend-actions {
    display: flex; gap: 10px;
    margin-left: auto;
}
.friend-actions button {
    background: none; border: none; color: rgba(255,255,255,0.6);
    font-size: 20px; cursor: pointer; padding: 5px; margin:0; width:auto;
}
.friend-actions button:hover { color: white; }
#btn-remove-f:hover { color: #ff5252; }
.chat-box {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
}
.chat-box::-webkit-scrollbar { width: 5px; }
.chat-box::-webkit-scrollbar-track { background: transparent; }
.chat-box::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.15); border-radius: 10px; }
.chat-msg {
    padding: 10px 15px;
    border-radius: 16px;
    max-width: 75%;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.chat-msg.me {
    background: var(--primary);
    color: white;
    align-self: flex-end;
    text-align: right;
    margin-left: auto;
}
.chat-msg.them {
    background: rgba(255, 255, 255, 0.1);
    color: #f1f1f1;
    align-self: flex-start;
    text-align: left;
    margin-right: auto;
}
.chat-input-area {
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}
.xp-sender-box {
    display: flex; gap: 8px; margin-bottom: 8px;
}
.xp-sender-box input {
    flex-grow: 3;
    background: rgba(0,0,0,0.4); border: none; padding: 10px;
    color: white; text-align: left; font-weight: bold; margin: 0;
    border-radius: 10px; font-size: 14px;
}
.xp-sender-box button {
    flex-grow: 1;
    margin: 0; display: flex; align-items: center; justify-content: center; gap: 5px;
    border-radius: 10px; background: linear-gradient(90deg, #FF9800, #F57C00);
    box-shadow: 0 2px 10px rgba(255, 152, 0, 0.3);
    transition: all 0.2s ease;
    padding: 0 10px; font-size: 13px;
}
.xp-sender-box button:hover { box-shadow: 0 4px 15px rgba(255, 152, 0, 0.5); transform: translateY(-1px); }
.xp-sender-box button:disabled { background: #555; cursor: not-allowed; opacity: 0.6; box-shadow: none; transform: none; }
.chat-input-wrapper {
    display: flex; gap: 8px;
    background: rgba(0,0,0,0.4);
    padding: 5px; border-radius: 12px;
    align-items: center;
}
.chat-input-wrapper input {
    font-size: 14px; padding: 10px; background: transparent;
    border: none; margin: 0; flex: 1; outline: none; color: white;
}
.chat-input-wrapper button {
    width: 38px; height: 38px;
    border-radius: 10px; margin: 0;
    background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s; padding: 0; font-size: 20px;
}
/* âœ… NEW & REFINED: Modern Modals Style */
#days-modal .day-selector-container { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.1); }
.day-selector { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.day-selector .day-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 50px; cursor: pointer; transition: 0.2s ease-in-out; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.day-selector .day-btn.selected { background: var(--primary); border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 15px var(--primary); }
.muscle-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
.muscle-selector .muscle-btn { padding: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 15px; cursor: pointer; transition: 0.2s; font-weight: bold; }
.muscle-selector .muscle-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
.logger-form { position: relative; display: flex; gap: 10px; margin-bottom: 15px; }
.logger-form input { margin: 0; }
.logger-form button { width: auto; padding: 0 15px; margin: 0; font-size: 20px; }
#performance-history-icon { position: absolute; right: 60px; top: 50%; transform: translateY(-50%); font-size: 20px; cursor: pointer; display: none; }
.ar-mode #performance-history-icon { left: 60px; right: auto; }
#logged-exercises-list .exercise-item { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
/* âœ… NEW: Performance Hub Modal Style */
#performance-hub-modal .modal-content { max-width: 95%; width: 600px; height: 80vh; max-height: 700px; display: flex; flex-direction: column; padding: 0; }
.hub-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
.hub-header h2 { margin: 0; font-size: 20px; }
.hub-header .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; margin: 0; width: auto; }
.hub-body { flex: 1; overflow-y: auto; padding: 20px; }
.hub-tabs { display: flex; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
.hub-tabs button { width: auto; background: none; border: none; color: rgba(255,255,255,0.5); padding: 10px 15px; cursor: pointer; font-size: 14px; font-weight: bold; border-bottom: 2px solid transparent; margin: 0; border-radius: 0; }
.hub-tabs button.active { color: var(--primary); border-bottom-color: var(--primary); }
.hub-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
.hub-stat-box { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; text-align: center; }
.hub-stat-box .label { font-size: 12px; opacity: 0.7; margin-bottom: 8px; }
.hub-stat-box .value { font-size: 24px; font-weight: 800; }
#hub-history-content input { margin-bottom: 15px; background: rgba(0,0,0,0.3); }
#hub-exercise-list .exercise-item-hub { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
#hub-exercise-list .exercise-item-hub:hover { background: rgba(255,255,255,0.1); }
/* âœ… NEW: Performance Tracker Modal Style */
#performance-tracker-modal .modal-content { max-width: 500px; }
#pt-pr-display { background: linear-gradient(45deg, var(--accent), #f9a825); color: #111; padding: 10px; border-radius: 10px; font-weight: bold; text-align: center; margin: 10px 0; }
#pt-history-list { max-height: 120px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
#pt-history-list .history-item { display: flex; justify-content: space-between; font-size: 13px; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
/* âœ… NEW: Toast Notification Style */
#toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 12px 20px; border-radius: 50px; z-index: 50000; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
#toast-notification.show { bottom: 30px; }
/* ÙƒÙˆØ¯ Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ±Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ */
#pt-pr-display {
    background: none !important;
}
/*
--- âœ¨âœ¨âœ¨ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¯Ù…Ø¬ ÙˆØ§Ù„ÙØ§Ø®Ø± Ù„Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡ âœ¨âœ¨âœ¨ ---
*/
/* 1. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø§Ù…ÙŠØ© (Ù„Ø§ ØªØºÙŠÙŠØ±) */
#performance-tracker-modal {
    background: radial-gradient(ellipse at top, rgba(255, 255, 255, 0.1) 0%, rgba(10, 10, 10, 0.9) 80%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
}
/* 2. Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ Ø§Ù„Ù…Ø¯Ù…Ø¬ (Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„) */
#performance-tracker-modal .modal-content {
    /* Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙƒÙ‚Ø·Ø¹Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ù… */
    background: radial-gradient(circle, rgba(40, 42, 48, 0.7) 0%, rgba(25, 26, 30, 0.8) 100%);
    backdrop-filter: blur(50px) saturate(200%);
    -webkit-backdrop-filter: blur(50px) saturate(200%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    border-radius: 28px; /* Ø²ÙŠØ§Ø¯Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù */
    
    /* âœ… ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ¬Ø¹Ù„Ù‡ Ù…Ù„Ù…ÙˆÙ…Ù‹Ø§ */
    max-width: 440px; 
    width: 90%;
    
    /* âœ… Ø¥Ø¶Ø§ÙØ© padding Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø§Ù„ØªØµØ§Ù‚ Ø¨Ø§Ù„Ø­ÙˆØ§Ù */
    padding: 25px;
}
/* 3. Ø¬Ø¹Ù„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø´ÙØ§ÙØ© Ù„ØªÙ†Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
#performance-tracker-modal .pr-card {
    background: transparent;
    backdrop-filter: none;
    border: none;
    box-shadow: none;
    padding: 0;
    margin-bottom: 20px;
}
#performance-tracker-modal #performance-chart {
    min-height: 180px;
    margin: 20px 0;
}
</style>
</head>
<body class="ar-mode">
<!-- âœ… NEW: Toast Notification element -->
<div id="toast-notification"></div>
<div id="notif-icon" onclick="toggleNotifs()">ğŸ””<span id="notif-badge">0</span></div>
<div id="notif-dropdown">
    <div style="padding:10px; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1);" id="notif-header-text">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Notifications</div>
    <div id="notif-list"></div>
</div>
<div id="ai-chat-btn" onclick="toggleAIChat()">ğŸ¤–</div>
<div id="game-modal">
  <div class="game-stats-bar">
    <div class="stat-item">
        <span class="stat-label">TIME</span>
        <span id="game-timer-val" class="stat-value">60s</span>
    </div>
    <div class="stat-item" style="border-left: 1px solid rgba(255,255,255,0.1); padding-left:15px;">
        <span class="stat-label">EARNED XP</span>
        <span id="session-xp-val" class="stat-value">0</span>
    </div>
    <div class="stat-item" style="border-left: 1px solid rgba(255,255,255,0.1); padding-left:15px;">
        <span class="stat-label">BEST COMBO</span>
        <span id="best-combo-val" class="stat-value">0</span>
    </div>
</div>
    <div class="game-container" id="shake-target">
        <img id="deadlift-char" class="deadlift-img"
             src=""
             onmousedown="handleInteraction(event, 'start')"
             onmouseup="handleInteraction(event, 'end')"
             ontouchstart="handleInteraction(event, 'start')"
             ontouchend="handleInteraction(event, 'end')">
    </div>
    <button class="exit-btn-game" onclick="closeGame()">EXIT SESSION</button>
</div>
<div id="ai-window">
    <div class="ai-header">
        <span id="ai-title">Ù…Ø¯Ø±Ø¨ RGALAB Ø§Ù„Ø°ÙƒÙŠ</span>
        <span style="cursor:pointer; font-size: 20px;" onclick="toggleAIChat()">Ã—</span>
    </div>
    <div id="ai-messages"></div>
    <div class="ai-input-area">
        <input type="text" id="ai-userInput" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡..." onkeypress="if(event.key==='Enter') askGroq()">
        <button onclick="askGroq()" id="ai-send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>
<div class="menu-icon" id="menuBtn" onclick="toggleMenu()">â˜°</div>
<div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
<div class="side-menu" id="sideMenu">
    <div class="menu-profile-section">
        <img id="menu-user-avatar" class="menu-avatar" src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" onclick="triggerPhotoUpload()">
        <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="uploadPhoto(this)">
        <span id="menu-user-name" class="menu-username">User Name</span>
        <div id="menu-user-id" class="user-id-badge" onclick="copyMyId()">ID: ...</div>
        <br>
        <button id="btn-edit-name" onclick="changeName()" style="background:none; color:#FFD700; font-size:12px; padding:0; margin-top:8px; text-decoration:none; width:auto; border:1px solid rgba(255,215,0,0.3); border-radius:15px; cursor:pointer; padding: 4px 10px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
    </div>
    <!-- âœ… REFINED: Menu items -->
    <div class="menu-item-row" onclick="closeMenuAndOpen(openPerformanceHub)">
        <span id="mi-hub">ğŸ“Š Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
    </div>
     <div class="menu-item-row" onclick="closeMenuAndOpen(openWorkoutDaysModal)">
        <span id="mi-schedule">ğŸ—“ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</span>
    </div>
    <div class="menu-item-row" onclick="closeMenuAndOpen(openGame)" style="background: rgba(76, 175, 80, 0.2); border: 1px solid var(--primary);">
        <span id="mi-game">Deadlift Game ğŸ‹ï¸â€â™‚ï¸</span>
        <span style="font-size: 10px; background: red; padding: 2px 5px; border-radius: 50px;">XP+</span>
    </div>
    <div class="menu-item-row" onclick="closeMenuAndOpen(openLeaderboard)">
        <span id="mi-lb">Leaderboard ğŸ†</span>
    </div>
    <div class="menu-item-row" onclick="closeMenuAndOpen(openShop)">
        <span id="mi-shop">Lab Store ğŸ›’</span>
    </div>
    <div class="menu-item-row">
        <span id="mi-dark">Dark Mode ğŸŒ™</span>
        <label class="switch"><input type="checkbox" id="themeToggle" onchange="toggleTheme()"><span class="slider"></span></label>
    </div>
    <div class="menu-item-row">
        <span id="mi-lang">Language ğŸŒ</span>
        <label class="switch"><input type="checkbox" id="langToggle" checked onchange="toggleLanguage()"><span class="slider"></span></label>
    </div>
    <div class="friend-section">
        <div id="mi-friends" style="font-size:14px; font-weight:800; margin-bottom:12px; opacity:0.8;">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Friends ğŸ‘¥</div>
        <div class="friend-add-box">
            <input type="text" id="friend-id-input" placeholder="ID Ø§Ù„ØµØ¯ÙŠÙ‚">
            <button id="add-friend-btn" onclick="sendFriendRequest(this)">+</button>
        </div>
        <div id="friend-list-container">
            <small style="opacity:0.5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</small>
        </div>
    </div>
    <div class="menu-item-row" onclick="logout()" style="margin-top: 10px; border: 1px solid rgba(255, 87, 34, 0.3);">
        <span id="mi-logout" style="color: #ff5722; font-weight: bold;">Logout ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
        <span>ğŸšª</span>
    </div>
</div>
<div id="friend-modal" onclick="document.getElementById('friend-modal').style.display='none'">
    <div class="friend-card" onclick="event.stopPropagation()">
        <div class="friend-header">
            <img id="f-modal-img" src="">
            <div class="friend-info">
                <h3 id="f-modal-name">Name</h3>
                <span id="f-modal-streak-container">ğŸ”¥ <span id="f-modal-streak">0</span></span>
            </div>
            <div class="friend-actions">
                 <button id="btn-remove-f" onclick="removeFriend()" title="Remove Friend">ğŸ—‘ï¸</button>
                 <button onclick="document.getElementById('friend-modal').style.display='none'" title="Close">âœ–</button>
            </div>
        </div>
        <div class="chat-box" id="f-chat-box"></div>
        <div class="chat-input-area">
            <div class="xp-sender-box">
                <input type="number" id="xp-amount-input" placeholder="XP" min="1">
                <button id="btn-send-xp" onclick="sendXPToFriend(this)"><span id="xp-send-btn-text">Ø¥Ø±Ø³Ø§Ù„</span> ğŸ</button>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">â¤</button>
            </div>
        </div>
    </div>
</div>
<div id="shop-modal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-top: 0;" id="shop-title">ğŸ›’ Lab Store</h3>
    <div style="background:var(--primary); padding:10px; border-radius:10px; margin-bottom:15px; font-weight:bold;">XP: <span id="shop-xp-val">0</span></div>
    <div class="shop-item">
        <span id="shop-i1">Neon Skin âœ¨<br><small>1000 XP</small></span>
        <button onclick="buyItem('neon', 1000)" id="btn-neon">Unlock</button>
    </div>
    <div class="shop-item">
        <span id="shop-i2">Gold Skin ğŸ‘‘<br><small>2000 XP</small></span>
        <button onclick="buyItem('gold', 2000)" id="btn-gold">Unlock</button>
    </div>
    <div class="shop-item" style="background: rgba(76, 175, 80, 0.1);">
        <span id="shop-i3">Your Custom Diet Plan ğŸ¥—<br><small>3000 XP</small></span>
        <button onclick="buyItem('diet', 3000)" id="btn-diet">Get</button>
    </div>
    <div class="shop-item">
        <span id="shop-i4">Pro PDF Guide ğŸ“š<br><small>500 XP</small></span>
        <button onclick="buyItem('pdf', 500)" id="btn-pdf">Get</button>
    </div>
    <button onclick="closeShop()" id="shop-close" style="background:rgba(255,255,255,0.1); color:white; margin-top:10px; border: 1px solid white;">Close</button>
  </div>
</div>
<div id="lb-modal" onclick="closeLeaderboard()">
  <div class="lb-card" onclick="event.stopPropagation()">
    <h2 style="text-align:center; margin-bottom:20px;" id="lb-title-text">ğŸ† Leaderboard</h2>
    <div id="lb-list">Loading...</div>
    <button onclick="closeLeaderboard()" id="lb-close-btn" style="background:var(--primary); color:white; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚ Close</button>
  </div>
</div>
<div id="auth-overlay">
  <div class="switch-container auth-lang-switch" style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:50px;">
    <span style="font-size: 10px; color:white;">EN</span>
    <label class="switch"><input type="checkbox" id="authLangToggle" checked onchange="syncLanguage(this)"><span class="slider"></span></label>
    <span style="font-size: 10px; color:white;">AR</span>
  </div>
  <div class="auth-card">
    <img src="https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png" style="width:80px; margin-bottom:15px;">
    <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div id="signup-fields" class="hidden">
      <input type="text" id="auth-fname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
      <input type="text" id="auth-lname" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
    </div>
    <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="auth-btn-main" onclick="handleAuth()" id="auth-btn">Ø¯Ø®ÙˆÙ„</button>
    <span class="auth-link" onclick="toggleAuthMode()" id="auth-toggle-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</span>
    <span class="auth-link" style="color:#FFD700;" onclick="forgotPassword()" id="auth-forgot">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</span>
  </div>
</div>
<div id="privacyModal" class="modal">
  <div class="modal-content">
    <div style="font-size:50px; margin-bottom:20px;">ğŸ§ª</div>
    <h2 id="modal-title">RGALAB PRO</h2>
    <p id="modal-text"></p>
    <button class="agree-btn" id="modal-btn" onclick="acceptPrivacy()"></button>
  </div>
</div>
<!-- âœ… REFINED: Workout Days Modal -->
<div id="days-modal" class="modal">
    <div class="modal-content">
        <h3 id="wd-title">Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</h3>
        <p id="wd-subtitle" style="opacity: 0.7; font-size: 14px;"></p>
        <div class="day-selector-container">
            <div class="day-selector" id="day-selector-cal"></div>
        </div>
        <button class="agree-btn" id="wd-save" onclick="saveWorkoutDays()">Ø­ÙØ¸</button>
    </div>
</div>
<!-- âœ… REFINED: Muscle Group Modal -->
<div id="muscle-group-modal" class="modal">
    <div class="modal-content">
        <h3 id="mg-title">Ù…Ø§Ø°Ø§ Ø³ØªÙ…Ø±Ù† Ø§Ù„ÙŠÙˆÙ…ØŸ</h3>
        <div class="muscle-selector" id="muscle-group-selector"></div>
        <button onclick="document.getElementById('muscle-group-modal').style.display='none'" style="background:rgba(255,255,255,0.1); color:white; margin-top:10px; border: 1px solid white; width:100%; padding:12px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>
<!-- âœ… REFINED: Workout Logger Modal -->
<div id="logger-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0" id="wl-title">Ø³Ø¬Ù„ ØªÙ…Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</h3>
        <div class="logger-form">
            <input type="text" id="log-exercise" placeholder="Ø§Ù„ØªÙ…Ø±ÙŠÙ†" onkeyup="checkExerciseHistory(this.value)">
            <span id="performance-history-icon" onclick="showPerformanceTracker()">ğŸ“ˆ</span>
            <input type="number" id="log-weight" placeholder="Ø§Ù„ÙˆØ²Ù†">
            <input type="number" id="log-reps" placeholder="Ø§Ù„ØªÙƒØ±Ø§Ø±">
            <button onclick="addExerciseToLog()" style="background:var(--primary); color:white;">+</button>
        </div>
        <div id="logged-exercises-list" style="max-height: 150px; overflow-y:auto; padding: 5px; background: rgba(0,0,0,0.1); border-radius:10px; min-height: 50px;">
        </div>
        <button class="agree-btn" onclick="saveLoggedWorkout()" id="wl-save" style="margin-top:20px;">Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
         <button onclick="closeWorkoutLogger()" id="wl-close" style="background:rgba(255,255,255,0.1); color:white; margin-top:10px; border: 1px solid white; width:100%; padding:12px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<!-- âœ… NEW: Performance Tracker Modal -->
<div id="performance-tracker-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0" id="pt-title">ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
        <div id="pt-pr-display"></div>
        <div style="margin: 15px 0;"><canvas id="performance-chart"></canvas></div>
        <h4 id="pt-history-title" style="margin-bottom: 5px; font-size: 14px; text-align: start;">Ø¢Ø®Ø± Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h4>
        <div id="pt-history-list"></div>
        <button onclick="document.getElementById('performance-tracker-modal').style.display='none'" class="agree-btn" style="margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<!-- âœ… NEW: Performance Hub Modal -->
<div id="performance-hub-modal" class="modal">
    <div class="modal-content">
        <div class="hub-header">
            <h2 id="ph-title"></h2>
            <button class="close-btn" onclick="document.getElementById('performance-hub-modal').style.display='none'">&times;</button>
        </div>
        <div class="hub-tabs">
            <button id="hub-tab-overview" class="active" onclick="switchHubTab('overview')"></button>
            <button id="hub-tab-history" onclick="switchHubTab('history')"></button>
        </div>
        <div class="hub-body">
            <div id="hub-overview-content">
                <div class="hub-stats-grid">
                    <div class="hub-stat-box"><div id="ph-total-workouts-label" class="label"></div><div id="hub-total-workouts" class="value">0</div></div>
                    <div class="hub-stat-box"><div id="ph-total-weight-label" class="label"></div><div id="hub-total-weight" class="value">0</div></div>
                </div>
<div style="width: 100%; height: 250px; margin-top: 20px;"><canvas id="hub-muscle-chart"></canvas></div>
            </div>
            <div id="hub-history-content" class="hidden">
                 <input type="text" id="hub-search-exercise" onkeyup="filterHubExercises(this.value)" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ…Ø±ÙŠÙ†...">
                <div id="hub-exercise-list" style="max-height: 350px; overflow-y: auto;"></div>
            </div>
             <div id="hub-no-data" class="hidden" style="text-align:center; padding: 40px 20px; opacity: 0.7;"></div>
        </div>
    </div>
</div>
<div class="logo-container">
  <img src="https://i.ibb.co/SXkYZMWn/cropped-circle-image-3.png" alt="RGALAB Logo">
  <div class="rank-section">
    <div id="rank-display">RANK: RECRUIT</div>
    <div class="xp-bar-container"><div id="xp-fill"></div></div>
    <div class="streak-badge">ğŸ”¥ <span id="streak-num">0</span> <span id="lbl-streak-txt">DAYS STREAK</span></div>
  </div>
</div>
<div class="container">
  <div id="missionArea">
    <h3 id="lbl-missions" style="margin-top:0;">ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="dynamic-mission-area"></div>
    <div class="mission-item" id="mission-meal" onclick="doMission(this, 30)">
        <span><span id="m2">ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©</span></span> <b>+30 XP</b>
    </div>
  </div>
  <div style="display: flex; gap: 10px;">
    <input type="number" id="weight" placeholder="Ø§Ù„ÙˆØ²Ù†">
    <input type="number" id="height" placeholder="Ø§Ù„Ø·ÙˆÙ„">
  </div>
  <input type="number" id="age" placeholder="Ø§Ù„Ø¹Ù…Ø±">
  <select id="gender">
    <option value="male" id="opt-male"></option>
    <option value="female" id="opt-female"></option>
  </select>
  <select id="activity">
    <option value="1.2" id="act1"></option>
    <option value="1.375" id="act2"></option>
    <option value="1.55" id="act3"></option>
    <option value="1.725" id="act4"></option>
  </select>
  <button class="calc-btn" onclick="processAll()" id="calcBtn"></button>
  <div id="resultsArea" class="hidden">
    <div class="extra-card" style="background: rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-top:10px; text-align:center;">
        <div style="margin-bottom:5px; font-size:14px;"><span id="lbl-water-track"></span></div>
        <div id="water-tracker" style="cursor:pointer; font-size:22px; letter-spacing: 3px;">â¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œâ¬œ</div>
    </div>
    <div class="grid-results">
      <div class="res-box"><small id="lbl-bmi"></small><b id="val-bmi">0</b><div id="status-bmi" style="font-size: 12px; font-weight: bold; color: #ffeb3b;"></div></div>
      <div class="res-box"><small id="lbl-ideal"></small><b id="val-ideal">0</b> <small class="unit-kg"></small></div>
    </div>
    <div class="grid-results"><div class="res-box" style="grid-column: span 2;"><small id="lbl-water"></small><b id="val-water">0</b> <small id="unit-l"></small></div></div>
    <h3 class="section-title" id="lbl-sec-cal"></h3>
    <div class="grid-results">
      <div class="res-box" style="grid-column: span 2; background: rgba(76, 175, 80, 0.2);"><small id="lbl-maintain"></small><b id="res-maintain">0</b></div>
      <div class="res-box"><small id="lbl-lose"></small><b id="res-lose">0</b></div>
      <div class="res-box"><small id="lbl-gain"></small><b id="res-gain">0</b></div>
    </div>
    <button onclick="shareStreak()" style="background: #FF5722; color: white; margin-top:20px;" id="btn-streak-share"></button>
    <button onclick="shareResults()" style="background: rgba(255,255,255,0.1); border: 1px solid white; cursor: pointer;" id="btn-share"></button>
    <p style="font-size: 10px; opacity: 0.5;">ID: <span id="myIdDisplay">---</span></p>
  </div>
  <div class="footer-info">
    <span class="privacy-link" onclick="showPrivacy()">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© | Privacy Policy</span>
    <div class="contact-item"><span>âœ‰ï¸</span> <a href="mailto:RGA@RGA.BEST">RGA@RGA.BEST</a></div>
    <div class="contact-item">ğŸ“¸ Dev: <a href="https://instagram.com/therealraed" target="_blank">therealraed</a></div>
  </div>
</div>
<script>
  // --- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¨Ø© (Ø¹Ø¯Ù„ Ù‡Ù†Ø§ ÙÙ‚Ø·) ---
  const LIFT_IMG_DOWN = "https://i.ibb.co/zW74jkmK/IMG-4239.png";
  const LIFT_IMG_UP = "https://i.ibb.co/zVkNkjfZ/IMG-4238.png";
  // ----------------------------------------
  // --- ØªÙ‚Ø³ÙŠÙ… Ù…ÙØªØ§Ø­ Firebase API ---
  const fbPart1 = "AIzaSyDV7SNwgv_";
  const fbPart2 = "K10tX0iJpNYqg8_iJnWprFB4";
  
  const firebaseConfig = { 
    apiKey: fbPart1 + fbPart2, // Ø¯Ù…Ø¬ Ø§Ù„Ø¬Ø²Ø¦ÙŠÙ† Ù‡Ù†Ø§
    authDomain: "rgalab.firebaseapp.com", 
    projectId: "rgalab", 
    storageBucket: "rgalab.firebasestorage.app", 
    messagingSenderId: "882288745140", 
    appId: "1:882288745140:web:3c77b0f83ac4e11d30d5e1" 
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
// ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ø¬Ø²Ø¦ÙŠÙ† Ø¹Ø´Ø§Ù† GitHub Ù…Ø§ ÙŠÙƒØªØ´ÙÙ‡ ÙƒÙ€ Key ÙƒØ§Ù…Ù„
const part1 = "gsk_eMTl37P6";
const part2 = "ggnYTFOIhBchWGdyb3FYjhW2aliBOIz9XHrUbJuJsxFL";
const GROQ_KEY = part1 + part2;
  let chatHistory = [];
  let lang = 'ar';
  let authMode = 'login';
  const DEFAULT_AVATAR = "https://i.ibb.co/9mPmHXkh/cropped-circle-image-2.png";
  let xp = 0;
  let streak = 0;
  let ownedItems = JSON.parse(localStorage.getItem('rga_owned')) || [];
  let userAvatarUrl = localStorage.getItem('rga_avatar') || DEFAULT_AVATAR;
  let myShortId = "";
  let currentFriendId = null;
  let chatUnsubscribe = null; 
  let notifUnsubscribe = null; 
  let rankUnsubscribe = null; 
  let workoutDays = []; 
  let tempLoggedExercises = []; 
  let currentMuscleGroup = ""; 
  let performanceChart = null;
  let hubMuscleChart = null; // âœ… NEW: For Hub Chart.js instance
  const trans = {
    ar: {
      authLogin: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", authSignup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", authBtnL: "Ø¯Ø®ÙˆÙ„", authBtnS: "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨",
      authLinkS: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†", authLinkL: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„", forgot: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ", emailPl: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", passPl: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
      fnamePl: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", lnamePl: "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", verifyMsg: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø¨Ø±ÙŠØ¯Ùƒ!", weight: "Ø§Ù„ÙˆØ²Ù† (ÙƒØº)", height: "Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)", age: "Ø§Ù„Ø¹Ù…Ø±", male: "Ø°ÙƒØ±", female: "Ø£Ù†Ø«Ù‰", calc: "ØªØ­Ù„ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      bmi: "Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…", water: "Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙƒÙ„ÙŠ", waterTrack: "ğŸ’§ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ:", l: "Ù„ØªØ±", kg: "ÙƒØº", ideal: "Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",
      maintain: "Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ²Ù†", lose: "ØªÙ†Ø´ÙŠÙ (0.5ÙƒØº)", gain: "ØªØ¶Ø®ÙŠÙ… (0.5ÙƒØº)",
      act1: "Ø®Ø§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠÙ†)", act2: "Ø®ÙÙŠÙ (1-3 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act3: "Ù…ØªÙˆØ³Ø· (3-5 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)", act4: "Ø¹Ø§Ù„ÙŠ (6-7 Ø£ÙŠØ§Ù… ØªÙ…Ø±ÙŠÙ†)",
      status: ["Ù†Ø­Ø§ÙØ©", "ÙˆØ²Ù† Ù…Ø«Ø§Ù„ÙŠ", "ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯", "Ø³Ù…Ù†Ø©"], calText: "Ø³Ø¹Ø±Ø©", secCal: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©", share: "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸš€",
      modalText: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¶Ù…Ø§Ù† Ø®ØµÙˆØµÙŠØªÙƒØŒ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹.", modalBtn: "Ø£ÙˆØ§ÙÙ‚ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø¨Ø¯Ø£", missions: "ğŸ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…",
      m1: "ğŸ‹ï¸â€â™‚ï¸ ÙŠÙˆÙ… ØªÙ…Ø±ÙŠÙ†", m2: "ğŸ¥— ÙˆØ¬Ø¨Ø© ØµØ­ÙŠØ©", m3: "ğŸ§˜â€â™‚ï¸ ÙŠÙˆÙ… Ø±Ø§Ø­Ø©",
      ranks: ["Ù…Ø¬Ù†Ø¯", "Ø¹Ø±ÙŠÙ", "Ù…Ù‚Ø§ØªÙ„", "ÙˆØ­Ø´", "Ø£Ø³Ø·ÙˆØ±Ø©"], streakShare: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ”¥", streakTxt: "Ø£ÙŠØ§Ù… Ø§Ù„ØªØ²Ø§Ù…",
      days: ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"],
      daysShort: ["Ø­", "Ù†", "Ø«", "Ø±", "Ø®", "Ø¬", "Ø³"],
      muscleGroups: {chest: "ØµØ¯Ø±", back: "Ø¸Ù‡Ø±", legs: "Ø£Ø±Ø¬Ù„", arms: "Ø£Ø°Ø±Ø¹", shoulders: "Ø£ÙƒØªØ§Ù", fullbody: "ØªÙ…Ø±ÙŠÙ† Ø´Ø§Ù…Ù„"},
      forgotPrompt: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:", forgotSuccess: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.",
      userNotFound: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§.", xpNo: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ XP ÙƒØ§ÙÙŠ!", xpSent: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ XP Ø¨Ù†Ø¬Ø§Ø­!", xpErr: "Ø­Ø¯Ø« Ø®Ø·Ø£!",
      shopTitle: "ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø±", shopClose: "Ø¥ØºÙ„Ø§Ù‚", shopI1: "Ù…Ø¸Ù‡Ø± Ø§Ù„Ù†ÙŠÙˆÙ† âœ¨", shopI2: "Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ‘‘", shopI3: "Ø¬Ø¯ÙˆÙ„ ØºØ°Ø§Ø¦ÙŠ Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ ğŸ¥—", shopI4: "Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Pro ğŸ“š",
      unlock: "ÙØªØ­", get: "Ø§Ø­ØµÙ„", on: "ØªÙØ¹ÙŠÙ„", off: "Ø¥ÙŠÙ‚Ø§Ù", bought: "ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!", xpSend: "Ø¥Ø±Ø³Ø§Ù„",
      editName: "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", miSchedule: "ğŸ—“ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†", miHub: "ğŸ“Š Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø¯Ø§Ø¡", miLb: "Leaderboard ğŸ†", miShop: "Lab Store ğŸ›’", miDark: "Dark Mode ğŸŒ™", miLang: "Language ğŸŒ", logout: "Logout ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", lbTitle: "ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", lbClose: "Ø¥ØºÙ„Ø§Ù‚", nameWait: "ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ ÙƒÙ„ 3 Ø£ÙŠØ§Ù… ÙÙ‚Ø·",
      aiWelcome: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø¯Ø±Ø¨Ùƒ Ø§Ù„Ù…Ø­ØªØ±Ù. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŒ Ø§Ù„ØªØºØ°ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª!", aiInputPl: "Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡...", aiSend: "Ø¥Ø±Ø³Ø§Ù„",
      miFriends: "Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ‘¥", miFriendIdPl: "ID Ø§Ù„ØµØ¯ÙŠÙ‚", miNoFriends: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯", fChatPl: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...", fChatWait: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ", fRemove: "Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚", fRemoveConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ",
      notifHeader: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Notifications ğŸ””", notifEmpty: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹", notifFriendReq: "Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ù…Ù†", notifAccept: "Ù‚Ø¨ÙˆÙ„", notifReject: "Ø±ÙØ¶", notifGift: "Ø§Ø³ØªÙ„Ù…Øª Ù‡Ø¯ÙŠØ© XP Ù…Ù†", notifMsg: "Ø±Ø³Ø§Ù„Ø© Ù…Ù†",
      wdTitle: "Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ", wdSubtitle: "Ø§Ø®ØªØ± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ ØªØªÙ…Ø±Ù† ÙÙŠÙ‡Ø§ Ø¹Ø§Ø¯Ø©Ù‹.", wdSave: "Ø­ÙØ¸",
      mgTitle: "Ù…Ø§ Ø¹Ø¶Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ØŸ", wlTitle: "ØªØ³Ø¬ÙŠÙ„ ØªÙ…Ø§Ø±ÙŠÙ†", wlSave: "Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†", wlClose: "Ø¥ØºÙ„Ø§Ù‚",
      logEx: "Ø§Ù„ØªÙ…Ø±ÙŠÙ†", logKg: "Ø§Ù„ÙˆØ²Ù†", logReps: "Ø§Ù„ØªÙƒØ±Ø§Ø±",
      ptTitle: "ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡", ptPR: "Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡", ptHistory: "Ø¢Ø®Ø± Ø§Ù„Ø¬Ù„Ø³Ø§Øª", ptClose: "Ø¥ØºÙ„Ø§Ù‚",
      copied: "ØªÙ… Ø§Ù„Ù†Ø³Ø®!", workoutSaved: "Ø¹Ø§Ø´! ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†.",
      phTitle: "Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø¯Ø§Ø¡", phOverview: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©", phHistory: "Ø³Ø¬Ù„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†", phTotalWorkouts: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†", phTotalWeight: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ²Ø§Ù† (ÙƒØº)", phSearch: "Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ…Ø±ÙŠÙ†...", phNoData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ ØªÙ…Ø§Ø±ÙŠÙ†Ùƒ Ù„Ø±Ø¤ÙŠØ© ØªØ­Ù„ÙŠÙ„Ø§ØªÙƒ Ù‡Ù†Ø§!",
    },
    en: {
      authLogin: "Sign In", authSignup: "Sign Up", authBtnL: "Login", authBtnS: "Register",
      authLinkS: "Register Now", authLinkL: "Login", forgot: "Forgot?", emailPl: "Email", passPl: "Password",
      fnamePl: "First Name", lnamePl: "Last Name", verifyMsg: "Verify your email!", weight: "Weight (kg)", height: "Height (cm)", age: "Age", male: "Male", female: "Female", calc: "Process Data",
      bmi: "BMI Index", water: "Water Need", waterTrack: "ğŸ’§ Water Tracker:", l: "L", kg: "kg", ideal: "Ideal Weight",
      maintain: "Maintain", lose: "Lose", gain: "Gain",
      act1: "Sedentary (No workout)", act2: "Light (1-3 days workout)", act3: "Moderate (3-5 days workout)", act4: "Active (6-7 days workout)",
      status: ["Thin", "Normal", "Overweight", "Obese"], calText: "kcal", secCal: "Calories", share: "Share ğŸš€",
      modalText: "Welcome! Data is processed locally.", modalBtn: "I Agree", missions: "ğŸ¯ Missions",
      m1: "ğŸ‹ï¸â€â™‚ï¸ Workout Day", m2: "ğŸ¥— Healthy Meal", m3: "ğŸ§˜â€â™‚ï¸ Recovery Day",
      ranks: ["RECRUIT", "CORPORAL", "WARRIOR", "BEAST", "LEGEND"], streakShare: "Challenge ğŸ”¥", streakTxt: "DAYS STREAK",
      days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
      daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
      muscleGroups: {chest: "Chest", back: "Back", legs: "Legs", arms: "Arms", shoulders: "Shoulders", fullbody: "Full Body"},
      forgotPrompt: "Enter your email for password reset link:", forgotSuccess: "Reset link sent.",
      userNotFound: "Sorry, this email is not registered.", xpNo: "Not enough XP!", xpSent: "XP Sent Successfully!", xpErr: "An error occurred!",
      shopTitle: "ğŸ›’ Lab Store", shopClose: "Close", shopI1: "Neon Skin âœ¨", shopI2: "Gold Skin ğŸ‘‘", shopI3: "Your Custom Diet Plan ğŸ¥—", shopI4: "Pro Training PDF ğŸ“š",
      unlock: "Unlock", get: "Get", on: "ON", off: "OFF", bought: "Unlocked Successfully!", xpSend: "Send",
      editName: "âœï¸ Edit Name", miSchedule: "ğŸ—“ï¸ Edit Schedule", miHub: "ğŸ“Š Performance Hub", miLb: "Leaderboard ğŸ†", miShop: "Lab Store ğŸ›’", miDark: "Dark Mode ğŸŒ™", miLang: "Language ğŸŒ", logout: "Logout", lbTitle: "ğŸ† Leaderboard", lbClose: "Close", nameWait: "You can change name every 3 days",
      aiWelcome: "Hello! I am your pro coach. Ask me about training, nutrition, or supplements!", aiInputPl: "Ask me anything...", aiSend: "Send",
      miFriends: "Friends ğŸ‘¥", miFriendIdPl: "Friend's ID", miNoFriends: "No friends yet", fChatPl: "Type a message...", fChatWait: "Start chatting with your friend", fRemove: "Remove Friend", fRemoveConfirm: "Are you sure you want to remove this friend?",
      notifHeader: "Notifications ğŸ””", notifEmpty: "No notifications yet", notifFriendReq: "Friend request from", notifAccept: "Accept", notifReject: "Reject", notifGift: "Received XP gift from", notifMsg: "Message from",
      wdTitle: "Set Your Workout Schedule", wdSubtitle: "Select the days you usually work out.", wdSave: "Save",
      mgTitle: "What are you training today?", wlTitle: "Log", wlSave: "Save & Finish Workout", wlClose: "Close",
      logEx: "Exercise", logKg: "Weight", logReps: "Reps",
      ptTitle: "Performance Tracker", ptPR: "Personal Record", ptHistory: "Recent Sessions", ptClose: "Close",
      copied: "Copied!", workoutSaved: "Nice! Workout saved.",
      phTitle: "Performance Hub", phOverview: "Overview", phHistory: "Exercise History", phTotalWorkouts: "Total Workouts", phTotalWeight: "Total Weight Lifted (kg)", phSearch: "Search exercise...", phNoData: "No data yet. Start logging workouts to see your analytics here!",
    }
  };
  let gameInterval;
  let timeLeft = 60;
  let isGameActive = false;
  let sessionXP = 0;
  let comboCount = 0;
  let comboTimer;
  let globalBestCombo = 0;
  let lastInteractionTime = 0;

  function handleInteraction(e, type) {
      e.preventDefault();
      const now = Date.now();
      if (type === 'start') {
          if (now - lastInteractionTime < 50) return;
          lastInteractionTime = now;
          liftStart();
      } else {
          liftEnd();
      }
  }

  function openGame() {
    const lastPlayed = localStorage.getItem('rga_game_last_time') || 0;
    const now = Date.now();
    const cooldown = 3600000; // 1 hour
    if (now - lastPlayed < cooldown) {
        const remaining = Math.ceil((cooldown - (now - lastPlayed)) / 60000);
        showToast(lang === 'ar' ? `Ø¹Ø¶Ù„Ø§ØªÙƒ ØªØ­ØªØ§Ø¬ Ø±Ø§Ø­Ø©! Ø§Ù†ØªØ¸Ø± ${remaining} Ø¯Ù‚ÙŠÙ‚Ø©.` : `Need rest! Wait ${remaining} mins.`);
        return;
    }
    comboCount = 0;
    document.getElementById('best-combo-val').innerText = globalBestCombo;
    sessionXP = 0;
    document.getElementById('session-xp-val').innerText = "0";
    document.getElementById('deadlift-char').src = LIFT_IMG_DOWN;
    document.getElementById('game-modal').style.display = 'flex';
    startTimer();
  }

  function startTimer() {
    timeLeft = 60;
    isGameActive = true;
    document.getElementById('game-timer-val').innerText = `${timeLeft}s`;
    gameInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('game-timer-val').innerText = `${timeLeft}s`;
        if (timeLeft <= 0) {
            finishGame(true);
        }
    }, 1000);
  }

  function closeGame() {
    const confirmMsg = lang === 'ar' ? "Ø¥Ø°Ø§ Ø®Ø±Ø¬Øª Ø§Ù„Ø¢Ù†ØŒ Ø³ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆÙ„Ù† ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ù„Ø¹Ø¨ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ" : "If you exit now, the session ends and you wait 1 hour. Confirm?";
    if (confirm(confirmMsg)) { finishGame(false); }
  }

  function finishGame(isTimeUp) {
    clearInterval(gameInterval);
    isGameActive = false;
    localStorage.setItem('rga_game_last_time', Date.now());
    const msg = lang === 'ar' ? `Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„! +${sessionXP} XP` : `Great job! +${sessionXP} XP`;
    showToast(msg);
    document.getElementById('game-modal').style.display = 'none';
    syncWithDB({xp: firebase.firestore.FieldValue.increment(sessionXP)});
  }

  function liftStart() {
    if (!isGameActive) return;
    const char = document.getElementById('deadlift-char');
    const container = document.getElementById('shake-target');
    char.src = LIFT_IMG_UP;
    char.style.transform = "translateY(-20px) scale(1.05)";
    container.classList.add('shake');
    comboCount++;
    clearTimeout(comboTimer);
    if (comboCount > globalBestCombo) {
        globalBestCombo = comboCount;
        document.getElementById('best-combo-val').innerText = globalBestCombo;
        syncWithDB({bestCombo: globalBestCombo});
    }
    if (comboCount > 1) {
        const comboEl = document.createElement('div');
        comboEl.className = 'combo-pop';
        comboEl.innerText = comboCount + "x";
        comboEl.style.left = (Math.random() * 40 + 30) + '%';
        comboEl.style.top = '10%';
        document.querySelector('.game-container').appendChild(comboEl);
        setTimeout(() => comboEl.remove(), 500);
    }
    comboTimer = setTimeout(() => { comboCount = 0; }, 800);
    sessionXP++;
    document.getElementById('session-xp-val').innerText = sessionXP;
    const pop = document.createElement('div');
    pop.className = 'xp-pop'; pop.innerText = '+1';
    pop.style.left = (Math.random() * 60 + 20) + '%';
    document.querySelector('.game-container').appendChild(pop);
    setTimeout(() => pop.remove(), 800);
  }

  function liftEnd() {
    if (!isGameActive) return;
    const char = document.getElementById('deadlift-char');
    const container = document.getElementById('shake-target');
    if(char) { char.src = LIFT_IMG_DOWN; char.style.transform = "translateY(0) scale(1)"; }
    if(container) container.classList.remove('shake');
  }

  function toggleMenu() {
      document.getElementById('notif-dropdown').style.display = 'none';
      document.getElementById('sideMenu').classList.toggle('active');
      document.getElementById('menuOverlay').classList.toggle('active');
  }

  function closeMenuAndOpen(func) { toggleMenu(); setTimeout(func, 300); }
  function toggleAuthMode() { authMode = (authMode === 'login' ? 'signup' : 'login'); document.getElementById('signup-fields').classList.toggle('hidden', authMode === 'login'); updateTexts(); }
  function syncLanguage(el) { document.getElementById('langToggle').checked = el.checked; toggleLanguage(); }

  function toggleLanguage() {
    lang = document.getElementById('langToggle').checked ? 'ar' : 'en';
    document.body.className = (lang === 'ar' ? 'ar-mode' : 'en-mode') + (document.body.classList.contains('dark-theme') ? ' dark-theme' : '');
    document.getElementById('authLangToggle').checked = (lang === 'ar');
    chatHistory = [];
    const msgArea = document.getElementById('ai-messages');
    if(msgArea) msgArea.innerHTML = `<div class="ai-msg bot">${trans[lang].aiWelcome}</div>`;
    updateTexts();
    renderTodaysMissions();
    if(!document.getElementById('resultsArea').classList.contains('hidden')) processAll();
    if(auth.currentUser) listenToNotifications();
  }

  function updateTexts() {
    const t = trans[lang];
    if(!t) return;
    document.getElementById('auth-title').innerText = (authMode === 'login' ? t.authLogin : t.authSignup);
    document.getElementById('auth-btn').innerText = (authMode === 'login' ? t.authBtnL : t.authBtnS);
    document.getElementById('auth-toggle-text').innerText = (authMode === 'login' ? t.authLinkS : t.authLinkL);
    document.getElementById('auth-forgot').innerText = t.forgot;
    document.getElementById('auth-email').placeholder = t.emailPl; document.getElementById('auth-pass').placeholder = t.passPl;
    document.getElementById('auth-fname').placeholder = t.fnamePl; document.getElementById('auth-lname').placeholder = t.lnamePl;
    document.getElementById('weight').placeholder = t.weight; document.getElementById('height').placeholder = t.height; document.getElementById('age').placeholder = t.age;
    document.getElementById('opt-male').innerText = t.male; document.getElementById('opt-female').innerText = t.female;
    document.getElementById('act1').innerText = t.act1; document.getElementById('act2').innerText = t.act2;
    document.getElementById('act3').innerText = t.act3; document.getElementById('act4').innerText = t.act4;
    document.getElementById('calcBtn').innerText = t.calc; document.getElementById('lbl-bmi').innerText = t.bmi;
    document.getElementById('lbl-ideal').innerText = t.ideal; document.getElementById('lbl-water').innerText = t.water;
    document.getElementById('lbl-water-track').innerText = t.waterTrack; document.getElementById('unit-l').innerText = t.l;
    document.querySelectorAll('.unit-kg').forEach(el => el.innerText = t.kg);
    document.getElementById('lbl-maintain').innerText = t.maintain; document.getElementById('lbl-lose').innerText = t.lose;
    document.getElementById('lbl-gain').innerText = t.gain; document.getElementById('lbl-sec-cal').innerText = t.secCal;
    document.getElementById('btn-share').innerText = t.share; document.getElementById('lbl-missions').innerText = t.missions;
    document.getElementById('m2').innerText = t.m2;
    document.getElementById('btn-streak-share').innerText = t.streakShare; document.getElementById('modal-text').innerText = t.modalText;
    document.getElementById('modal-btn').innerText = t.modalBtn; document.getElementById('lbl-streak-txt').innerText = t.streakTxt;
    document.getElementById('btn-edit-name').innerText = t.editName;
    document.getElementById('mi-schedule').innerText = t.miSchedule;
    document.getElementById('mi-hub').innerText = t.miHub;
    document.getElementById('mi-lb').innerText = t.miLb; document.getElementById('mi-shop').innerText = t.miShop;
    document.getElementById('mi-dark').innerText = t.miDark; document.getElementById('mi-lang').innerText = t.miLang;
    document.getElementById('lb-title-text').innerText = t.lbTitle; document.getElementById('lb-close-btn').innerText = t.lbClose;
    document.getElementById('shop-title').innerText = t.shopTitle; document.getElementById('shop-close').innerText = t.shopClose;
    document.getElementById('shop-i1').innerHTML = t.shopI1; document.getElementById('shop-i2').innerHTML = t.shopI2;
    document.getElementById('shop-i3').innerHTML = t.shopI3; document.getElementById('shop-i4').innerHTML = t.shopI4;
    document.getElementById('ai-title').innerText = (lang === 'ar' ? 'Ù…Ø¯Ø±Ø¨ RGALAB Ø§Ù„Ø°ÙƒÙŠ' : 'RGALAB AI Coach');
    document.getElementById('ai-userInput').placeholder = t.aiInputPl;
    document.getElementById('ai-send-btn').innerText = t.aiSend;
    document.getElementById('xp-send-btn-text').innerText = t.xpSend;
    document.getElementById('btn-remove-f').title = t.fRemove;
    document.getElementById('mi-friends').innerText = t.miFriends;
    document.getElementById('friend-id-input').placeholder = t.miFriendIdPl;
    document.getElementById('notif-header-text').innerText = t.notifHeader;
    document.getElementById('chat-input').placeholder = t.fChatPl;
    document.getElementById('wd-title').innerText = t.wdTitle; document.getElementById('wd-subtitle').innerText = t.wdSubtitle; document.getElementById('wd-save').innerText = t.wdSave;
    document.getElementById('mg-title').innerText = t.mgTitle;
    document.getElementById('wl-save').innerText = t.wlSave; document.getElementById('wl-close').innerText = t.wlClose;
    document.getElementById('log-exercise').placeholder = t.logEx; document.getElementById('log-weight').placeholder = t.logKg; document.getElementById('log-reps').placeholder = t.logReps;
    document.getElementById('pt-title').innerText = t.ptTitle; document.getElementById('pt-history-title').innerText = t.ptHistory;
    document.querySelector('#performance-tracker-modal .agree-btn').innerText = t.ptClose;
    document.getElementById('ph-title').innerText = t.phTitle;
    document.getElementById('hub-tab-overview').innerText = t.phOverview;
    document.getElementById('hub-tab-history').innerText = t.phHistory;
    document.getElementById('ph-total-workouts-label').innerText = t.phTotalWorkouts;
    document.getElementById('ph-total-weight-label').innerText = t.phTotalWeight;
    document.getElementById('hub-search-exercise').placeholder = t.phSearch;
    document.getElementById('hub-no-data').innerText = t.phNoData;
    updateRankDisplay(); updateShopButtons();
  }

  function toggleAIChat() {
    const win = document.getElementById('ai-window');
    win.style.display = (win.style.display === 'flex' ? 'none' : 'flex');
    if(document.getElementById('ai-messages').innerHTML === "") { document.getElementById('ai-messages').innerHTML = `<div class="ai-msg bot">${trans[lang].aiWelcome}</div>`; }
  }

  async function askGroq() {
    const input = document.getElementById('ai-userInput');
    const msgArea = document.getElementById('ai-messages');
    const text = input.value.trim();
    if(!text) return;
    msgArea.innerHTML += `<div class="ai-msg user">${text}</div>`;
    const systemPrompt = lang === 'ar' ? "Ø£Ù†Øª Ù…Ø¯Ø±Ø¨ Ø±ÙŠØ§Ø¶ÙŠ Ø®Ø¨ÙŠØ± ÙÙŠ Ù…Ø®ØªØ¨Ø± RGALAB. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©." : "You are an expert fitness coach at RGALAB.";
    if (chatHistory.length === 0) chatHistory.push({ role: "system", content: systemPrompt });
    chatHistory.push({ role: "user", content: text });
    input.value = ""; msgArea.scrollTop = msgArea.scrollHeight;
    const loadingId = "load-" + Date.now();
    msgArea.innerHTML += `<div class="ai-msg bot" id="${loadingId}">...</div>`;
    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: chatHistory, temperature: 0.7 })
        });
        const data = await response.json();
        const reply = data.choices[0].message.content;
        document.getElementById(loadingId).innerText = reply;
        chatHistory.push({ role: "assistant", content: reply });
        if (chatHistory.length > 15) chatHistory = [chatHistory[0], ...chatHistory.slice(-10)];
    } catch (e) { document.getElementById(loadingId).innerText = "Error."; }
    msgArea.scrollTop = msgArea.scrollHeight;
  }

  function triggerPhotoUpload() { document.getElementById('photoInput').click(); }

  function uploadPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            userAvatarUrl = e.target.result;
            document.getElementById('menu-user-avatar').src = userAvatarUrl;
            localStorage.setItem('rga_avatar', userAvatarUrl);
            syncWithDB({avatar: userAvatarUrl});
        }; reader.readAsDataURL(input.files[0]);
    }
  }

  function changeName() {
    const lastChange = localStorage.getItem('rga_name_date') || 0;
    if (Date.now() - lastChange < 259200000) { showToast(trans[lang].nameWait); return; }
    const newName = prompt("Enter new name:");
    if (newName) {
        auth.currentUser.updateProfile({ displayName: newName }).then(() => {
            document.getElementById('menu-user-name').innerText = newName;
            localStorage.setItem('rga_name_date', Date.now());
            syncWithDB({name: newName});
        });
    }
  }

  function handleAuth() {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    if(authMode === 'signup') {
        const fn = document.getElementById('auth-fname').value; const ln = document.getElementById('auth-lname').value;
        const fullName = fn + " " + ln;
        auth.createUserWithEmailAndPassword(email, pass).then(u => {
            u.user.updateProfile({ displayName: fullName, photoURL: DEFAULT_AVATAR });
            const generatedId = Math.random().toString(36).substr(2, 6).toUpperCase();
            db.collection("ranks").doc(u.user.uid).set({ name: fullName, xp: 0, avatar: DEFAULT_AVATAR, streak: 0, bestCombo: 0, shortId: generatedId, workoutDays: [] });
            u.user.sendEmailVerification(); 
            showToast(trans[lang].verifyMsg, 5000); 
            auth.signOut();
        }).catch(e => showToast(e.message));
    } else { auth.signInWithEmailAndPassword(email, pass).catch(e => showToast(e.message)); }
  }

  function forgotPassword() {
    const emailInput = document.getElementById('auth-email').value;
    const email = prompt(trans[lang].forgotPrompt, emailInput);
    if(email) auth.sendPasswordResetEmail(email).then(() => showToast(trans[lang].forgotSuccess)).catch(e => showToast(e.message));
  }

  function logout() {
    if(rankUnsubscribe) rankUnsubscribe();
    if(notifUnsubscribe) notifUnsubscribe();
    if(chatUnsubscribe) chatUnsubscribe();
    auth.signOut().then(() => {
        localStorage.clear();
        location.reload();
    });
  }
  
  function doMission(el, points) {
      if(el.classList.contains('done')) return;
      el.classList.add('done');
      syncWithDB({xp: firebase.firestore.FieldValue.increment(points)});
      showToast(`+${points} XP âœ¨`);
      const completed = JSON.parse(localStorage.getItem('rga_completed_missions') || '{}');
      completed[el.id] = true;
      localStorage.setItem('rga_completed_missions', JSON.stringify(completed));
  }

  function syncWithDB(dataToUpdate) {
    const user = auth.currentUser;
    if(user && dataToUpdate) {
        db.collection("ranks").doc(user.uid).update(dataToUpdate).catch((e) => console.error("Sync error:", e));
    }
  }

  function updateRankDisplay() {
    const level = Math.floor(xp / 100) + 1;
    const rankIdx = Math.min(Math.floor((level-1)/2), 4);
    const rLabel = (lang === 'ar' ? "Ø§Ù„Ø±ØªØ¨Ø©: " : "RANK: ");
    document.getElementById('rank-display').innerText = rLabel + trans[lang].ranks[rankIdx] + " (LVL " + level + ")";
    document.getElementById('xp-fill').style.width = (xp % 100) + "%";
    document.getElementById('shop-xp-val').innerText = xp;
  }

  function openLeaderboard() {
    document.getElementById('lb-modal').style.display = 'flex';
    const listDiv = document.getElementById('lb-list');
    listDiv.innerHTML = "Loading...";
    db.collection("ranks").orderBy("streak", "desc").limit(100).get().then(snap => {
        listDiv.innerHTML = "";
        let i = 1;
        snap.forEach(doc => {
            const data = doc.data();
            listDiv.innerHTML += `<div class="lb-row"><div class="lb-user"><span style="width:20px;">#${i}</span><img src="${data.avatar || DEFAULT_AVATAR}" class="lb-pic"><span>${data.name}</span></div><span style="color:#ff5722;">ğŸ”¥ ${data.streak || 0}</span></div>`;
            i++;
        });
    });
  }

  function closeLeaderboard() { document.getElementById('lb-modal').style.display = 'none'; }

  function processAll() {
    const w = parseFloat(document.getElementById('weight').value);
    const h = parseFloat(document.getElementById('height').value);
    const a = parseFloat(document.getElementById('age').value);
    const g = document.getElementById('gender').value;
    const act = parseFloat(document.getElementById('activity').value);
    if(!w || !h || !a) return;
    
    // This function call is incorrect now, logic is handled in onAuthStateChanged
    // checkStreak(); 

    const bmi = (w / ((h/100)**2)).toFixed(1);
    document.getElementById('val-bmi').innerText = bmi;
    document.getElementById('status-bmi').innerText = trans[lang].status[bmi < 18.5 ? 0 : bmi < 25 ? 1 : bmi < 30 ? 2 : 3];
    let ideal = g === 'male' ? 50 + 2.3 * ((h/2.54) - 60) : 45.5 + 2.3 * ((h/2.54) - 60);
    document.getElementById('val-ideal').innerText = Math.round(ideal);
    document.getElementById('val-water').innerText = (w * 0.033).toFixed(1);
    let bmr = (10*w) + (6.25*h) - (5*a) + (g === 'male' ? 5 : -161);
    let maint = Math.round(bmr * act);
    document.getElementById('res-maintain').innerText = maint + " " + trans[lang].calText;
    document.getElementById('res-lose').innerText = (maint - 500) + " " + trans[lang].calText;
    document.getElementById('res-gain').innerText = (maint + 500) + " " + trans[lang].calText;
    document.getElementById('resultsArea').classList.remove('hidden');
  }

  function renderWater() {
    let waterCups = localStorage.getItem('rga_water_count') || 0;
    let html = ""; for(let i=1; i<=8; i++) html += (i <= waterCups ? "ğŸŸ¦" : "â¬œ");
    document.getElementById('water-tracker').innerHTML = html;
  }

  document.getElementById('water-tracker').onclick = function() {
    let waterCups = parseInt(localStorage.getItem('rga_water_count') || 0);
    waterCups = waterCups >= 8 ? 0 : waterCups + 1;
    localStorage.setItem('rga_water_count', waterCups); renderWater();
  };

  function shareStreak() { navigator.clipboard.writeText(`Day ${streak} on RGALAB! ğŸ”¥`).then(() => showToast(trans[lang].copied)); }
  function shareResults() { navigator.clipboard.writeText(`Calories: ${document.getElementById('res-maintain').innerText}`).then(() => showToast(trans[lang].copied)); }

  function openShop() {
    document.getElementById('shop-modal').style.display = 'flex';
    updateShopButtons();
  }
  function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }

  function updateShopButtons() {
    const t = trans[lang];
    ['neon', 'gold'].forEach(id => {
        const btn = document.getElementById('btn-'+id);
        if(ownedItems.includes(id)) {
            const isActive = document.body.classList.contains('skin-'+id);
            btn.innerText = isActive ? t.off : t.on; btn.className = isActive ? "active" : "";
        } else {
            btn.innerText = t.unlock; btn.disabled = xp < (id === 'neon' ? 1000 : 2000);
        }
    });
    document.getElementById('btn-diet').innerText = t.get; document.getElementById('btn-diet').disabled = xp < 3000;
    document.getElementById('btn-pdf').innerText = t.get; document.getElementById('btn-pdf').disabled = xp < 500;
  }

  function buyItem(item, cost) {
    if(ownedItems.includes(item)) {
        if(item === 'neon' || item === 'gold') { document.body.classList.toggle('skin-'+item); updateShopButtons(); }
        return;
    }
    if(xp >= cost) {
        if(item === 'neon' || item === 'gold') { ownedItems.push(item); localStorage.setItem('rga_owned', JSON.stringify(ownedItems)); document.body.classList.add('skin-'+item); }
        syncWithDB({xp: firebase.firestore.FieldValue.increment(-cost)});
        showToast(trans[lang].bought);
        updateShopButtons();
    }
  }

    // âœ… =========================================================
    // âœ… REFINED: Smart Missions & Modern Modals
    // âœ… =========================================================
    function renderTodaysMissions() {
        const missionArea = document.getElementById('dynamic-mission-area');
        missionArea.innerHTML = '';
        const today = new Date().getDay();
        const isWorkoutDay = workoutDays.includes(today);
        const t = trans[lang];
        let missionHTML = '';
        if (isWorkoutDay) {
            missionHTML = `<div class="mission-item" id="mission-workout" onclick="openMuscleGroupModal()"><span>${t.m1}</span><b>+50 XP</b></div>`;
        } else {
            missionHTML = `<div class="mission-item" id="mission-rest" onclick="doMission(this, 10)"><span>${t.m3}</span><b>+10 XP</b></div>`;
        }
        missionArea.innerHTML = missionHTML;
        const completed = JSON.parse(localStorage.getItem('rga_completed_missions') || '{}');
        Object.keys(completed).forEach(missionId => {
            const el = document.getElementById(missionId);
            if (el) el.classList.add('done');
        });
    }

    function openWorkoutDaysModal() {
        const selector = document.getElementById('day-selector-cal');
        selector.innerHTML = '';
        const dayNames = trans[lang].daysShort;
        dayNames.forEach((name, index) => {
            const isSelected = workoutDays.includes(index) ? 'selected' : '';
            selector.innerHTML += `<div class="day-btn ${isSelected}" data-day="${index}" onclick="this.classList.toggle('selected')">${name}</div>`;
        });
        document.getElementById('days-modal').style.display = 'flex';
    }

    function saveWorkoutDays() {
        const selectedDays = [];
        document.querySelectorAll('#day-selector-cal .day-btn.selected').forEach(btn => {
            selectedDays.push(parseInt(btn.dataset.day));
        });
        if (selectedDays.length > 0) {
            workoutDays = selectedDays;
            syncWithDB({ workoutDays: selectedDays });
            document.getElementById('days-modal').style.display = 'none';
            renderTodaysMissions();
        } else {
            showToast(lang === 'ar' ? 'Ø§Ø®ØªØ± ÙŠÙˆÙ… ØªÙ…Ø±ÙŠÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.' : 'Select at least one workout day.');
        }
    }

    function openMuscleGroupModal() {
        const missionEl = document.getElementById('mission-workout');
        // if (missionEl && missionEl.classList.contains('done')) return; // <<-- ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
        const selector = document.getElementById('muscle-group-selector');
        selector.innerHTML = '';
        const muscleGroups = trans[lang].muscleGroups;
        for (const key in muscleGroups) {
            selector.innerHTML += `<div class="muscle-btn" onclick="selectMuscleGroup('${key}')">${muscleGroups[key]}</div>`;
        }
        document.getElementById('muscle-group-modal').style.display = 'flex';
    }

    function selectMuscleGroup(groupKey) {
        currentMuscleGroup = groupKey;
        document.getElementById('muscle-group-modal').style.display = 'none';
        openWorkoutLogger();
    }

    function openWorkoutLogger() {
        tempLoggedExercises = [];
        document.getElementById('logged-exercises-list').innerHTML = '';
        const titleEl = document.getElementById('wl-title');
        const t = trans[lang];
        titleEl.innerText = `${t.wlTitle} ${t.muscleGroups[currentMuscleGroup]}`;
        document.getElementById('logger-modal').style.display = 'flex';
        document.getElementById('log-exercise').value = '';
        document.getElementById('performance-history-icon').style.display = 'none';
    }

    function closeWorkoutLogger() {
        document.getElementById('logger-modal').style.display = 'none';
    }

    function addExerciseToLog() {
        const exInput = document.getElementById('log-exercise');
        const wtInput = document.getElementById('log-weight');
        const rpInput = document.getElementById('log-reps');
        const exercise = { name: exInput.value.trim(), weight: wtInput.value || 0, reps: rpInput.value || 0 };
        if (!exercise.name) {
            showToast(lang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠÙ†.' : 'Enter an exercise name.');
            return;
        }
        tempLoggedExercises.push(exercise);
        const list = document.getElementById('logged-exercises-list');
        list.innerHTML += `<div class="exercise-item"><span>${exercise.name}</span> <span>${exercise.weight} ${trans[lang].kg} x ${exercise.reps}</span></div>`;
        list.scrollTop = list.scrollHeight;
        exInput.value = ''; wtInput.value = ''; rpInput.value = '';
        exInput.focus();
        document.getElementById('performance-history-icon').style.display = 'none';
    }

    async function saveLoggedWorkout() {
        if (tempLoggedExercises.length === 0) {
            showToast(lang === 'ar' ? 'Ø£Ø¶Ù ØªÙ…Ø±ÙŠÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.' : 'Add at least one exercise.');
            return;
        }
        const user = auth.currentUser;
        if (!user) return;
        
        const workoutData = {
            muscleGroup: currentMuscleGroup,
            date: new Date().toISOString(),
            exercises: tempLoggedExercises
        };
        await db.collection("users").doc(user.uid).collection("workouts").add(workoutData);
        doMission(document.getElementById('mission-workout'), 50);
        closeWorkoutLogger();
        showToast(trans[lang].workoutSaved + ' (+50 XP âœ¨)');
    }

    async function checkExerciseHistory(exerciseName) {
        const icon = document.getElementById('performance-history-icon');
        const user = auth.currentUser;
        if (!user || exerciseName.length < 3) {
            icon.style.display = 'none';
            return;
        }
        const lowerCaseName = exerciseName.trim().toLowerCase();
        const workoutsRef = db.collection("users").doc(user.uid).collection("workouts");
        const querySnapshot = await workoutsRef.get();
        let historyExists = false;
        querySnapshot.forEach(doc => {
            doc.data().exercises.forEach(ex => {
                if (ex.name.toLowerCase() === lowerCaseName) {
                    historyExists = true;
                }
            });
        });
        icon.style.display = historyExists ? 'block' : 'none';
    }

    async function showPerformanceTracker(exerciseNameOverride) {
        const user = auth.currentUser;
        const exerciseName = exerciseNameOverride || document.getElementById('log-exercise').value.trim();
        if (!user || !exerciseName) return;
        document.getElementById('performance-hub-modal').style.display = 'none';
        const modal = document.getElementById('performance-tracker-modal');
        modal.style.display = 'flex';
        document.getElementById('pt-title').innerText = `${trans[lang].ptTitle}: ${exerciseName}`;
        const historyList = document.getElementById('pt-history-list');
        const prDisplay = document.getElementById('pt-pr-display');
        historyList.innerHTML = 'Loading...';
        prDisplay.innerHTML = '';
        const workoutsRef = db.collection("users").doc(user.uid).collection("workouts").orderBy("date", "desc");
        const querySnapshot = await workoutsRef.get();
        const historyData = [];
        let personalRecord = { weight: 0, reps: 0, date: '' };
        querySnapshot.forEach(doc => {
            const workout = doc.data();
            workout.exercises.forEach(ex => {
                if (ex.name.toLowerCase() === exerciseName.toLowerCase()) {
                    const weight = parseFloat(ex.weight) || 0;
                    const reps = parseFloat(ex.reps) || 0;
                    const recordDate = new Date(workout.date);
                    historyData.push({ date: recordDate, weight: weight, reps: reps });
                    if (weight > personalRecord.weight) {
                        personalRecord = { weight: weight, reps: reps, date: recordDate.toLocaleDateString() };
                    }
                }
            });
        });
        if (historyData.length === 0) {
            historyList.innerHTML = 'No history found.';
            prDisplay.innerHTML = '';
            return;
        }
        if (personalRecord.weight > 0) {
            prDisplay.innerHTML = `
                <div class="pr-card">
                    <div class="pr-trophy">ğŸ† ${trans[lang].ptPR}</div>
                    <div class="pr-main-value">
                        <span>${personalRecord.weight}</span>
                        <span class="pr-unit">${trans[lang].kg}</span>
                    </div>
                    <div class="pr-details">
                        <span>ğŸ‹ï¸â€â™‚ï¸ ${personalRecord.reps} Reps</span>
                        <span>ğŸ“… ${personalRecord.date}</span>
                    </div>
                </div>
            `;
        } else {
            prDisplay.innerHTML = '';
        }
        historyList.innerHTML = '';
        historyData.slice(0, 5).forEach(item => {
            historyList.innerHTML += `
                <div class="history-item modern">
                    <span>${item.date.toLocaleDateString()}</span>
                    <span>${item.weight} ${trans[lang].kg} x ${item.reps}</span>
                </div>
            `;
        });
        const chartData = historyData.slice().reverse();
        const labels = chartData.map(d => d.date.toLocaleDateString());
        const weights = chartData.map(d => d.weight);
        const ctx = document.getElementById('performance-chart').getContext('2d');
        if (performanceChart) performanceChart.destroy();
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Weight (${trans[lang].kg})`,
                    data: weights,
                    borderColor: 'rgba(76, 175, 80, 1)',
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

  function toggleNotifs() {
      const drop = document.getElementById('notif-dropdown');
      const badge = document.getElementById('notif-badge');
      if(drop.style.display === 'flex') {
          drop.style.display = 'none';
      } else {
          drop.style.display = 'flex';
          badge.style.display = 'none';
          badge.innerText = '0';
          markNotificationsRead();
      }
  }

  function markNotificationsRead() {
      const uid = auth.currentUser.uid;
      db.collection("users").doc(uid).collection("notifications").where("read", "==", false).get().then(snap => {
          const batch = db.batch();
          if (snap.empty) return;
          snap.forEach(doc => {
              batch.update(doc.ref, { read: true });
          });
          batch.commit().catch(e => console.error("Error marking notifications read: ", e));
      });
  }

  function copyMyId() { if(myShortId) { navigator.clipboard.writeText(myShortId).then(() => showToast(trans[lang].copied)); } }

  function sendFriendRequest(button) {
      const targetId = document.getElementById('friend-id-input').value.trim();
      if(!targetId) return;
      if(targetId === myShortId) { showToast(lang === 'ar' ? "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ!" : "You can't add yourself!"); return; }
      button.disabled = true;
      db.collection("ranks").where("shortId", "==", targetId).limit(1).get().then(snap => {
          if(snap.empty) {
              showToast("Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ­ÙŠØ­ User not found");
              button.disabled = false;
          } else {
              const targetDoc = snap.docs[0]; const targetUid = targetDoc.id;
              db.collection("users").doc(targetUid).collection("notifications").add({ type: 'friend_request', fromUid: auth.currentUser.uid, fromName: auth.currentUser.displayName, time: firebase.firestore.FieldValue.serverTimestamp(), read: false }).then(() => {
                  showToast(lang === 'ar' ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!" : "Request Sent!");
                  document.getElementById('friend-id-input').value = '';
                  setTimeout(() => { button.disabled = false; }, 2000);
              });
          }
      }).catch(() => {
          button.disabled = false;
      });
  }

  function listenToNotifications() {
      const uid = auth.currentUser.uid;
      if (notifUnsubscribe) notifUnsubscribe();
      notifUnsubscribe = db.collection("users").doc(uid).collection("notifications").orderBy("time", "desc").limit(20)
      .onSnapshot(snap => {
          const list = document.getElementById('notif-list'); list.innerHTML = "";
          let unread = 0;
          const t = trans[lang];
          if(snap.empty) {
              list.innerHTML = `<div style='padding:10px; opacity:0.6;'>${t.notifEmpty}</div>`;
          }
          snap.forEach(doc => {
              const n = doc.data();
              if (!n.read) unread++;
              const div = document.createElement('div'); div.className = 'notif-item';
              if(n.type === 'friend_request') {
                  div.innerHTML = `<div>ğŸ‘¤ ${t.notifFriendReq} <b>${n.fromName}</b></div>
                  <div class="notif-actions">
                      <button class="btn-accept" onclick="acceptFriend('${doc.id}', '${n.fromUid}', '${n.fromName}')">${t.notifAccept}</button>
                      <button class="btn-reject" onclick="deleteNotif('${doc.id}')">${t.notifReject}</button>
                  </div>`;
              } else if (n.type === 'xp_gift') {
                  div.innerHTML = `<div style="color:#4CAF50;">ğŸ ${t.notifGift} <b>${n.amount} XP</b> (${n.fromName})</div>`;
              } else if (n.type === 'msg') {
                  div.innerHTML = `<div>ğŸ’¬ ${t.notifMsg} <b>${n.fromName}</b>: ${n.text}</div>`;
              }
              list.appendChild(div);
          });
          const badge = document.getElementById('notif-badge');
          const drop = document.getElementById('notif-dropdown');
          if(unread > 0 && drop.style.display !== 'flex') {
              badge.style.display = 'block';
              badge.innerText = unread;
          } else if (unread === 0) {
              badge.style.display = 'none';
          }
      });
  }

  function acceptFriend(notifId, fromUid, fromName) {
      const myUid = auth.currentUser.uid; const myName = auth.currentUser.displayName;
      const batch = db.batch();
      const myFriendRef = db.collection("users").doc(myUid).collection("friends").doc(fromUid);
      batch.set(myFriendRef, { uid: fromUid, name: fromName });
      const otherFriendRef = db.collection("users").doc(fromUid).collection("friends").doc(myUid);
      batch.set(otherFriendRef, { uid: myUid, name: myName });
      const notifRef = db.collection("users").doc(myUid).collection("notifications").doc(notifId);
      batch.delete(notifRef);
      batch.commit().then(() => showToast(lang === 'ar' ? "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚!" : "Friend Added!"));
  }

  function deleteNotif(id) { db.collection("users").doc(auth.currentUser.uid).collection("notifications").doc(id).delete(); }

  function listenToFriends() {
      db.collection("users").doc(auth.currentUser.uid).collection("friends").onSnapshot(snap => {
          const div = document.getElementById('friend-list-container'); div.innerHTML = "";
          if(snap.empty) { div.innerHTML = `<small style='opacity:0.5'>${trans[lang].miNoFriends}</small>`; return; }
          snap.forEach(doc => {
              const f = doc.data();
              db.collection("ranks").doc(f.uid).get().then(uSnap => {
                 if(uSnap.exists) {
                     const uData = uSnap.data(); const el = document.createElement('div'); el.className = 'friend-list-item';
                     el.innerHTML = `<img src="${uData.avatar || DEFAULT_AVATAR}" class="f-avatar">
                                     <div><b>${uData.name}</b><br><span style="font-size:10px; color:#FFD700;">ğŸ”¥ ${uData.streak || 0}</span></div>`;
                     el.onclick = () => openFriendModal(f.uid, uData); div.appendChild(el);
                 }
              });
          });
      });
  }

  function openFriendModal(fUid, uData) {
      currentFriendId = fUid;
      document.getElementById('friend-modal').style.display = 'flex';
      document.getElementById('f-modal-name').innerText = uData.name;
      document.getElementById('f-modal-img').src = uData.avatar || DEFAULT_AVATAR;
      document.getElementById('f-modal-streak').innerText = uData.streak || 0;
      document.getElementById('f-chat-box').innerHTML = `<div style="text-align:center; opacity:0.5; margin: auto;">${trans[lang].fChatWait}</div>`;
      listenChat(fUid);
  }

  function removeFriend() {
      if(!currentFriendId) return;
      if(confirm(trans[lang].fRemoveConfirm)) {
          const myUid = auth.currentUser.uid;
          const batch = db.batch();
          batch.delete(db.collection("users").doc(myUid).collection("friends").doc(currentFriendId));
          batch.delete(db.collection("users").doc(currentFriendId).collection("friends").doc(myUid));
          batch.commit().then(() => {
              showToast(lang === 'ar' ? "ØªÙ… Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚" : "Friend Removed");
              document.getElementById('friend-modal').style.display = 'none';
          });
      }
  }

  async function sendXPToFriend(button) {
    if(!currentFriendId) return;
    const input = document.getElementById('xp-amount-input');
    const amount = parseInt(input.value);
    const t = trans[lang];
    if (!amount || amount <= 0) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­!");
        return;
    }
    if (xp < amount) {
        showToast(t.xpNo);
        return;
    }
    button.disabled = true;
    const myUid = auth.currentUser.uid;
    const myRankRef = db.collection("ranks").doc(myUid);
    const friendRankRef = db.collection("ranks").doc(currentFriendId);
    try {
        await db.runTransaction(async (transaction) => {
            const myRankDoc = await transaction.get(myRankRef);
            if (!myRankDoc.exists || myRankDoc.data().xp < amount) {
                throw new Error("Not enough XP");
            }
            transaction.update(myRankRef, { xp: firebase.firestore.FieldValue.increment(-amount) });
            transaction.update(friendRankRef, { xp: firebase.firestore.FieldValue.increment(amount) });
        });
        showToast(t.xpSent);
        input.value = "";
        db.collection("users").doc(currentFriendId).collection("notifications").add({
            type: 'xp_gift', amount: amount, fromName: auth.currentUser.displayName,
            time: firebase.firestore.FieldValue.serverTimestamp(), read: false
        });
    } catch (error) {
        console.error("XP Transaction failed: ", error);
        showToast(t.xpErr);
    } finally {
        button.disabled = false;
    }
  }

  function sendChatMessage() {
      const txt = document.getElementById('chat-input').value.trim();
      if(!txt || !currentFriendId) return;
      const myUid = auth.currentUser.uid;
      const chatId = myUid < currentFriendId ? myUid + "_" + currentFriendId : currentFriendId + "_" + myUid;
      db.collection("chats").doc(chatId).collection("messages").add({
          senderId: myUid,
          text: txt,
          time: firebase.firestore.FieldValue.serverTimestamp()
      });
      db.collection("users").doc(currentFriendId).collection("notifications").add({
          type: 'msg',
          text: txt,
          fromName: auth.currentUser.displayName,
          time: firebase.firestore.FieldValue.serverTimestamp(),
          read: false
      });
      document.getElementById('chat-input').value = "";
  }

  function listenChat(fUid) {
      if(chatUnsubscribe) chatUnsubscribe();
      const myUid = auth.currentUser.uid;
      const chatId = myUid < fUid ? myUid + "_" + fUid : fUid + "_" + myUid;
      const box = document.getElementById('f-chat-box');
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
      db.collection("chats").doc(chatId).collection("messages")
          .where("time", "<", oneDayAgo).get().then(snap => {
              const batch = db.batch();
              snap.forEach(doc => batch.delete(doc.ref));
              batch.commit();
          });
      chatUnsubscribe = db.collection("chats").doc(chatId).collection("messages")
          .orderBy("time", "asc")
          .onSnapshot(snap => {
              box.innerHTML = "";
              if(snap.empty) { box.innerHTML = `<div style="text-align:center; opacity:0.5; margin: auto;">${trans[lang].fChatWait}</div>`; }
              snap.forEach(doc => {
                  const m = doc.data();
                  const cls = m.senderId === myUid ? "me" : "them";
                  box.innerHTML += `<div class="chat-msg ${cls}">${m.text}</div>`;
              });
              box.scrollTop = box.scrollHeight;
          });
  }

    // âœ… NEW: Toast Notification Function
    let toastTimeout;
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast-notification');
        toast.innerText = message;
        toast.classList.add('show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }

  // âœ… NEW: Performance Hub Functions
 async function openPerformanceHub() {
    const modal = document.getElementById('performance-hub-modal');
    modal.style.display = 'flex';
    switchHubTab('overview');
    const user = auth.currentUser;
    if (!user) return;
    const noDataEl = document.getElementById('hub-no-data');
    const overviewContent = document.getElementById('hub-overview-content');
    const historyContent = document.getElementById('hub-history-content');
    overviewContent.classList.add('hidden');
    historyContent.classList.add('hidden');
    noDataEl.classList.remove('hidden');
    noDataEl.innerText = 'Loading...';
    const workoutsRef = db.collection("users").doc(user.uid).collection("workouts");
    const querySnapshot = await workoutsRef.get();
    if (querySnapshot.empty) {
        noDataEl.innerText = trans[lang].phNoData;
        return;
    }
    noDataEl.classList.add('hidden');
    overviewContent.classList.remove('hidden');
    const exercisesByGroup = {};
    let totalWorkouts = 0;
    let totalWeight = 0;
    const muscleCounts = {};
    querySnapshot.forEach(doc => {
        totalWorkouts++;
        const workout = doc.data();
        const groupKey = workout.muscleGroup;
        muscleCounts[groupKey] = (muscleCounts[groupKey] || 0) + 1;
        if (!exercisesByGroup[groupKey]) {
            exercisesByGroup[groupKey] = new Set();
        }
        workout.exercises.forEach(ex => {
            totalWeight += (parseFloat(ex.weight) || 0) * (parseFloat(ex.reps) || 0);
            exercisesByGroup[groupKey].add(ex.name);
        });
    });
    // (1) Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    document.getElementById('hub-total-workouts').innerText = totalWorkouts;
    document.getElementById('hub-total-weight').innerText = Math.round(totalWeight);
    const muscleLabels = Object.keys(muscleCounts).map(key => trans[lang].muscleGroups[key] || key);
    const muscleData = Object.values(muscleCounts);
    const ctx = document.getElementById('hub-muscle-chart').getContext('2d');
    if (hubMuscleChart) hubMuscleChart.destroy();
    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.6)');
    gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
    hubMuscleChart = new Chart(ctx, { type: 'line', data: { labels: muscleLabels, datasets: [{ label: 'Frequency', data: muscleData, fill: true, backgroundColor: gradient, borderColor: '#4CAF50', borderWidth: 3, tension: 0.4, pointBackgroundColor: 'white', pointBorderColor: '#4CAF50', pointRadius: 5, pointHoverRadius: 7 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'white' } }, x: { grid: { display: false }, ticks: { color: 'white' } } }, plugins: { legend: { display: false } } } });
    // (2) Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø°ÙƒÙŠØ©
    const exerciseListContainer = document.getElementById('hub-exercise-list');
    exerciseListContainer.innerHTML = '';
    for (const groupKey in exercisesByGroup) {
        const groupName = trans[lang].muscleGroups[groupKey] || groupKey;
        const groupWrapper = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'muscle-group-header';
        header.innerText = groupName;
        header.onclick = function() { toggleExerciseList(this); };
        
        const content = document.createElement('div');
        content.className = 'exercise-list-collapsible';
        const exercises = Array.from(exercisesByGroup[groupKey]).sort();
        exercises.forEach(exName => {
            const item = document.createElement('div');
            item.className = 'exercise-item-hub';
            item.innerText = exName;
            item.onclick = () => showPerformanceTracker(exName);
            content.appendChild(item);
        });
        groupWrapper.appendChild(header);
        groupWrapper.appendChild(content);
        exerciseListContainer.appendChild(groupWrapper);
    }
}
function toggleExerciseList(headerElement) {
    headerElement.classList.toggle('active');
    const content = headerElement.nextElementSibling;
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
    }
}

function switchHubTab(tabName) {
    document.getElementById('hub-overview-content').classList.toggle('hidden', tabName !== 'overview');
    document.getElementById('hub-history-content').classList.toggle('hidden', tabName !== 'history');
    document.getElementById('hub-tab-overview').classList.toggle('active', tabName === 'overview');
    document.getElementById('hub-tab-history').classList.toggle('active', tabName === 'history');
}

function filterHubExercises(searchTerm) {
    const lowerTerm = searchTerm.toLowerCase();
    document.querySelectorAll('#hub-exercise-list .exercise-item-hub').forEach(item => {
        const matches = item.innerText.toLowerCase().includes(lowerTerm);
        item.style.display = matches ? 'block' : 'none';
    });
}

  window.onload = function() {
    updateTexts(); renderWater();
    if (localStorage.getItem('rga_privacy_accepted') === 'true') {
        document.getElementById("privacyModal").style.display = "none";
    } else {
        document.getElementById("privacyModal").style.display = "flex";
    }
    auth.onAuthStateChanged(user => {
      if(user) {
          document.getElementById('auth-overlay').classList.add('hidden');
          document.getElementById('menuBtn').style.display = "flex";
          document.getElementById('ai-chat-btn').style.display = "flex";
          document.getElementById('notif-icon').style.display = "flex";
          
          if(rankUnsubscribe) rankUnsubscribe();
          rankUnsubscribe = db.collection("ranks").doc(user.uid).onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                
                const todayJordan = getJordanDateString(new Date());
                const lastActiveTimestamp = data.lastActiveDate;
                let lastActiveJordan = null;
                if (lastActiveTimestamp) {
                    lastActiveJordan = getJordanDateString(lastActiveTimestamp.toDate());
                }

                if (lastActiveJordan !== todayJordan) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayJordan = getJordanDateString(yesterday);
                    let newStreak;
                    if (lastActiveJordan === yesterdayJordan) {
                        newStreak = (data.streak || 0) + 1;
                        showToast(`ğŸ”¥ ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„ØªØ²Ø§Ù…Ùƒ Ø¥Ù„Ù‰ ${newStreak} Ø£ÙŠØ§Ù…!`);
                    } else {
                        newStreak = 1;
                        showToast("ğŸ”¥ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ²Ø§Ù… Ø¬Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…!");
                    }
                    db.collection("ranks").doc(user.uid).update({
                        streak: newStreak,
                        lastActiveDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return; 
                }

                xp = data.xp || 0;
                streak = data.streak || 0;
                userAvatarUrl = data.avatar || DEFAULT_AVATAR;
                globalBestCombo = data.bestCombo || 0;
                myShortId = data.shortId;
                workoutDays = data.workoutDays || [];
                if(!myShortId) {
                    myShortId = Math.random().toString(36).substr(2, 6).toUpperCase();
                    db.collection("ranks").doc(user.uid).update({ shortId: myShortId });
                }
                if (!workoutDays || workoutDays.length === 0) {
                    openWorkoutDaysModal();
                } else {
                    renderTodaysMissions();
                }
                document.getElementById('menu-user-id').innerText = "ID: " + myShortId;
                localStorage.setItem('rga_avatar', userAvatarUrl);
                document.getElementById('menu-user-avatar').src = userAvatarUrl;
                document.getElementById('menu-user-name').innerText = user.displayName || "User";
                document.getElementById('streak-num').innerText = streak;
                document.getElementById('best-combo-val').innerText = globalBestCombo;
                document.getElementById('myIdDisplay').innerText = myShortId;
                updateRankDisplay();
            }
        });
          
          listenToNotifications();
          listenToFriends();
      }
      else { document.getElementById('auth-overlay').classList.remove('hidden'); }
    });
  };

  function acceptPrivacy() { localStorage.setItem('rga_privacy_accepted', 'true'); document.getElementById("privacyModal").style.display = "none"; }
  function showPrivacy() { document.getElementById("privacyModal").style.display = "flex"; }
  function toggleTheme() { document.body.classList.toggle('dark-theme'); }

function getJordanDateString(date) {
    const dateToFormat = date || new Date();
    return new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Asia/Amman',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).format(dateToFormat);
}
</script>
</body>
</html>
